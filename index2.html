<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesyonel Ä°ÅŸ Takip Sistemi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Modern kaydÄ±rma Ã§ubuÄŸu */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Bildirim stili */
        #notification-center {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .notification-item {
            animation: fadeInOut 5s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(300px); }
            10% { opacity: 1; transform: translateX(0); }
            90% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(300px); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

    <!-- ðŸ”” Bildirim Merkezi -->
    <div id="notification-center" class="space-y-2"></div>

    <!-- 1. GiriÅŸ ve MÃ¼ÅŸteri Takip EkranÄ± (Ä°lk AÃ§Ä±lÄ±ÅŸ) -->
    <div id="login-container" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div id="auth-switcher" class="max-w-xl w-full space-y-8 p-10 bg-white shadow-2xl rounded-2xl border border-gray-100">
            
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                <i data-lucide="briefcase" class="inline-block w-8 h-8 mr-2 text-indigo-600"></i> Ä°ÅŸ Takip Sistemi
            </h2>
            
            <div id="mode-selection" class="flex justify-center space-x-4 border-b pb-4">
                <button id="show-staff-login" class="px-6 py-2 text-sm font-medium rounded-lg transition duration-200">
                    Personel GiriÅŸi
                </button>
                <button id="show-customer-tracker" class="px-6 py-2 text-sm font-medium rounded-lg transition duration-200">
                    SipariÅŸ Takip
                </button>
            </div>
            
            <!-- Personel GiriÅŸ ModÃ¼lÃ¼ (KullanÄ±cÄ± AdÄ±/Åžifre) -->
            <div id="staff-login-form" class="mt-8 space-y-6">
                <form id="email-password-form" class="space-y-4">
                    <!-- E-POSTA YERÄ°NE KULLANICI ADI/E-POSTA KULLANILACAK -->
                    <input type="text" id="login-identifier" placeholder="KullanÄ±cÄ± AdÄ± veya E-posta" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <input type="password" id="login-password" placeholder="Åžifre" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition space-x-3">
                        <i data-lucide="log-in" class="w-5 h-5"></i>
                        <span>Personel GiriÅŸi</span>
                    </button>
                </form>
                
                <!-- Google ile giriÅŸ butonu kaldÄ±rÄ±ldÄ± -->

                <p id="login-error" class="text-red-500 text-center text-sm hidden">Hata: GiriÅŸ yapÄ±lamadÄ± veya rolÃ¼nÃ¼z atanmadÄ±.</p>
            </div>

            <!-- MÃ¼ÅŸteri SipariÅŸ Takip ModÃ¼lÃ¼ -->
            <div id="customer-tracker-form" class="mt-8 space-y-6 hidden">
                <form id="customer-order-form" class="space-y-4">
                    <input type="text" id="order-code-input" placeholder="SipariÅŸ Kodunuzu Girin (Ã–rn: ORD-XXXXX)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 text-lg uppercase" required>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200 text-xl shadow-md">
                        <i data-lucide="search" class="inline-block w-5 h-5 mr-2"></i> Sorgula
                    </button>
                </form>
                <div id="customer-job-details" class="mt-8">
                    <!-- Sorgu sonucu buraya gelecek -->
                </div>
            </div>

        </div>
    </div>

    <!-- 2. Ana Uygulama Paneli (Personel GiriÅŸi SonrasÄ±) -->
    <div id="app-container" class="hidden min-h-screen flex">
        
        <!-- Sol MenÃ¼ (Navigasyon) -->
        <aside id="main-nav" class="w-64 bg-gray-900 text-white flex flex-col shadow-2xl">
            <div class="p-6 text-2xl font-bold text-indigo-400 border-b border-gray-800">
                Pro YÃ¶netim
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="#dashboard" data-route="dashboard" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#new-job" data-route="new-job" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Yeni Ä°ÅŸ Ekle</span>
                </a>
                <a href="#admin-panel" data-route="admin-panel" id="admin-link" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150 hidden">
                    <i data-lucide="wrench" class="w-5 h-5"></i>
                    <span>Admin Panel</span>
                </a>
                <a href="#announcements" data-route="announcements" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150">
                    <i data-lucide="megaphone" class="w-5 h-5"></i>
                    <span>Duyurular</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <p id="user-info" class="text-sm text-gray-400 truncate mb-2"></p>
                <button id="logout-button" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg transition duration-150 text-sm flex items-center justify-center space-x-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Ã‡Ä±kÄ±ÅŸ Yap</span>
                </button>
            </div>
        </aside>

        <!-- Ana Ä°Ã§erik AlanÄ± -->
        <main id="content-area" class="flex-grow p-8 overflow-y-auto">
            <!-- Dinamik olarak yÃ¼klenecek iÃ§erik -->
            <div class="h-full flex items-center justify-center text-gray-500">
                <i data-lucide="loader" class="animate-spin w-10 h-10"></i>
            </div>
        </main>
    </div>

    <!-- Firebase SDK'larÄ± -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signOut, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, limit, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // --- 1. SABÄ°T VERÄ°LER VE Ä°LK BAÅžLANGIÃ‡ ---

        // KULLANICININ SAÄžLADIÄžI FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
            authDomain: "kibrissiparissistemi.firebaseapp.com",
            databaseURL: "https://kibrissiparissistemi-default-rtdb.firebaseio.com",
            projectId: "kibrissiparissistemi",
            storageBucket: "kibrissiparissistemi.firebasestorage.app",
            messagingSenderId: "263531733235",
            appId: "1:263531733235:web:82efdf39ed758a22465786",
            measurementId: "G-JK5S6L90Q5"
        };
        // Uygulama ID'si ve Firebase config global olarak tanÄ±mlÄ± varsayÄ±lÄ±r.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        // GoogleProvider kaldÄ±rÄ±ldÄ±
        
        // Globals
        let currentUserRole = null;
        let jobSnapshots = [];
        let globalJobData = [];

        // UI Element References
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const contentArea = document.getElementById('content-area');
        const adminLink = document.getElementById('admin-link');
        const userInfoP = document.getElementById('user-info');
        const notificationCenter = document.getElementById('notification-center');
        const customerJobDetails = document.getElementById('customer-job-details');
        const loginErrorElement = document.getElementById('login-error');
        const emailPasswordForm = document.getElementById('email-password-form');
        
        // --- 2. YARDIMCI FONKSÄ°YONLAR ---

        /**
         * Firebase Firestore'da kullanÄ±cÄ± adÄ± haritalama koleksiyonunun yolu.
         */
        const getUsernamesCollectionRef = () => {
            // Public alanda (tÃ¼m kullanÄ±cÄ±lar tarafÄ±ndan eriÅŸilebilir) saklanmalÄ±dÄ±r, ancak burada sadece yetkili giriÅŸ yapabildiÄŸi iÃ§in ana koleksiyon yeterli.
            return collection(db, 'usernames');
        };

        /**
         * Real-time Bildirim gÃ¶sterir. (KÄ±saltÄ±ldÄ±)
         */
        function showNotification(title, message, icon, color) {
            const id = Date.now();
            const notifDiv = document.createElement('div');
            // ... bildirim oluÅŸturma ve ekleme (Ã¶nceki koddan)
            notifDiv.id = `notif-${id}`;
            notifDiv.className = `notification-item p-4 bg-white border-l-4 border-${color}-500 rounded-lg shadow-xl mb-3 w-80 flex items-start space-x-3`;
            notifDiv.innerHTML = `
                <i data-lucide="${icon}" class="w-6 h-6 text-${color}-500"></i>
                <div>
                    <h4 class="text-sm font-semibold text-gray-900">${title}</h4>
                    <p class="text-xs text-gray-600 mt-1">${message}</p>
                </div>
            `;
            notificationCenter.appendChild(notifDiv);
            
            lucide.createIcons();

            setTimeout(() => {
                const element = document.getElementById(`notif-${id}`);
                if (element) {
                    element.remove();
                }
            }, 5000);
        }

        // Router Fonksiyonu (KÄ±saltÄ±ldÄ±)
        const router = {
            routes: {},
            navigate: async function (path) {
                const route = path.replace('#', '') || 'dashboard';
                const linkElements = document.querySelectorAll('.nav-link');
                linkElements.forEach(link => {
                    link.classList.remove('bg-indigo-700', 'font-bold');
                    if (link.dataset.route === route) {
                        link.classList.add('bg-indigo-700', 'font-bold');
                    }
                });

                if (this.routes[route]) {
                    contentArea.innerHTML = this.routes[route].template;
                    lucide.createIcons();
                    if (this.routes[route].handler) {
                        await this.routes[route].handler();
                    }
                } else {
                    contentArea.innerHTML = `<h1 class="text-3xl font-bold text-gray-700">404 - Sayfa BulunamadÄ±</h1>`;
                }
            },
            add: function (path, template, handler) {
                this.routes[path] = { template, handler };
            }
        };

        // Durum renkleri iÃ§in yardÄ±mcÄ± nesne (KÄ±saltÄ±ldÄ±)
        const statusColorsMap = {
            'Yeni SipariÅŸ': 'bg-blue-500',
            'Ãœretim AÅŸamasÄ±nda': 'bg-yellow-500',
            'Kalite Kontrol': 'bg-purple-500',
            'Teslim Edildi': 'bg-green-500',
            'Ä°ptal Edildi': 'bg-red-500',
        };

        // --- 3. RENDER FONKSÄ°YONLARI --- (KÄ±saltÄ±ldÄ±)

        // Ä°ÅŸ KartÄ± Render Fonksiyonu (KÄ±saltÄ±ldÄ±)
        const renderJobCard = (job, docId) => {
            const isMaster = currentUserRole === 'Admin' || currentUserRole === 'Master';
            const statusColor = statusColorsMap[job.status] || 'bg-gray-500';
            const createdAt = job.createdAt ? new Date(job.createdAt.toDate()).toLocaleDateString('tr-TR') : 'Bilinmiyor';
            
            return `
                <div id="job-${docId}" class="bg-white p-6 rounded-xl shadow-lg border-l-4 ${statusColor} transform hover:scale-[1.01] transition duration-150">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-extrabold text-gray-800">${job.jobTitle}</h3>
                        <span class="px-3 py-1 text-xs font-semibold text-white rounded-full ${statusColor}">${job.status}</span>
                    </div>
                    <p class="text-xs font-mono text-gray-500 mb-2">Kod: ${job.orderCode}</p>
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">${job.description}</p>
                    <p class="text-xs text-gray-500">OluÅŸturulma: ${createdAt}</p>
                    
                    <div class="mt-4 flex space-x-2">
                        <button data-doc-id="${docId}" data-action="view" class="job-action-button text-indigo-600 hover:text-indigo-800 transition text-sm font-medium flex items-center">
                            <i data-lucide="eye" class="w-4 h-4 mr-1"></i> Detay
                        </button>
                        ${isMaster ? `
                        <button data-doc-id="${docId}" data-action="edit" class="job-action-button text-blue-600 hover:text-blue-800 transition text-sm font-medium flex items-center">
                            <i data-lucide="edit" class="w-4 h-4 mr-1"></i> DÃ¼zenle
                        </button>
                        <button data-doc-id="${docId}" data-action="delete" class="job-action-button text-red-600 hover:text-red-800 transition text-sm font-medium flex items-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> Sil
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        };


        // --- 4. AUTH VE ROL YÃ–NETÄ°MÄ° ---

        /**
         * Rolleri Firebase'den Ã§eker ve UI'Ä± gÃ¼nceller.
         */
        const fetchUserRole = async (uid) => {
            const roleDocRef = doc(db, 'userRoles', uid);
            const docSnap = await getDoc(roleDocRef);
            return docSnap.exists() ? docSnap.data().role : null;
        };
        
        /**
         * E-posta veya KullanÄ±cÄ± AdÄ± ile GiriÅŸ Ä°ÅŸlemi
         */
        const handleEmailPasswordLogin = async (e) => {
            e.preventDefault();
            loginErrorElement.classList.add('hidden');
            const identifier = document.getElementById('login-identifier').value.trim();
            const password = document.getElementById('login-password').value;

            // 1. Girdinin E-posta mÄ± yoksa KullanÄ±cÄ± AdÄ± mÄ± olduÄŸunu belirle
            let loginEmail = identifier;
            const isEmail = identifier.includes('@');
            
            try {
                if (!isEmail) {
                    // 2. EÄŸer E-posta deÄŸilse (KullanÄ±cÄ± AdÄ± varsayÄ±lÄ±r), Firestore'dan E-posta'yÄ± bul
                    const usernameSlug = identifier.toLowerCase().replace(/\s/g, ''); // BoÅŸluklarÄ± kaldÄ±r ve kÃ¼Ã§Ã¼k harfe Ã§evir
                    const usernameDocRef = doc(getUsernamesCollectionRef(), usernameSlug);
                    const docSnap = await getDoc(usernameDocRef);

                    if (docSnap.exists()) {
                        loginEmail = docSnap.data().email;
                    } else {
                        // KullanÄ±cÄ± adÄ± bulunamadÄ±
                        throw { code: 'auth/user-not-found', message: 'Girilen kullanÄ±cÄ± adÄ± sistemde kayÄ±tlÄ± deÄŸil.' };
                    }
                }
                
                // 3. Bulunan E-posta ve Åžifre ile Firebase Auth'u dene
                await signInWithEmailAndPassword(auth, loginEmail, password);
                
                // BaÅŸarÄ±lÄ± giriÅŸten sonra onAuthStateChanged listener'Ä± geri kalanÄ±nÄ± halleder.
            } catch (error) {
                console.error("GiriÅŸ HatasÄ±:", error);
                
                let errorMessage = 'GiriÅŸ BaÅŸarÄ±sÄ±z: Bilinmeyen bir hata oluÅŸtu.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'HatalÄ± kullanÄ±cÄ± adÄ±/e-posta veya ÅŸifre.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'GeÃ§ersiz e-posta formatÄ± (Admin tarafÄ±ndan yanlÄ±ÅŸ girilmiÅŸ olabilir).';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Ã‡ok fazla deneme yapÄ±ldÄ±. LÃ¼tfen daha sonra tekrar deneyin.';
                        break;
                    default:
                        // EÄŸer Ã¶zel mesaj varsa onu kullan
                        errorMessage = error.message.includes('Girilen kullanÄ±cÄ± adÄ±') ? error.message : `GiriÅŸ BaÅŸarÄ±sÄ±z: ${error.message}`;
                        break;
                }

                loginErrorElement.textContent = errorMessage;
                loginErrorElement.classList.remove('hidden');
            }
        };


        /**
         * Google Ä°le GiriÅŸ Ä°ÅŸlemi kaldÄ±rÄ±ldÄ±.
         */

        /**
         * Auth durumuna gÃ¶re UI'Ä± gÃ¼nceller. (KÄ±saltÄ±ldÄ±)
         */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserRole = await fetchUserRole(user.uid);
                
                // Rol kontrolÃ¼
                if (!currentUserRole || currentUserRole === 'none' || currentUserRole === 'MÃ¼ÅŸteri') {
                    if (user.email && !currentUserRole) {
                        const userRef = doc(db, 'userRoles', user.uid);
                        // EÄŸer bir rol atanmamÄ±ÅŸsa 'none' olarak kaydet
                        await setDoc(userRef, { email: user.email, role: 'none' }, { merge: true });
                        currentUserRole = 'none';
                    }

                    loginErrorElement.textContent = `HesabÄ±nÄ±za henÃ¼z bir personel rolÃ¼ atanmamÄ±ÅŸ (${user.email}). LÃ¼tfen yÃ¶neticinizle iletiÅŸime geÃ§in.`;
                    loginErrorElement.classList.remove('hidden');
                    
                    await signOut(auth);
                    return; 
                }

                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userInfoP.innerHTML = `HoÅŸ Geldiniz, <span class="font-bold text-white">${currentUserRole} (${user.email.split('@')[0]})</span>`;
                
                if (currentUserRole === 'Admin') {
                    adminLink.classList.remove('hidden');
                } else {
                    adminLink.classList.add('hidden');
                }
                
                // Firestore dinleyicilerini baÅŸlat
                setupRealTimeJobListener();
                router.navigate(window.location.hash);

            } else {
                appContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                router.navigate('');
                currentUserRole = null;
                switchAuthMode('staff');
            }
            lucide.createIcons();
        });


        // Ä°ÅŸ Listesi ve MÃ¼ÅŸteri Takip fonksiyonlarÄ± (Ã–nceki koddan)
        const setupRealTimeJobListener = () => { /* ... */ };
        const handleJobFormSubmit = async (e) => { /* ... */ };
        const handleDeleteJob = async (docId) => { /* ... */ };
        const handleCustomerTracking = async (e) => { /* ... */ };
        const attachDashboardHandlers = () => { /* ... */ };
        const handleJobAction = (e) => { /* ... */ };
        const handleDashboard = () => { /* ... */ };
        const handleNewJob = () => { /* ... */ };
        const handleRoleChange = async (e) => { /* ... */ };
        const handleAnnouncementSubmit = async (e) => { /* ... */ };
        const handleAnnouncements = async () => { /* ... */ };
        
        /**
         * Yeni Personel HesabÄ± OluÅŸturma Ä°ÅŸleyici (KullanÄ±cÄ± AdÄ± Zorunlu)
         */
        const handleNewUserCreation = async (e) => {
            e.preventDefault();
            const form = e.target;
            const username = form.newUsername.value.trim(); 
            const email = form.newUserEmail.value.trim();
            const password = form.newUserPassword.value;
            const role = form.newUserRole.value;
            
            const usernameSlug = username.toLowerCase().replace(/\s/g, ''); 

            try {
                // 1. KullanÄ±cÄ± adÄ±nÄ±n benzersizliÄŸini kontrol et
                const existingUsernameDoc = await getDoc(doc(getUsernamesCollectionRef(), usernameSlug));
                if (existingUsernameDoc.exists()) {
                     throw { code: 'custom/username-taken', message: 'Bu kullanÄ±cÄ± adÄ± zaten sistemde kayÄ±tlÄ±.' };
                }

                // 2. Firebase Auth'ta kullanÄ±cÄ± oluÅŸtur (Email zorunlu)
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                
                // 3. Firestore'da rol atamasÄ± yap
                await setDoc(doc(db, 'userRoles', uid), { 
                    email: email,
                    role: role,
                    username: username 
                });
                
                // 4. Firestore'da KullanÄ±cÄ± AdÄ± HaritasÄ±nÄ± oluÅŸtur (GiriÅŸ iÃ§in gerekli)
                await setDoc(doc(getUsernamesCollectionRef(), usernameSlug), {
                    email: email,
                    uid: uid,
                    displayName: username 
                });


                showNotification('ðŸ‘¤ Hesap OluÅŸturuldu', `${username} kullanÄ±cÄ±sÄ± (${email}) baÅŸarÄ±yla kaydedildi.`, 'user-check', 'green');
                form.reset();
                await handleAdminPanel(); 

            } catch (error) {
                console.error("KullanÄ±cÄ± oluÅŸturma hatasÄ±:", error);
                let errorMessage = `Hesap oluÅŸturma hatasÄ±: ${error.message}`;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Bu E-posta adresi zaten kullanÄ±mda.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Åžifre en az 6 karakter olmalÄ±dÄ±r.';
                } else if (error.code === 'custom/username-taken') {
                    errorMessage = error.message;
                }

                showNotification('ðŸš¨ Hata', errorMessage, 'x-octagon', 'red');
            }
        };


        /**
         * Admin Panel Handler (YENÄ° KullanÄ±cÄ± AdÄ± ile oluÅŸturma)
         */
        const handleAdminPanel = async () => {
            if (currentUserRole !== 'Admin') {
                contentArea.innerHTML = `<div class="text-center p-10 bg-red-100 text-red-700 rounded-xl">Yetkisiz EriÅŸim!</div>`;
                return;
            }
            
            // Duyuru formu dinleyicisi
            document.getElementById('announcement-form').removeEventListener('submit', handleAnnouncementSubmit);
            document.getElementById('announcement-form').addEventListener('submit', handleAnnouncementSubmit);
            
            // Yeni KullanÄ±cÄ± OluÅŸturma formu dinleyicisi
            document.getElementById('new-user-form').removeEventListener('submit', handleNewUserCreation);
            document.getElementById('new-user-form').addEventListener('submit', handleNewUserCreation);


            // KullanÄ±cÄ± ve Rol YÃ¶netimi
            const usersRef = collection(db, 'userRoles');
            const userList = document.getElementById('user-role-list');
            userList.innerHTML = '<p class="text-center text-gray-500">KullanÄ±cÄ±lar yÃ¼kleniyor...</p>';
            
            const q = query(usersRef);
            const snapshot = await getDocs(q);
            let userHtml = '';

            snapshot.forEach(doc => {
                const data = doc.data();
                const uid = doc.id;
                // KullanÄ±cÄ± AdÄ± bilgisini gÃ¶ster (varsa)
                const displayInfo = data.username ? `${data.username} (${data.email})` : data.email; 

                userHtml += `
                    <li class="p-4 bg-gray-50 rounded-lg flex justify-between items-center shadow-sm">
                        <span class="font-medium text-gray-800">${displayInfo || 'Bilinmiyor'}</span>
                        <select data-uid="${uid}" class="role-selector p-2 border rounded-md bg-white">
                            <option value="Admin" ${data.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Master" ${data.role === 'Master' ? 'selected' : ''}>Master</option>
                            <option value="Worker" ${data.role === 'Worker' ? 'selected' : ''}>Worker</option>
                            <option value="none" ${data.role === 'none' || !data.role ? 'selected' : ''}>Rol Yok</option>
                        </select>
                    </li>
                `;
            });
            userList.innerHTML = userHtml || '<p class="text-center text-gray-500">KayÄ±tlÄ± personel adayÄ± yok.</p>';

            // Rol deÄŸiÅŸtirme dinleyicileri
            document.querySelectorAll('.role-selector').forEach(select => {
                select.removeEventListener('change', handleRoleChange);
                select.addEventListener('change', handleRoleChange);
            });
        };


        // --- 8. UYGULAMA Ä°LK BAÅžLANGIÃ‡ VE DÄ°NLEYÄ°CÄ°LER ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Ä°konlarÄ± ilk baÅŸta yÃ¼kle
            lucide.createIcons();

            // Router'a rotalarÄ± ekle (Dashboard, New Job ve Announcements ÅŸablonlarÄ± kÄ±saltÄ±ldÄ±)
            router.add('dashboard', `
                <h1 class="text-4xl font-extrabold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="layout-dashboard" class="w-8 h-8 mr-3"></i> Ä°ÅŸ Dashboard</h1>
                <div id="dashboard-job-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Ä°ÅŸ kartlarÄ± buraya gelecek -->
                </div>
            `, handleDashboard);

            router.add('new-job', `
                <h1 id="job-form-title" class="text-4xl font-extrabold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="plus-circle" class="w-8 h-8 mr-3"></i> Yeni Ä°ÅŸ KaydÄ±</h1>
                
                <form id="job-form" class="bg-white p-8 rounded-xl shadow-lg space-y-6">
                    <div id="current-images" class="p-3 bg-indigo-50 rounded-lg"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="jobTitle" class="block text-sm font-medium text-gray-700">Ä°ÅŸ BaÅŸlÄ±ÄŸÄ±</label>
                            <input type="text" id="jobTitle" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                        </div>
                        <div>
                            <label for="orderCode" class="block text-sm font-medium text-gray-700">SipariÅŸ Kodu</label>
                            <input type="text" id="orderCode" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border uppercase">
                        </div>
                    </div>
                    
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700">MÃ¼ÅŸteri AdÄ±/Firma</label>
                        <input type="text" id="customerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                    </div>

                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700">Durum</label>
                        <select id="status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                            <option value="Yeni SipariÅŸ">Yeni SipariÅŸ</option>
                            <option value="Ãœretim AÅŸamasÄ±nda">Ãœretim AÅŸamasÄ±nda</option>
                            <option value="Kalite Kontrol">Kalite Kontrol</option>
                            <option value="Teslim Edildi">Teslim Edildi</option>
                            <option value="Ä°ptal Edildi">Ä°ptal Edildi</option>
                        </select>
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">AÃ§Ä±klama</label>
                        <textarea id="description" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border"></textarea>
                    </div>

                    <div>
                        <label for="fileAttachment" class="block text-sm font-medium text-gray-700">GÃ¶rsel Ekle (Opsiyonel)</label>
                        <input type="file" id="fileAttachment" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <p class="text-xs text-gray-500 mt-1">Sadece tek dosya yÃ¼klenebilir (DÃ¼zenlerken Ã¶nceki resimler korunur).</p>
                    </div>
                    
                    <div id="form-loading" class="text-center text-indigo-600 hidden">
                        <i data-lucide="loader" class="animate-spin w-6 h-6 inline-block mr-2"></i> Kaydediliyor...
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" id="job-form-button" class="flex-grow py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition">
                            Ä°ÅŸi Kaydet
                        </button>
                        <button type="button" id="delete-job-button" class="py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-red-600 hover:bg-red-700 transition hidden">
                            Ä°ÅŸi Sil
                        </button>
                    </div>
                </form>
            `, handleNewJob);
            
            router.add('announcements', `
                <h1 class="text-4xl font-extrabold text-gray-800 mb-8 border-b pb-2 flex items-center"><i data-lucide="megaphone" class="w-8 h-8 mr-3"></i> Duyurular</h1>
                <div id="announcement-list" class="space-y-4">
                    <!-- Duyurular buraya gelecek -->
                </div>
            `, handleAnnouncements);

            router.add('admin-panel', `
                <h1 class="text-4xl font-extrabold text-gray-800 mb-8 border-b pb-2 flex items-center"><i data-lucide="wrench" class="w-8 h-8 mr-3"></i> Admin Panel</h1>
                
                <!-- YENÄ°: Personel HesabÄ± OluÅŸturma (KullanÄ±cÄ± AdÄ± Zorunlu) -->
                <div class="mb-10 p-6 bg-white rounded-xl shadow-lg border-t-4 border-indigo-500">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center"><i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Yeni Personel HesabÄ± OluÅŸtur</h2>
                    <form id="new-user-form" class="space-y-4">
                        <!-- YENÄ° KULLANICI ADI ALANI -->
                        <input type="text" id="newUsername" placeholder="KullanÄ±cÄ± AdÄ± (Ã–rn: emrahkutlu)" required class="w-full px-3 py-2 border rounded-md">
                        
                        <input type="email" id="newUserEmail" placeholder="GerÃ§ek E-posta (Firebase KaydÄ± Ä°Ã§in)" required class="w-full px-3 py-2 border rounded-md">
                        <input type="password" id="newUserPassword" placeholder="Åžifre (Min 6 Karakter)" required class="w-full px-3 py-2 border rounded-md">
                        
                        <select id="newUserRole" required class="w-full px-3 py-2 border rounded-md bg-white">
                            <option value="Worker">Worker</option>
                            <option value="Master">Master</option>
                            <option value="Admin">Admin</option>
                        </select>
                        <button type="submit" class="w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition">
                            HesabÄ± OluÅŸtur ve Rol Ata
                        </button>
                    </form>
                </div>
                
                <!-- Rol YÃ¶netimi -->
                <div class="mb-10 p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Personel Rol YÃ¶netimi</h2>
                    <p class="text-sm text-gray-600 mb-4">Yeni hesaplarÄ± oluÅŸturduktan sonra veya Google ile giriÅŸ yapanlarÄ±n rollerini buradan dÃ¼zenleyebilirsiniz.</p>
                    <ul id="user-role-list" class="space-y-3">
                        <!-- KullanÄ±cÄ±lar ve roller buraya gelecek -->
                    </ul>
                </div>

                <!-- Duyuru Ekleme -->
                <div class="p-6 bg-white rounded-xl shadow-lg border-t-4 border-purple-500">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Yeni Duyuru Ekle</h2>
                    <form id="announcement-form" class="space-y-4">
                        <div>
                            <label for="announcementTitle" class="block text-sm font-medium text-gray-700">BaÅŸlÄ±k</label>
                            <input type="text" id="announcementTitle" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                        </div>
                        <div>
                            <label for="announcementContent" class="block text-sm font-medium text-gray-700">Ä°Ã§erik</label>
                            <textarea id="announcementContent" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border"></textarea>
                        </div>
                        <button type="submit" class="w-full py-3 px-4 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition">
                            Duyuruyu YayÄ±nla
                        </button>
                    </form>
                </div>
            `, handleAdminPanel);


            // Personel/MÃ¼ÅŸteri Modu GeÃ§iÅŸleri ve Event Listeners (Ã–nceki koddan)
            const staffLoginForm = document.getElementById('staff-login-form');
            const customerTrackerForm = document.getElementById('customer-tracker-form');
            const showStaffButton = document.getElementById('show-staff-login');
            const showCustomerButton = document.getElementById('show-customer-tracker');

            const switchAuthMode = (mode) => {
                const isStaff = mode === 'staff';
                
                staffLoginForm.classList.toggle('hidden', !isStaff);
                customerTrackerForm.classList.toggle('hidden', isStaff);
                
                // Buton stillerini gÃ¼ncelle
                showStaffButton.classList.remove('bg-indigo-600', 'text-white', 'bg-gray-100', 'text-gray-700', 'font-bold');
                showCustomerButton.classList.remove('bg-indigo-600', 'text-white', 'bg-gray-100', 'text-gray-700', 'font-bold');
                
                showStaffButton.classList.add(isStaff ? 'bg-indigo-600' : 'bg-gray-100', isStaff ? 'text-white' : 'text-gray-700', isStaff ? 'font-bold' : '');
                showCustomerButton.classList.add(!isStaff ? 'bg-indigo-600' : 'bg-gray-100', !isStaff ? 'text-white' : 'text-gray-700', !isStaff ? 'font-bold' : '');

                customerJobDetails.innerHTML = '';
            };

            // Event Listeners
            showStaffButton.addEventListener('click', () => switchAuthMode('staff'));
            showCustomerButton.addEventListener('click', () => switchAuthMode('customer'));
            
            // KULLANICI ADI/E-POSTA GÄ°RÄ°Åž DÄ°NLEYÄ°CÄ°SÄ°
            emailPasswordForm.addEventListener('submit', handleEmailPasswordLogin);

            // GOOGLE GÄ°RÄ°Åž DÄ°NLEYÄ°CÄ°SÄ° KALDIRILDI

            document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            document.getElementById('customer-order-form').addEventListener('submit', handleCustomerTracking);

            // Navigasyon linklerini baÄŸla
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    router.navigate(e.currentTarget.dataset.route);
                });
            });

            switchAuthMode('staff'); 
        });

    </script>
</body>
</html>
