<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesyonel İş Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Modern kaydırma çubuğu */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Bildirim stili */
        #notification-center {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .notification-item {
            animation: fadeInOut 5s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(300px); }
            10% { opacity: 1; transform: translateX(0); }
            90% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(300px); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

    <div id="notification-center" class="space-y-2"></div>

    <div id="login-container" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div id="auth-switcher" class="max-w-xl w-full space-y-8 p-10 bg-white shadow-2xl rounded-2xl border border-gray-100">
            
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                <i data-lucide="briefcase" class="inline-block w-8 h-8 mr-2 text-indigo-600"></i> İş Takip Sistemi
            </h2>
            
            <div id="mode-selection" class="flex justify-center space-x-4 border-b pb-4">
                <button id="show-staff-login" class="px-6 py-2 text-sm font-medium rounded-lg transition duration-200 bg-indigo-500 text-white font-bold">
                    Personel Girişi
                </button>
                <button id="show-customer-tracker" class="px-6 py-2 text-sm font-medium rounded-lg transition duration-200 text-gray-600 hover:bg-gray-100">
                    Sipariş Takip
                </button>
            </div>
            
            <div id="staff-login-form" class="mt-8 space-y-6">
                <form id="email-password-form" class="space-y-4">
                    <input type="email" id="login-identifier" placeholder="Personel E-postası" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <input type="password" id="login-password" placeholder="Şifre" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition space-x-3">
                        <i data-lucide="log-in" class="w-5 h-5"></i>
                        <span>Personel Girişi</span>
                    </button>
                </form>
                
                <p id="login-error" class="text-red-500 text-center text-sm hidden">Hata: Giriş yapılamadı veya rolünüz atanmadı.</p>
            </div>

            <div id="customer-tracker-form" class="mt-8 space-y-6 hidden">
                <form id="customer-order-form" class="space-y-4">
                    <input type="text" id="order-code-input" placeholder="Sipariş Kodunuzu Girin (Örn: ORD-XXXXX)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 text-lg uppercase" required>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200 text-xl shadow-md">
                        <i data-lucide="search" class="inline-block w-5 h-5 mr-2"></i> Sorgula
                    </button>
                </form>
                <div id="customer-job-details" class="mt-8">
                    <p class="mt-4 text-center text-gray-500">Sipariş sorgulandıktan sonra detaylar burada görünecektir.</p>
                </div>
            </div>

        </div>
    </div>

    <div id="app-container" class="hidden min-h-screen flex">
        
        <aside id="main-nav" class="w-64 bg-gray-900 text-white flex flex-col shadow-2xl">
            <div class="p-6 text-2xl font-bold text-indigo-400 border-b border-gray-800">
                Pro Yönetim
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="#dashboard" data-route="dashboard" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#new-job" data-route="new-job" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Yeni İş Ekle</span>
                </a>
                <a href="#admin-panel" data-route="admin-panel" id="admin-link" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150 hidden">
                    <i data-lucide="wrench" class="w-5 h-5"></i>
                    <span>Admin Panel</span>
                </a>
                <a href="#announcements" data-route="announcements" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150">
                    <i data-lucide="megaphone" class="w-5 h-5"></i>
                    <span>Duyurular</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <p id="user-info" class="text-sm text-gray-400 truncate mb-2"></p>
                <button id="logout-button" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg transition duration-150 text-sm flex items-center justify-center space-x-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Çıkış Yap</span>
                </button>
            </div>
        </aside>

        <main id="content-area" class="flex-grow p-8 overflow-y-auto">
            <div class="h-full flex items-center justify-center text-gray-500">
                <i data-lucide="loader" class="animate-spin w-10 h-10"></i>
                Yükleniyor...
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signOut, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, limit, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // --- 1. SABİT VERİLER VE İLK BAŞLANGIÇ ---

        // KULLANICININ SAĞLADIĞI FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
            authDomain: "kibrissiparissistemi.firebaseapp.com",
            databaseURL: "https://kibrissiparissistemi-default-rtdb.firebaseio.com",
            projectId: "kibrissiparissistemi",
            storageBucket: "kibrissiparissistemi.firebasestorage.app",
            messagingSenderId: "263531733235",
            appId: "1:263531733235:web:82efdf39ed758a22465786",
            measurementId: "G-JK5S6L90Q5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        
        // Globals
        let currentUserRole = null;
        let globalJobData = [];

        // UI Element References
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const contentArea = document.getElementById('content-area');
        const adminLink = document.getElementById('admin-link');
        const userInfoP = document.getElementById('user-info');
        const notificationCenter = document.getElementById('notification-center');
        const customerJobDetails = document.getElementById('customer-job-details');
        const loginErrorElement = document.getElementById('login-error');
        const emailPasswordForm = document.getElementById('email-password-form');
        const loginIdentifierInput = document.getElementById('login-identifier');
        const logoutButton = document.getElementById('logout-button');
        
        // --- 2. YARDIMCI FONKSİYONLAR ---

        /**
         * Real-time Bildirim gösterir.
         */
        function showNotification(title, message, icon, color) {
            const id = Date.now();
            const notifDiv = document.createElement('div');
            notifDiv.id = `notif-${id}`;
            notifDiv.className = `notification-item p-4 bg-white border-l-4 border-${color}-500 rounded-lg shadow-xl mb-3 w-80 flex items-start space-x-3`;
            notifDiv.innerHTML = `
                <i data-lucide="${icon}" class="w-6 h-6 text-${color}-500"></i>
                <div>
                    <h4 class="text-sm font-semibold text-gray-900">${title}</h4>
                    <p class="text-xs text-gray-600 mt-1">${message}</p>
                </div>
            `;
            notificationCenter.prepend(notifDiv); // En üste ekle
            
            lucide.createIcons();

            setTimeout(() => {
                const element = document.getElementById(`notif-${id}`);
                if (element) {
                    element.remove();
                }
            }, 5000);
        }

        /**
         * Kimlik doğrulama modlarını değiştirir (Personel Girişi / Sipariş Takip).
         */
        function switchAuthMode(mode) {
            const staffLoginForm = document.getElementById('staff-login-form');
            const customerTrackerForm = document.getElementById('customer-tracker-form');
            const staffLoginButton = document.getElementById('show-staff-login');
            const customerTrackerButton = document.getElementById('show-customer-tracker');

            if (mode === 'staff') {
                staffLoginForm.classList.remove('hidden');
                customerTrackerForm.classList.add('hidden');
                staffLoginButton.classList.add('bg-indigo-500', 'text-white', 'font-bold');
                staffLoginButton.classList.remove('text-gray-600', 'hover:bg-gray-100');
                customerTrackerButton.classList.remove('bg-green-500', 'text-white', 'font-bold');
                customerTrackerButton.classList.add('text-gray-600', 'hover:bg-gray-100');
            } else if (mode === 'customer') {
                staffLoginForm.classList.add('hidden');
                customerTrackerForm.classList.remove('hidden');
                customerTrackerButton.classList.add('bg-green-500', 'text-white', 'font-bold');
                customerTrackerButton.classList.remove('text-gray-600', 'hover:bg-gray-100');
                staffLoginButton.classList.remove('bg-indigo-500', 'text-white', 'font-bold');
                staffLoginButton.classList.add('text-gray-600', 'hover:bg-gray-100');
            }
        }

        // Router Fonksiyonu (Tamamlandı)
        const router = {
            routes: {},
            navigate: async function (path) {
                const route = path.replace('#', '').split('?')[0] || 'dashboard';
                const linkElements = document.querySelectorAll('.nav-link');
                
                linkElements.forEach(link => {
                    link.classList.remove('bg-indigo-700', 'font-bold');
                    if (link.dataset.route === route) {
                        link.classList.add('bg-indigo-700', 'font-bold');
                    }
                });

                if (this.routes[route]) {
                    contentArea.innerHTML = this.routes[route].template;
                    lucide.createIcons();
                    if (this.routes[route].handler) {
                        await this.routes[route].handler();
                    }
                } else {
                    contentArea.innerHTML = `<h1 class="text-3xl font-bold text-gray-700">404 - Sayfa Bulunamadı</h1>`;
                }
            },
            add: function (path, template, handler) {
                this.routes[path] = { template, handler };
            }
        };

        // Durum renkleri için yardımcı nesne
        const statusColorsMap = {
            'Yeni Sipariş': 'bg-blue-500',
            'Üretim Aşamasında': 'bg-yellow-500',
            'Kalite Kontrol': 'bg-purple-500',
            'Teslim Edildi': 'bg-green-500',
            'İptal Edildi': 'bg-red-500',
        };

        // İş Kartı Render Fonksiyonu
        const renderJobCard = (job, docId) => {
            const isMaster = currentUserRole === 'Admin' || currentUserRole === 'Master';
            const statusColorClass = statusColorsMap[job.status]?.replace('bg-', 'border-') || 'border-gray-500';
            const statusBgClass = statusColorsMap[job.status] || 'bg-gray-500';
            const createdAt = job.createdAt && job.createdAt.toDate ? new Date(job.createdAt.toDate()).toLocaleDateString('tr-TR') : 'Bilinmiyor';
            
            return `
                <div id="job-${docId}" class="bg-white p-6 rounded-xl shadow-lg border-l-4 ${statusColorClass} transform hover:scale-[1.01] transition duration-150">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-extrabold text-gray-800">${job.jobTitle}</h3>
                        <span class="px-3 py-1 text-xs font-semibold text-white rounded-full ${statusBgClass}">${job.status}</span>
                    </div>
                    <p class="text-xs font-mono text-gray-500 mb-2">Kod: ${job.orderCode}</p>
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">${job.description || 'Açıklama girilmedi.'}</p>
                    <p class="text-xs text-gray-500">Oluşturulma: ${createdAt}</p>
                    
                    <div class="mt-4 flex space-x-2">
                        <button data-doc-id="${docId}" data-action="view" class="job-action-button text-indigo-600 hover:text-indigo-800 transition text-sm font-medium flex items-center">
                            <i data-lucide="eye" class="w-4 h-4 mr-1"></i> Detay
                        </button>
                        ${isMaster ? `
                        <button data-doc-id="${docId}" data-action="edit" class="job-action-button text-blue-600 hover:text-blue-800 transition text-sm font-medium flex items-center">
                            <i data-lucide="edit" class="w-4 h-4 mr-1"></i> Düzenle
                        </button>
                        <button data-doc-id="${docId}" data-action="delete" class="job-action-button text-red-600 hover:text-red-800 transition text-sm font-medium flex items-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> Sil
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        };

        // --- 3. İŞLEMLER (CRUD ve Takip) ---

        /**
         * İş formunu kaydeder veya günceller (Sadece Master/Admin).
         */
        const handleJobFormSubmit = async (e) => {
            e.preventDefault();
            
            if (currentUserRole !== 'Admin' && currentUserRole !== 'Master') {
                showNotification("Yetkisiz Erişim", "İşlemi gerçekleştirmek için yetkiniz yok.", "lock", "red");
                return;
            }

            const form = e.target;
            const docId = form.dataset.docId || null; // Düzenleme modundaysa docId vardır.
            const isEditing = !!docId;
            const jobTitle = document.getElementById('jobTitle').value;
            const orderCode = document.getElementById('orderCode').value.toUpperCase();
            const customerName = document.getElementById('customerName').value;
            const status = document.getElementById('status').value;
            const description = document.getElementById('description').value;
            const fileAttachment = document.getElementById('fileAttachment').files[0];
            const formLoading = document.getElementById('form-loading');

            formLoading.classList.remove('hidden');

            try {
                let attachmentURL = '';
                
                // 1. Yeni Dosya Yükleme (varsa)
                if (fileAttachment) {
                    const storageRef = ref(storage, `job_attachments/${orderCode}/${fileAttachment.name}`);
                    await uploadBytes(storageRef, fileAttachment);
                    attachmentURL = await getDownloadURL(storageRef);
                    showNotification("Dosya Yüklendi", `${fileAttachment.name} başarıyla yüklendi.`, "upload", "blue");
                }
                
                const jobData = {
                    jobTitle,
                    orderCode,
                    customerName,
                    status,
                    description,
                    updatedAt: Timestamp.now(),
                    attachmentURL: attachmentURL || document.getElementById('current-images').dataset.currentUrl || null, // Yeni dosya yoksa, var olanı koru
                    createdBy: auth.currentUser.email
                };

                // 2. İşlemi Kaydet/Güncelle
                if (isEditing) {
                    // Güncelleme
                    const jobDocRef = doc(db, 'jobs', docId);
                    await updateDoc(jobDocRef, jobData);
                    showNotification("Başarılı", `${orderCode} siparişi güncellendi.`, "check-circle", "green");
                } else {
                    // Yeni Kayıt
                    jobData.createdAt = Timestamp.now();
                    await addDoc(collection(db, 'jobs'), jobData);
                    showNotification("Başarılı", `${orderCode} siparişi başarıyla oluşturuldu.`, "check-circle", "green");
                    form.reset();
                }

                router.navigate('#dashboard'); // Dashboard'a geri dön
            } catch (error) {
                console.error("İş Kaydı Hatası:", error);
                showNotification("Hata", "İş kaydı/güncellemesi sırasında bir sorun oluştu.", "x-circle", "red");
            } finally {
                formLoading.classList.add('hidden');
            }
        };

        /**
         * İşi siler (Sadece Master/Admin).
         */
        const handleDeleteJob = async (docId) => {
             if (currentUserRole !== 'Admin' && currentUserRole !== 'Master') {
                showNotification("Yetkisiz Erişim", "Silme işlemini gerçekleştirmek için yetkiniz yok.", "lock", "red");
                return;
            }
            
            if (!confirm("Bu iş kaydını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.")) {
                return;
            }

            try {
                // Sadece belgeyi sil, storage'ı temizlemek opsiyoneldir ve daha karmaşıktır.
                const jobDocRef = doc(db, 'jobs', docId);
                await deleteDoc(jobDocRef);
                showNotification("Başarılı", "İş kaydı silindi.", "trash-2", "red");
                router.navigate('#dashboard');
            } catch (error) {
                console.error("Silme Hatası:", error);
                showNotification("Hata", "Silme işlemi sırasında bir sorun oluştu.", "x-circle", "red");
            }
        };

        /**
         * Müşteri sipariş takip formunu işler.
         */
        const handleCustomerTracking = async (e) => { 
            e.preventDefault();
            const orderCodeInput = document.getElementById('order-code-input');
            const orderCode = orderCodeInput.value.toUpperCase().trim();
            customerJobDetails.innerHTML = `<p class="mt-4 text-center text-indigo-600"><i data-lucide="loader" class="animate-spin w-4 h-4 inline-block mr-2"></i> Sorgulanıyor...</p>`;
            lucide.createIcons();

            if (!orderCode) {
                customerJobDetails.innerHTML = `<p class="mt-4 text-center text-red-500">Lütfen bir sipariş kodu girin.</p>`;
                return;
            }

            try {
                // orderCode'a göre sorgulama
                const q = query(collection(db, "jobs"), where("orderCode", "==", orderCode), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    customerJobDetails.innerHTML = `<div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 mt-4 rounded-lg">
                        <p class="font-bold">Sipariş Bulunamadı</p>
                        <p class="text-sm">Girdiğiniz koda ait aktif bir sipariş bulunamadı. Kodunuzu kontrol edin.</p>
                    </div>`;
                } else {
                    const jobDoc = querySnapshot.docs[0];
                    const job = jobDoc.data();
                    const statusColorClass = statusColorsMap[job.status] || 'bg-gray-500';

                    customerJobDetails.innerHTML = `
                        <div class="p-6 bg-white border-l-4 ${statusColorClass.replace('bg-', 'border-')} rounded-lg shadow-xl">
                            <h3 class="text-2xl font-bold text-gray-800">${job.jobTitle}</h3>
                            <p class="text-sm font-mono text-gray-500 mb-4">Kod: ${job.orderCode}</p>
                            <div class="mb-4">
                                <span class="px-3 py-1 text-base font-semibold text-white rounded-full ${statusColorClass}">${job.status}</span>
                            </div>
                            <p class="text-gray-700 mb-4">${job.description || 'Açıklama mevcut değil.'}</p>
                            <p class="text-xs text-gray-500">Son Güncelleme: ${job.updatedAt && job.updatedAt.toDate ? new Date(job.updatedAt.toDate()).toLocaleString('tr-TR') : 'Bilinmiyor'}</p>
                            ${job.attachmentURL ? `<a href="${job.attachmentURL}" target="_blank" class="mt-4 inline-flex items-center text-indigo-600 hover:text-indigo-800 text-sm font-medium"><i data-lucide="image" class="w-4 h-4 mr-1"></i> Ekli Dosyayı Gör</a>` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error("Sipariş Sorgulama Hatası:", error);
                customerJobDetails.innerHTML = `<p class="mt-4 text-center text-red-500">Sistem hatası oluştu. Lütfen tekrar deneyin.</p>`;
            }
            lucide.createIcons();
        };

        /**
         * Dashboard üzerindeki aksiyon butonlarını (Detay/Düzenle/Sil) işler.
         */
        const handleJobAction = (e) => {
            const button = e.target.closest('.job-action-button');
            if (!button) return;

            const docId = button.dataset.docId;
            const action = button.dataset.action;

            if (action === 'view') {
                // Detay göster (Şimdilik sadece bildirim)
                showNotification("Detay", `İş Kod: ${docId} detayı açılacak.`, "eye", "indigo");
            } else if (action === 'edit') {
                // Düzenle formuna git (Mock, gerçekte veriler doldurulmalı)
                router.navigate(`#new-job?edit=${docId}`);
            } else if (action === 'delete') {
                handleDeleteJob(docId);
            }
        };


        /**
         * Dashboard'u gerçek zamanlı dinleyici ile günceller.
         */
        const setupRealTimeJobListener = () => {
            // Rol kısıtlaması yoksa tüm işleri getir (Worker'lar için rol filtrelemesi eklenebilir)
            const jobsColRef = collection(db, 'jobs');
            const q = query(jobsColRef);
            
            // onSnapshot ile gerçek zamanlı dinleme
            onSnapshot(q, (snapshot) => {
                const jobList = document.getElementById('dashboard-job-list');
                if (!jobList) return; // Dashboard açık değilse işlem yapma

                globalJobData = []; // Global veriyi temizle
                let jobCardsHtml = '';
                
                snapshot.docChanges().forEach(change => {
                    const job = { docId: change.doc.id, ...change.doc.data() };
                    globalJobData.push(job);
                });

                // Yeniden sırala (Örn: En yeni en başta)
                globalJobData.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                // Tüm işleri yeniden render et
                jobCardsHtml = globalJobData.map(job => renderJobCard(job, job.docId)).join('');
                
                jobList.innerHTML = jobCardsHtml || `<p class="col-span-full text-center text-gray-500 mt-8">Henüz kayıtlı bir iş bulunmamaktadır.</p>`;
                
                // Event listener'ları yeniden bağla
                document.querySelectorAll('.job-action-button').forEach(button => {
                    button.removeEventListener('click', handleJobAction); // Önce kaldır
                    button.addEventListener('click', handleJobAction); // Sonra bağla
                });

                lucide.createIcons(); // Yeni ikonları render et
                showNotification("Güncelleme", "İş listesi gerçek zamanlı olarak güncellendi.", "refresh-cw", "indigo");
            }, (error) => {
                console.error("Realtime Dinleme Hatası:", error);
                showNotification("Hata", "İş listesi güncellenemedi.", "x-circle", "red");
            });
        };


        // --- 4. AUTH VE ROL YÖNETİMİ ---

        /**
         * Rolleri Firebase'den çeker.
         */
        const fetchUserRole = async (uid) => {
            try {
                const roleDocRef = doc(db, 'userRoles', uid); 
                const docSnap = await getDoc(roleDocRef);
                return docSnap.exists() ? docSnap.data().role : null;
            } catch (error) {
                console.error("Rol Çekme Hatası:", error);
                return null;
            }
        };
        
        /**
         * E-posta ve Şifre ile Giriş İşlemi
         */
        const handleEmailPasswordLogin = async (e) => {
            e.preventDefault();
            loginErrorElement.classList.add('hidden');
            const email = loginIdentifierInput.value.trim();
            const password = document.getElementById('login-password').value;

            localStorage.setItem('lastIdentifier', email);
            if (!email || !password) {
                 loginErrorElement.textContent = 'Lütfen e-posta ve şifrenizi girin.';
                 loginErrorElement.classList.remove('hidden');
                 return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Giriş Hatası:", error);
                let errorMessage = 'Giriş Başarısız: Bilinmeyen bir hata oluştu.';
                
                switch (error.code) {
                    case 'auth/invalid-credential':
                    case 'auth/wrong-password':
                    case 'auth/user-not-found': 
                        errorMessage = 'Hatalı e-posta veya şifre. Lütfen bilgilerinizi kontrol edin.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Çok fazla deneme yapıldı. Lütfen daha sonra tekrar deneyin.';
                        break;
                    default:
                        errorMessage = 'Giriş Başarısız: Sistem hatası. Lütfen yönetici ile iletişime geçin.';
                        break;
                }

                loginErrorElement.textContent = errorMessage;
                loginErrorElement.classList.remove('hidden');
            }
        };

        /**
         * Çıkış İşlemi
         */
        const handleLogout = async () => {
            try {
                await signOut(auth);
                showNotification("Başarılı", "Başarıyla çıkış yapıldı.", "log-out", "red");
                window.location.hash = ''; // URL hash'ini temizle
            } catch (error) {
                console.error("Çıkış Hatası:", error);
                showNotification("Hata", "Çıkış yapılırken bir sorun oluştu.", "x-circle", "red");
            }
        };

        /**
         * Auth durumuna göre UI'ı günceller.
         */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserRole = await fetchUserRole(user.uid); 
                
                if (!currentUserRole || currentUserRole === 'none' || currentUserRole === 'Müşteri') {
                    
                    let errorMessage = `Hesabınıza bir personel rolü atanmamış (${user.email}). Lütfen yöneticinizle iletişime geçin.`;
                    
                    try {
                          await signOut(auth);
                    } catch (e) {
                        console.error("Çıkış hatası:", e);
                    }
                    
                    loginErrorElement.textContent = errorMessage;
                    loginErrorElement.classList.remove('hidden');
                    return; 
                }

                // Başarılı giriş ve rol kontrolü
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                const emailDisplay = localStorage.getItem('lastIdentifier') || user.email;
                userInfoP.innerHTML = `Hoş Geldiniz, <span class="font-bold text-white">${currentUserRole} (${emailDisplay.split('@')[0]})</span>`;
                
                if (currentUserRole === 'Admin') {
                    adminLink.classList.remove('hidden');
                } else {
                    adminLink.classList.add('hidden');
                }
                
                // Dashboard'u dinlemeye başla
                setupRealTimeJobListener();
                router.navigate(window.location.hash);

            } else {
                // Oturum kapalı
                appContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                router.navigate('');
                currentUserRole = null;
                
                const lastIdentifier = localStorage.getItem('lastIdentifier');
                if (lastIdentifier) {
                    loginIdentifierInput.value = lastIdentifier;
                }
                
                switchAuthMode('staff');
            }
            lucide.createIcons();
        });


        // --- 5. ROUTER HANDLERS (Tamamlandı) ---

        const handleDashboard = () => {
             // Dinleyici (setupRealTimeJobListener) onAuthStateChanged içinde zaten ayarlanmış olmalı.
            // Bu kısım sadece template yüklendiğinde çalışır, veriler onSnapshot ile gelir.
            const jobList = document.getElementById('dashboard-job-list');
            if (jobList) {
                jobList.innerHTML = `
                    <div class="col-span-full text-center py-10">
                         <i data-lucide="loader" class="animate-spin w-8 h-8 inline-block mr-2 text-indigo-500"></i>
                         <p class="text-gray-500 mt-2">İşleriniz yükleniyor...</p>
                    </div>
                `;
            }
            // Sayfa yüklendiğinde navigasyon butonlarına tıklandığında router'ın handleJobAction'ı tekrar bağlamasını sağlar.
            document.querySelectorAll('.job-action-button').forEach(button => {
                 button.addEventListener('click', handleJobAction);
            });
        };

        const handleNewJob = async () => { 
            const form = document.getElementById('job-form');
            const jobFormTitle = document.getElementById('job-form-title');
            const jobFormButton = document.getElementById('job-form-button');
            const deleteJobButton = document.getElementById('delete-job-button');
            const currentImagesDiv = document.getElementById('current-images');

            form.removeEventListener('submit', handleJobFormSubmit);
            form.addEventListener('submit', handleJobFormSubmit);

            const urlParams = new URLSearchParams(window.location.hash.split('?')[1]);
            const docId = urlParams.get('edit');

            if (docId) {
                jobFormTitle.innerHTML = `<i data-lucide="edit" class="w-8 h-8 mr-3"></i> İşi Düzenle`;
                jobFormButton.textContent = 'Değişiklikleri Kaydet';
                deleteJobButton.classList.remove('hidden');
                form.dataset.docId = docId;

                // Silme butonu dinleyicisi
                deleteJobButton.removeEventListener('click', handleDeleteJob);
                deleteJobButton.addEventListener('click', () => handleDeleteJob(docId));

                // Verileri çek ve formu doldur
                try {
                    const jobDocRef = doc(db, 'jobs', docId);
                    const docSnap = await getDoc(jobDocRef);

                    if (docSnap.exists()) {
                        const job = docSnap.data();
                        document.getElementById('jobTitle').value = job.jobTitle || '';
                        document.getElementById('orderCode').value = job.orderCode || '';
                        document.getElementById('customerName').value = job.customerName || '';
                        document.getElementById('status').value = job.status || 'Yeni Sipariş';
                        document.getElementById('description').value = job.description || '';
                        
                        // Ekli görsel varsa göster
                        if (job.attachmentURL) {
                            currentImagesDiv.innerHTML = `
                                <p class="text-sm font-semibold text-gray-800 mb-2">Mevcut Görsel:</p>
                                <a href="${job.attachmentURL}" target="_blank" class="inline-flex items-center text-sm text-indigo-600 hover:text-indigo-800">
                                    <i data-lucide="link" class="w-4 h-4 mr-1"></i> Görüntüle
                                </a>
                                <p class="text-xs text-gray-500 mt-1">Yeni dosya yüklerseniz bu dosya silinir.</p>
                            `;
                            currentImagesDiv.dataset.currentUrl = job.attachmentURL; // Güncelleme için mevcut URL'yi sakla
                        } else {
                             currentImagesDiv.innerHTML = '';
                             currentImagesDiv.dataset.currentUrl = '';
                        }
                    } else {
                        showNotification("Hata", "Düzenlenecek iş bulunamadı.", "x-circle", "red");
                        router.navigate('#dashboard');
                    }
                } catch (error) {
                    console.error("İş Verisi Çekme Hatası:", error);
                    showNotification("Hata", "İş verileri yüklenirken bir sorun oluştu.", "x-circle", "red");
                }
            } else {
                // Yeni İş Kaydı modu
                jobFormTitle.innerHTML = `<i data-lucide="plus-circle" class="w-8 h-8 mr-3"></i> Yeni İş Kaydı`;
                jobFormButton.textContent = 'İşi Kaydet';
                deleteJobButton.classList.add('hidden');
                deleteJobButton.removeEventListener('click', handleDeleteJob);
                delete form.dataset.docId;
                form.reset();
                currentImagesDiv.innerHTML = '';
                currentImagesDiv.dataset.currentUrl = '';
            }
             lucide.createIcons();
        };

        const handleNewUserCreation = async (e) => {
            e.preventDefault();
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (!email || !password || !role) {
                showNotification("Hata", "Tüm alanları doldurun.", "alert-triangle", "red");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;

                const roleDocRef = doc(db, 'userRoles', uid);
                await setDoc(roleDocRef, { 
                    email: email, 
                    role: role,
                }, { merge: true });

                showNotification("Başarılı", `Personel (${email}) başarıyla oluşturuldu ve rolü '${role}' olarak atandı.`, "check-circle", "green");
                e.target.reset();
                
                await handleAdminPanel(); // Listeyi güncelle
                
            } catch (error) {
                console.error("Kullanıcı Oluşturma Hatası:", error);
                let errorMessage = "Hesap oluşturulamadı: Bilinmeyen bir hata oluştu.";

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Bu e-posta adresi zaten kullanılıyor.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Şifre en az 6 karakter olmalıdır.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Geçersiz e-posta formatı.";
                }

                showNotification("Kayıt Hatası", errorMessage, "x-circle", "red");
            }
        };

        const updateAnnouncementList = async () => {
            const announcementList = document.getElementById('announcement-list');
            if (!announcementList) return;

            announcementList.innerHTML = '<p class="text-center text-gray-500">Duyurular yükleniyor...</p>';

            try {
                const q = query(collection(db, "announcements"), limit(10));
                const querySnapshot = await getDocs(q);
                let html = '';

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString('tr-TR') : 'Bilinmiyor';
                    html += `
                        <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-purple-500">
                            <div class="flex justify-between items-center">
                                <h4 class="text-lg font-semibold text-gray-800">${data.title}</h4>
                                <span class="text-xs text-gray-500">${date}</span>
                            </div>
                            <p class="text-gray-600 mt-2">${data.content}</p>
                        </div>
                    `;
                });

                announcementList.innerHTML = html || `<div class="p-4 bg-gray-100 text-gray-600 rounded-lg text-center">Henüz yayınlanmış bir duyuru yok.</div>`;

            } catch (error) {
                console.error("Duyuru Çekme Hatası:", error);
                announcementList.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg text-center">Duyurular yüklenirken hata oluştu.</div>`;
            }
        };

        const handleAnnouncementSubmit = async (e) => {
            e.preventDefault();
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            const form = e.target;

            if (!title || !content) {
                 showNotification("Hata", "Başlık ve içerik boş bırakılamaz.", "alert-triangle", "red");
                 return;
            }

            try {
                await addDoc(collection(db, 'announcements'), {
                    title,
                    content,
                    createdAt: Timestamp.now(),
                    createdBy: auth.currentUser.email
                });
                showNotification("Başarılı", "Duyuru başarıyla yayınlandı.", "megaphone", "purple");
                form.reset();
                await updateAnnouncementList();
            } catch (error) {
                console.error("Duyuru Yayınlama Hatası:", error);
                showNotification("Hata", "Duyuru yayınlanırken bir sorun oluştu.", "x-circle", "red");
            }
        };

        const handleAnnouncements = async () => { 
            // Duyuru listesini yükle
            await updateAnnouncementList();
        };

        const handleAdminPanel = async () => {
            // Admin yetki kontrolü
             if (currentUserRole !== 'Admin') {
                contentArea.innerHTML = `<h1 class="text-3xl font-bold text-red-500">Erişim Engellendi: Sadece Yöneticiler</h1>`;
                return;
            }
            
            // Kullanıcı oluşturma formu dinleyicisini bağla
            document.getElementById('new-user-form')?.removeEventListener('submit', handleNewUserCreation);
            document.getElementById('new-user-form')?.addEventListener('submit', handleNewUserCreation);
            
            // Duyuru formu dinleyicisini bağla
            document.getElementById('admin-announcement-form')?.removeEventListener('submit', handleAnnouncementSubmit);
            document.getElementById('admin-announcement-form')?.addEventListener('submit', handleAnnouncementSubmit);

            // Kullanıcı Rol Listesini Çek
            const userRoleList = document.getElementById('user-role-list');
            if (userRoleList) {
                userRoleList.innerHTML = '<li class="p-3 text-center text-gray-500">Kullanıcı rolleri yükleniyor...</li>';
                let listHtml = '';

                try {
                    const q = query(collection(db, "userRoles"));
                    const querySnapshot = await getDocs(q);

                    querySnapshot.forEach((doc) => {
                        const userRole = doc.data();
                        const uid = doc.id;
                        const isCurrentUser = uid === auth.currentUser.uid;
                        const selectDisabled = isCurrentUser ? 'disabled' : '';
                        const roleColor = userRole.role === 'Admin' ? 'blue-500' : 'yellow-500';

                        listHtml += `
                            <li class="p-3 bg-gray-50 rounded-lg flex justify-between items-center border-l-4 border-${roleColor}">
                                <span>${userRole.email} <span class="text-xs text-gray-500">(${isCurrentUser ? 'Siz' : userRole.role})</span></span>
                                <select class="p-1 border rounded role-select" data-uid="${uid}" ${selectDisabled}>
                                    <option value="Admin" ${userRole.role === 'Admin' ? 'selected' : ''}>Admin</option>
                                    <option value="Master" ${userRole.role === 'Master' ? 'selected' : ''}>Master</option>
                                    <option value="Worker" ${userRole.role === 'Worker' ? 'selected' : ''}>Worker</option>
                                    <option value="none" ${userRole.role === 'none' ? 'selected' : ''}>Rol Yok (Erişim Engelli)</option>
                                </select>
                            </li>
                        `;
                    });

                    userRoleList.innerHTML = listHtml || '<li class="p-3 text-center text-gray-500">Kayıtlı kullanıcı rolü bulunmamaktadır.</li>';
                    lucide.createIcons();

                    // Rol değiştirme dinleyicileri
                    document.querySelectorAll('.role-select').forEach(select => {
                        select.addEventListener('change', async (e) => {
                            const targetUid = e.target.dataset.uid;
                            const newRole = e.target.value;
                            try {
                                const roleDocRef = doc(db, 'userRoles', targetUid);
                                await updateDoc(roleDocRef, { role: newRole });
                                showNotification("Başarılı", `${e.target.closest('li').querySelector('span').textContent} için rol '${newRole}' olarak güncellendi.`, "user-check", "orange");
                            } catch (error) {
                                console.error("Rol Güncelleme Hatası:", error);
                                showNotification("Hata", "Rol güncellenemedi.", "x-circle", "red");
                            }
                        });
                    });

                } catch (error) {
                    console.error("Admin Panel Veri Çekme Hatası:", error);
                    userRoleList.innerHTML = `<li class="p-3 text-center text-red-500">Kullanıcı rolleri yüklenirken hata oluştu.</li>`;
                }
            }
        };


        // --- 6. UYGULAMA İLK BAŞLANGIÇ VE DİNLEYİCİLER ---
        
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // Auth Switcher Dinleyicileri
            document.getElementById('show-staff-login').addEventListener('click', () => switchAuthMode('staff'));
            document.getElementById('show-customer-tracker').addEventListener('click', () => switchAuthMode('customer'));

            // Login ve Tracker Form Dinleyicileri
            emailPasswordForm.addEventListener('submit', handleEmailPasswordLogin);
            document.getElementById('customer-order-form').addEventListener('submit', handleCustomerTracking);
            
            // Logout Dinleyicisi
            logoutButton.addEventListener('click', handleLogout);

            // Router'a rotaları ekle
            router.add('dashboard', `
                <h1 class="text-4xl font-extrabold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="layout-dashboard" class="w-8 h-8 mr-3"></i> İş Dashboard</h1>
                <div id="dashboard-job-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
            `, handleDashboard);

            router.add('new-job', `
                <h1 id="job-form-title" class="text-4xl font-extrabold text-gray-800 mb-6 border-b pb-2 flex items-center"><i data-lucide="plus-circle" class="w-8 h-8 mr-3"></i> Yeni İş Kaydı</h1>
                
                <form id="job-form" class="bg-white p-8 rounded-xl shadow-lg space-y-6">
                    <div id="current-images" class="p-3 bg-indigo-50 rounded-lg hidden"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="jobTitle" class="block text-sm font-medium text-gray-700">İş Başlığı</label>
                            <input type="text" id="jobTitle" placeholder="Web Sitesi Tasarımı, Broşür Baskı vb." required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                        </div>
                        <div>
                            <label for="orderCode" class="block text-sm font-medium text-gray-700">Sipariş Kodu</label>
                            <input type="text" id="orderCode" placeholder="ORD-XXXXX" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border uppercase">
                        </div>
                    </div>
                    
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700">Müşteri Adı/Firma</label>
                        <input type="text" id="customerName" placeholder="Müşteri/Firma Adı" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                    </div>

                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700">Durum</label>
                        <select id="status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                            <option value="Yeni Sipariş">Yeni Sipariş</option>
                            <option value="Üretim Aşamasında">Üretim Aşamasında</option>
                            <option value="Kalite Kontrol">Kalite Kontrol</option>
                            <option value="Teslim Edildi">Teslim Edildi</option>
                            <option value="İptal Edildi">İptal Edildi</option>
                        </select>
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Açıklama</label>
                        <textarea id="description" rows="4" placeholder="İşin detaylı tanımı ve notlar..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border"></textarea>
                    </div>

                    <div>
                        <label for="fileAttachment" class="block text-sm font-medium text-gray-700">Görsel Ekle (Opsiyonel)</label>
                        <input type="file" id="fileAttachment" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <p class="text-xs text-gray-500 mt-1">Sadece tek dosya yüklenebilir.</p>
                    </div>
                    
                    <div id="form-loading" class="text-center text-indigo-600 hidden">
                        <i data-lucide="loader" class="animate-spin w-6 h-6 inline-block mr-2"></i> Kaydediliyor...
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" id="job-form-button" class="flex-grow py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition">
                            İşi Kaydet
                        </button>
                        <button type="button" id="delete-job-button" class="py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-red-600 hover:bg-red-700 transition hidden">
                            <i data-lucide="trash-2" class="w-5 h-5 mr-1"></i> İşi Sil
                        </button>
                    </div>
                </form>
            `, handleNewJob);
            
            router.add('announcements', `
                <h1 class="text-4xl font-extrabold text-gray-800 mb-8 border-b pb-2 flex items-center"><i data-lucide="megaphone" class="w-8 h-8 mr-3"></i> Duyurular</h1>
                <div id="announcement-list" class="space-y-4">
                    </div>
            `, handleAnnouncements);

            router.add('admin-panel', `
                <h1 class="text-4xl font-extrabold text-gray-800 mb-8 border-b pb-2 flex items-center"><i data-lucide="wrench" class="w-8 h-8 mr-3"></i> Admin Panel</h1>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2 flex items-center"><i data-lucide="user-plus" class="w-6 h-6 mr-2 text-indigo-500"></i> Yeni Personel Ekle</h2>
                        <form id="new-user-form" class="space-y-4">
                            <input type="email" id="newUserEmail" placeholder="E-posta" required class="w-full px-3 py-2 border rounded-md">
                            <input type="password" id="newUserPassword" placeholder="Şifre (Min 6 karakter)" required class="w-full px-3 py-2 border rounded-md">
                            <select id="newUserRole" required class="w-full px-3 py-2 border rounded-md">
                                <option value="">Rol Seçin</option>
                                <option value="Admin">Admin</option>
                                <option value="Master">Master</option>
                                <option value="Worker">Worker</option>
                            </select>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md transition">Personel Oluştur</button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2 flex items-center"><i data-lucide="users" class="w-6 h-6 mr-2 text-yellow-500"></i> Personel Rol Yönetimi</h2>
                        <ul id="user-role-list" class="space-y-3">
                            </ul>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2 flex items-center"><i data-lucide="bell" class="w-6 h-6 mr-2 text-purple-500"></i> Yeni Duyuru Yayınla</h2>
                        <form id="admin-announcement-form" class="space-y-4">
                            <input type="text" id="announcementTitle" placeholder="Duyuru Başlığı" required class="w-full px-3 py-2 border rounded-md">
                            <textarea id="announcementContent" rows="3" placeholder="Duyuru İçeriği" required class="w-full px-3 py-2 border rounded-md"></textarea>
                            <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 rounded-md transition">Duyuruyu Yayınla</button>
                        </form>
                    </div>
                </div>
            `, handleAdminPanel);

            // Sayfa yüklendiğinde router'ı başlat
            window.addEventListener('hashchange', () => router.navigate(window.location.hash));
            // onAuthStateChanged tetiklenecek ve ilk yönlendirmeyi yapacak.
        });

    </script>
</body>
</html>
