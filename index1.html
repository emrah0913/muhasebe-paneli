<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesyonel İş Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Modern kaydırma çubuğu (WebKit) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Firefox scrollbar desteği için (İsteğe bağlı) */
        * { scrollbar-width: thin; scrollbar-color: #94a3b8 #f1f1f1; }

        /* Bildirim stili */
        #notification-center {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .notification-item {
            animation: fadeInOut 5s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(300px); }
            10% { opacity: 1; transform: translateX(0); }
            90% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(300px); }
        }
    </style>
    <script>
        // CRITICAL FIX: Tailwind dinamik renklerin tanınması için safelist ekleniyor
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'blue-500': '#3b82f6',
                        'green-500': '#22c55e',
                        'red-500': '#ef4444',
                        'indigo-500': '#6366f1',
                        'purple-500': '#a855f7',
                        'yellow-500': '#f59e0b',
                    }
                }
            },
            // Bildirimler için kullanılacak tüm olası sınıflar safelist'e eklenir
            safelist: [
                'border-blue-500', 'text-blue-500', 
                'border-green-500', 'text-green-500', 
                'border-red-500', 'text-red-500', 
                'border-indigo-500', 'text-indigo-500', 
                'border-purple-500', 'text-purple-500',
                'border-yellow-500', 'text-yellow-500',
                'bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-indigo-500', 'bg-purple-500', 'bg-yellow-500',
            ]
        }
    </script>
</head>
<body class="bg-gray-50 font-sans antialiased">

    <div id="notification-center" class="space-y-2"></div>

    <div id="login-container" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div id="auth-switcher" class="max-w-xl w-full space-y-8 p-10 bg-white shadow-2xl rounded-2xl border border-gray-100">
            
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                <i data-lucide="briefcase" class="inline-block w-8 h-8 mr-2 text-indigo-600"></i> İş Takip Sistemi
            </h2>
            
            <div id="mode-selection" class="flex justify-center space-x-4 border-b pb-4">
                <button id="show-staff-login" class="px-6 py-2 text-sm font-medium rounded-lg transition duration-200 bg-indigo-500 text-white font-bold">
                    Personel Girişi
                </button>
                <button id="show-customer-tracker" class="px-6 py-2 text-sm font-medium rounded-lg transition duration-200 text-gray-600 hover:bg-gray-100">
                    Sipariş Takip
                </button>
            </div>
            
            <div id="staff-login-form" class="mt-8 space-y-6">
                <form id="email-password-form" class="space-y-4">
                    <input type="email" id="login-identifier" placeholder="Personel E-postası" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <input type="password" id="login-password" placeholder="Şifre" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition space-x-3">
                        <i data-lucide="log-in" class="w-5 h-5"></i>
                        <span>Personel Girişi</span>
                    </button>
                </form>
                
                <p id="login-error" class="text-red-500 text-center text-sm hidden">Hata: Giriş yapılamadı veya rolünüz atanmadı.</p>
            </div>

            <div id="customer-tracker-form" class="mt-8 space-y-6 hidden">
                <form id="customer-order-form" class="space-y-4">
                    <input type="text" id="order-code-input" placeholder="Sipariş Kodunuzu Girin (Örn: ORD-XXXXX)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 text-lg uppercase" required>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200 text-xl shadow-md">
                        <i data-lucide="search" class="inline-block w-5 h-5 mr-2"></i> Sorgula
                    </button>
                </form>
                <div id="customer-job-details" class="mt-8">
                    <p class="mt-4 text-center text-gray-500">Sipariş sorgulandıktan sonra detaylar burada görünecektir.</p>
                </div>
            </div>

        </div>
    </div>

    <div id="app-container" class="hidden min-h-screen flex">
        
        <aside id="main-nav" class="w-64 bg-gray-900 text-white flex flex-col shadow-2xl">
            <div class="p-6 text-2xl font-bold text-indigo-400 border-b border-gray-800">
                Pro Yönetim
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="#dashboard" data-route="dashboard" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#new-job" data-route="new-job" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Yeni İş Ekle</span>
                </a>
                <a href="#admin-panel" data-route="admin-panel" id="admin-link" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150 hidden">
                    <i data-lucide="wrench" class="w-5 h-5"></i>
                    <span>Admin Panel</span>
                </a>
                <a href="#announcements" data-route="announcements" class="nav-link flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition duration-150">
                    <i data-lucide="megaphone" class="w-5 h-5"></i>
                    <span>Duyurular</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <p id="user-info" class="text-sm text-gray-400 truncate mb-2"></p>
                <button id="logout-button" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg transition duration-150 text-sm flex items-center justify-center space-x-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Çıkış Yap</span>
                </button>
            </div>
        </aside>

        <main id="content-area" class="flex-grow p-8 overflow-y-auto">
            <div class="h-full flex items-center justify-center text-gray-500">
                <i data-lucide="loader" class="animate-spin w-10 h-10"></i>
                Yükleniyor...
            </div>
        </main>
    </div>

    <script type="module">
        // CRITICAL FIX: Firebase modüllerinin doğru CDN'den ve doğru versiyondan içe aktarılması
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js"; // Daha stabil bir CDN versiyonu kullanıldı
        import { 
            getAuth, 
            signOut, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, limit, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js";
        
        // --- 1. SABİT VERİLER VE İLK BAŞLANGIÇ ---

        // KULLANICININ SAĞLADIĞI FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
            authDomain: "kibrissiparissistemi.firebaseapp.com",
            databaseURL: "https://kibrissiparissistemi-default-rtdb.firebaseio.com",
            projectId: "kibrissiparissistemi",
            storageBucket: "kibrissiparissistemi.firebasestorage.app",
            messagingSenderId: "263531733235",
            appId: "1:263531733235:web:82efdf39ed758a22465786",
            measurementId: "G-JK5S6L90Q5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        
        // Globals
        let currentUserRole = null;
        let globalJobData = [];

        // UI Element References
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const contentArea = document.getElementById('content-area');
        const adminLink = document.getElementById('admin-link');
        const userInfoP = document.getElementById('user-info');
        const notificationCenter = document.getElementById('notification-center');
        const customerJobDetails = document.getElementById('customer-job-details');
        const loginErrorElement = document.getElementById('login-error');
        const emailPasswordForm = document.getElementById('email-password-form');
        const logoutButton = document.getElementById('logout-button');
        const loginIdentifierInput = document.getElementById('login-identifier');
        
        // Durum renkleri için yardımcı nesne
        const statusColorsMap = {
            'Yeni Sipariş': 'bg-blue-500',
            'Üretim Aşamasında': 'bg-yellow-500',
            'Kalite Kontrol': 'bg-purple-500',
            'Teslim Edildi': 'bg-green-500',
            'İptal Edildi': 'bg-red-500',
        };

        // --- 2. YARDIMCI FONKSİYONLAR ---

        /**
         * Real-time Bildirim gösterir.
         */
        function showNotification(title, message, icon, color) {
            const id = Date.now();
            // CRITICAL FIX: Dinamik renkler yerine Tailwind safelist'e uygun renk sınıflarını kullan
            const borderColorClass = `border-${color}-500`;
            const iconColorClass = `text-${color}-500`;
            
            const notifDiv = document.createElement('div');
            notifDiv.id = `notif-${id}`;
            notifDiv.className = `notification-item p-4 bg-white border-l-4 ${borderColorClass} rounded-lg shadow-xl mb-3 w-80 flex items-start space-x-3`;
            notifDiv.innerHTML = `
                <i data-lucide="${icon}" class="w-6 h-6 ${iconColorClass}"></i>
                <div>
                    <h4 class="text-sm font-semibold text-gray-900">${title}</h4>
                    <p class="text-xs text-gray-600 mt-1">${message}</p>
                </div>
            `;
            notificationCenter.prepend(notifDiv); // En üste ekle
            
            lucide.createIcons();

            setTimeout(() => {
                const element = document.getElementById(`notif-${id}`);
                if (element) {
                    element.remove();
                }
            }, 5000);
        }

        /**
         * Kimlik doğrulama modlarını değiştirir (Personel Girişi / Sipariş Takip).
         */
        function switchAuthMode(mode) {
            const staffLoginForm = document.getElementById('staff-login-form');
            const customerTrackerForm = document.getElementById('customer-tracker-form');
            const staffLoginButton = document.getElementById('show-staff-login');
            const customerTrackerButton = document.getElementById('show-customer-tracker');

            // Formları sıfırla ve hata mesajlarını gizle
            document.getElementById('email-password-form').reset();
            document.getElementById('customer-order-form').reset();
            document.getElementById('login-error').classList.add('hidden');
            customerJobDetails.innerHTML = `<p class="mt-4 text-center text-gray-500">Sipariş sorgulandıktan sonra detaylar burada görünecektir.</p>`;

            const activeStaffClasses = ['bg-indigo-500', 'text-white', 'font-bold'];
            const inactiveStaffClasses = ['text-gray-600', 'hover:bg-gray-100'];
            const activeCustomerClasses = ['bg-green-500', 'text-white', 'font-bold']; // Müşteri butonu için yeşil kullanıldı
            const inactiveCustomerClasses = ['text-gray-600', 'hover:bg-gray-100'];

            if (mode === 'staff') {
                staffLoginForm.classList.remove('hidden');
                customerTrackerForm.classList.add('hidden');
                staffLoginButton.classList.add(...activeStaffClasses);
                staffLoginButton.classList.remove(...inactiveStaffClasses);
                customerTrackerButton.classList.remove(...activeCustomerClasses);
                customerTrackerButton.classList.add(...inactiveCustomerClasses);
            } else if (mode === 'customer') {
                staffLoginForm.classList.add('hidden');
                customerTrackerForm.classList.remove('hidden');
                customerTrackerButton.classList.add(...activeCustomerClasses);
                customerTrackerButton.classList.remove(...inactiveCustomerClasses);
                staffLoginButton.classList.remove(...activeStaffClasses);
                staffLoginButton.classList.add(...inactiveStaffClasses);
            }
        }

        // Router Fonksiyonu (Tamamlandı)
        const router = {
            routes: {},
            navigate: async function (path) {
                const route = path.replace('#', '').split('?')[0] || 'dashboard';
                const linkElements = document.querySelectorAll('.nav-link');
                
                linkElements.forEach(link => {
                    link.classList.remove('bg-indigo-700', 'font-bold');
                    if (link.dataset.route === route) {
                        link.classList.add('bg-indigo-700', 'font-bold');
                    }
                });

                if (this.routes[route]) {
                    contentArea.innerHTML = this.routes[route].template;
                    lucide.createIcons();
                    if (this.routes[route].handler) {
                        await this.routes[route].handler();
                    }
                } else {
                    contentArea.innerHTML = `<h1 class="text-3xl font-bold text-gray-700">404 - Sayfa Bulunamadı</h1>`;
                }
            },
            add: function (path, template, handler) {
                this.routes[path] = { template, handler };
            }
        };


        // İş Kartı Render Fonksiyonu
        const renderJobCard = (job, docId) => {
            const isMaster = currentUserRole === 'Admin' || currentUserRole === 'Master';
            // Renk sınıfı için 'bg-' ön eki kaldırılmış hali (border için)
            const statusColorClass = statusColorsMap[job.status]?.replace('bg-', 'border-') || 'border-gray-500'; 
            const statusBgClass = statusColorsMap[job.status] || 'bg-gray-500';
            const createdAt = job.createdAt && job.createdAt.toDate ? new Date(job.createdAt.toDate()).toLocaleDateString('tr-TR') : 'Bilinmiyor';
            
            return `
                <div id="job-${docId}" class="bg-white p-6 rounded-xl shadow-lg border-l-4 ${statusColorClass} transform hover:scale-[1.01] transition duration-150">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-extrabold text-gray-800">${job.jobTitle}</h3>
                        <span class="px-3 py-1 text-xs font-semibold text-white rounded-full ${statusBgClass}">${job.status}</span>
                    </div>
                    <p class="text-xs font-mono text-gray-500 mb-2">Kod: ${job.orderCode}</p>
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">${job.description || 'Açıklama girilmedi.'}</p>
                    <p class="text-xs text-gray-500">Oluşturulma: ${createdAt}</p>
                    
                    <div class="mt-4 flex space-x-2">
                        <button data-doc-id="${docId}" data-action="view" class="job-action-button text-indigo-600 hover:text-indigo-800 transition text-sm font-medium flex items-center">
                            <i data-lucide="eye" class="w-4 h-4 mr-1"></i> Detay
                        </button>
                        ${isMaster ? `
                        <button data-doc-id="${docId}" data-action="edit" class="job-action-button text-blue-600 hover:text-blue-800 transition text-sm font-medium flex items-center">
                            <i data-lucide="edit" class="w-4 h-4 mr-1"></i> Düzenle
                        </button>
                        <button data-doc-id="${docId}" data-action="delete" class="job-action-button text-red-600 hover:text-red-800 transition text-sm font-medium flex items-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> Sil
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        };
        
        // YENİ EKLEME: Müşterinin göreceği detay kartını render eder
        const renderCustomerJobDetails = (job) => {
            const statusColorClass = statusColorsMap[job.status] || 'bg-gray-500';
            const updatedAt = job.updatedAt && job.updatedAt.toDate ? new Date(job.updatedAt.toDate()).toLocaleString('tr-TR') : 'Bilinmiyor';

            customerJobDetails.innerHTML = `
                <div class="p-6 bg-white border-l-4 ${statusColorClass.replace('bg-', 'border-')} rounded-lg shadow-xl animate-in fade-in duration-500">
                    <h3 class="text-2xl font-bold text-gray-800">${job.jobTitle}</h3>
                    <p class="text-sm font-mono text-gray-500 mb-4">Kod: ${job.orderCode}</p>
                    <p class="text-gray-700 font-medium mb-1">Müşteri Adı: ${job.customerName || 'Bilinmiyor'}</p>
                    
                    <div class="my-4">
                        <span class="px-3 py-1 text-base font-semibold text-white rounded-full ${statusColorClass} shadow-md">
                            <i data-lucide="info" class="w-4 h-4 inline-block mr-2"></i> ${job.status}
                        </span>
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg border">
                        <p class="text-gray-600 mb-2 font-semibold">İş Açıklaması:</p>
                        <p class="text-gray-700 text-sm">${job.description || 'Açıklama mevcut değil.'}</p>
                    </div>
                    
                    ${job.attachmentURL ? `
                    <div class="mt-4 p-4 border border-indigo-100 bg-indigo-50 rounded-lg">
                        <h4 class="font-bold text-indigo-700 mb-2 flex items-center">
                            <i data-lucide="image" class="w-4 h-4 mr-2"></i> Ekli Görsel/Dosya
                        </h4>
                        <a href="${job.attachmentURL}" target="_blank" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 text-sm font-medium transition duration-150 underline">
                            Dosyayı Görüntüle (Tıklayınız)
                        </a>
                        <p class="text-xs text-gray-500 mt-1">İşinizin son hali veya ön izleme dosyası.</p>
                    </div>
                    ` : ''}

                    <p class="text-xs text-gray-500 mt-4 text-right">Son Güncelleme: ${updatedAt}</p>
                </div>
            `;
            lucide.createIcons();
        };


        // --- 3. İŞLEMLER (CRUD ve Takip) ---

        /**
         * İş formunu kaydeder veya günceller (Sadece Master/Admin).
         */
        const handleJobFormSubmit = async (e) => {
            e.preventDefault();
            
            if (currentUserRole !== 'Admin' && currentUserRole !== 'Master') {
                showNotification("Yetkisiz Erişim", "İşlemi gerçekleştirmek için yetkiniz yok.", "lock", "red");
                return;
            }

            const form = e.target;
            const docId = form.dataset.docId || null; // Düzenleme modundaysa docId vardır.
            const isEditing = !!docId;
            const jobTitle = document.getElementById('jobTitle').value;
            const orderCode = document.getElementById('orderCode').value.toUpperCase();
            const customerName = document.getElementById('customerName').value;
            const status = document.getElementById('status').value;
            const description = document.getElementById('description').value;
            const fileAttachment = document.getElementById('fileAttachment').files[0];
            const formLoading = document.getElementById('form-loading');

            formLoading.classList.remove('hidden');

            try {
                let attachmentURL = document.getElementById('current-images')?.dataset.currentUrl || null; // Mevcut URL'yi al
                
                // 1. Yeni Dosya Yükleme (varsa)
                if (fileAttachment) {
                    const storageRef = ref(storage, `job_attachments/${orderCode}/${fileAttachment.name}`);
                    await uploadBytes(storageRef, fileAttachment);
                    attachmentURL = await getDownloadURL(storageRef);
                    showNotification("Dosya Yüklendi", `${fileAttachment.name} başarıyla yüklendi.`, "upload", "blue");
                }
                
                const jobData = {
                    jobTitle,
                    orderCode,
                    customerName,
                    status,
                    description,
                    updatedAt: Timestamp.now(),
                    attachmentURL: attachmentURL, 
                    createdBy: auth.currentUser.email
                };

                // 2. İşlemi Kaydet/Güncelle
                if (isEditing) {
                    // Güncelleme
                    const jobDocRef = doc(db, 'jobs', docId);
                    await updateDoc(jobDocRef, jobData);
                    showNotification("Başarılı", `${orderCode} siparişi güncellendi.`, "check-circle", "green");
                } else {
                    // Yeni Kayıt
                    jobData.createdAt = Timestamp.now();
                    await addDoc(collection(db, 'jobs'), jobData);
                    showNotification("Başarılı", `${orderCode} siparişi başarıyla oluşturuldu.`, "check-circle", "green");
                    form.reset();
                }

                router.navigate('#dashboard'); // Dashboard'a geri dön
            } catch (error) {
                console.error("İş Kaydı Hatası:", error);
                // Eğer hata storage/unknown ise, kullanıcıya yetki kuralını kontrol etmesini söyle
                const userMessage = error.code === 'storage/unknown' 
                    ? "Hata: Dosya yükleme yetkiniz yok veya Firebase Storage kurallarınız engelliyor."
                    : "İş kaydı/güncellemesi sırasında bir sorun oluştu.";
                
                showNotification("Hata", userMessage, "x-circle", "red");
            } finally {
                formLoading.classList.add('hidden');
            }
        };

        /**
         * İşi siler (Sadece Master/Admin).
         */
        const handleDeleteJob = async (docId) => {
             if (currentUserRole !== 'Admin' && currentUserRole !== 'Master') {
                showNotification("Yetkisiz Erişim", "Silme işlemini gerçekleştirmek için yetkiniz yok.", "lock", "red");
                return;
            }
            
            if (!confirm("Bu iş kaydını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.")) {
                return;
            }

            try {
                const jobDocRef = doc(db, 'jobs', docId);
                await deleteDoc(jobDocRef);
                showNotification("Başarılı", "İş kaydı silindi.", "trash-2", "red");
                router.navigate('#dashboard');
            } catch (error) {
                console.error("Silme Hatası:", error);
                showNotification("Hata", "Silme işlemi sırasında bir sorun oluştu.", "x-circle", "red");
            }
        };

        /**
         * Müşteri sipariş takip formunu işler ve detayları gösterir.
         */
        const handleCustomerTracking = async (e) => { 
            e.preventDefault();
            const orderCodeInput = document.getElementById('order-code-input');
            const orderCode = orderCodeInput.value.toUpperCase().trim();
            customerJobDetails.innerHTML = `<p class="mt-4 text-center text-indigo-600"><i data-lucide="loader" class="animate-spin w-4 h-4 inline-block mr-2"></i> Sorgulanıyor...</p>`;
            lucide.createIcons();

            if (!orderCode) {
                customerJobDetails.innerHTML = `<p class="mt-4 text-center text-red-500">Lütfen bir sipariş kodu girin.</p>`;
                return;
            }

            try {
                // orderCode'a göre sorgulama
                const q = query(collection(db, "jobs"), where("orderCode", "==", orderCode), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    customerJobDetails.innerHTML = `<div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 mt-4 rounded-lg">
                        <p class="font-bold">Sipariş Bulunamadı</p>
                        <p class="text-sm">Girdiğiniz koda ait aktif bir sipariş bulunamadı. Kodunuzu kontrol edin.</p>
                    </div>`;
                } else {
                    const jobDoc = querySnapshot.docs[0];
                    const job = jobDoc.data();
                    
                    // Geliştirilmiş Detay Render'ını çağır
                    renderCustomerJobDetails(job); 
                }
            } catch (error) {
                console.error("Sipariş Sorgulama Hatası:", error);
                customerJobDetails.innerHTML = `<p class="mt-4 text-center text-red-500">Sistem hatası oluştu. Lütfen tekrar deneyin.</p>`;
            }
            lucide.createIcons();
        };

        /**
         * Dashboard üzerindeki aksiyon butonlarını (Detay/Düzenle/Sil) işler.
         */
        const handleJobAction = (e) => {
            const button = e.target.closest('.job-action-button');
            if (!button) return;

            const docId = button.dataset.docId;
            const action = button.dataset.action;

            if (action === 'view') {
                // Detay göster (Şimdilik bildirim, detay sayfası entegrasyonu önerilir)
                showNotification("Detay", `İş Kod: ${docId} detayı açılacak. (Gerçek detay modalı/sayfası burada açılmalıdır)`, "eye", "indigo");
            } else if (action === 'edit') {
                // Düzenle formuna git 
                router.navigate(`#new-job?edit=${docId}`);
            } else if (action === 'delete') {
                handleDeleteJob(docId);
            }
        };


        /**
         * Dashboard'u gerçek zamanlı dinleyici ile günceller.
         */
        const setupRealTimeJobListener = () => {
            // Sadece jobs koleksiyonunu dinler
            const jobsColRef = collection(db, 'jobs');
            // Yeni işler en başta olacak şekilde sıralanabilir
            const q = query(jobsColRef);
            
            // onSnapshot ile gerçek zamanlı dinleme
            // Uyarı: Bu dinleyici, onAuthStateChanged içinde tanımlanmalıdır.
            onSnapshot(q, (snapshot) => {
                const jobList = document.getElementById('dashboard-job-list');
                if (!jobList) return; 

                globalJobData = []; 
                snapshot.docs.forEach(doc => {
                    globalJobData.push({ docId: doc.id, ...doc.data() });
                });

                // Yeniden sırala (Oluşturulma tarihine göre en yeni en başta)
                globalJobData.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                const jobCardsHtml = globalJobData.map(job => renderJobCard(job, job.docId)).join('');
                
                jobList.innerHTML = jobCardsHtml || `<p class="col-span-full text-center text-gray-500 mt-8">Henüz kayıtlı bir iş bulunmamaktadır.</p>`;
                
                // Event listener'ları yeniden bağla (Eski listener'ları kaldırma orijinal kodda yoktu, ancak burada performansı artırmak için önerilir)
                document.querySelectorAll('.job-action-button').forEach(button => {
                    // Mevcut listener'ı kaldırmak için klonlama yöntemi daha güvenlidir
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    newButton.addEventListener('click', handleJobAction); 
                });

                lucide.createIcons();
                showNotification("Güncelleme", "İş listesi gerçek zamanlı olarak güncellendi.", "refresh-cw", "indigo");
            }, (error) => {
                console.error("Realtime Dinleme Hatası:", error);
                showNotification("Hata", "İş listesi güncellenemedi. (Yetki hatası olabilir)", "x-circle", "red");
            });
        };


        // --- 4. AUTH VE ROL YÖNETİMİ ---

        /**
         * Rolleri Firebase'den çeker.
         */
        const fetchUserRole = async (uid) => {
            try {
                const roleDocRef = doc(db, 'userRoles', uid); 
                const docSnap = await getDoc(roleDocRef);
                return docSnap.exists() ? docSnap.data().role : null;
            } catch (error) {
                console.error("Rol Çekme Hatası:", error);
                return null;
            }
        };
        
        /**
         * E-posta ve Şifre ile Giriş İşlemi
         */
        const handleEmailPasswordLogin = async (e) => {
            e.preventDefault();
            loginErrorElement.classList.add('hidden');
            const email = loginIdentifierInput.value.trim();
            const password = document.getElementById('login-password').value;

            localStorage.setItem('lastIdentifier', email);
            if (!email || !password) {
                 loginErrorElement.textContent = 'Lütfen e-posta ve şifrenizi girin.';
                 loginErrorElement.classList.remove('hidden');
                 return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Giriş Hatası:", error);
                let errorMessage = 'Giriş Başarısız: Bilinmeyen bir hata oluştu.';
                
                switch (error.code) {
                    case 'auth/invalid-credential':
                    case 'auth/wrong-password':
                    case 'auth/user-not-found': 
                        errorMessage = 'Hatalı e-posta veya şifre. Lütfen bilgilerinizi kontrol edin.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Çok fazla deneme yapıldı. Lütfen daha sonra tekrar deneyin.';
                        break;
                    default:
                        errorMessage = 'Giriş Başarısız: Sistem hatası. Lütfen yönetici ile iletişime geçin.';
                        break;
                }

                loginErrorElement.textContent = errorMessage;
                loginErrorElement.classList.remove('hidden');
            }
        };

        /**
         * Çıkış İşlemi
         */
        const handleLogout = async () => {
            try {
                await signOut(auth);
                showNotification("Başarılı", "Başarıyla çıkış yapıldı.", "log-out", "red");
                window.location.hash = ''; // URL hash'ini temizle
            } catch (error) {
                console.error("Çıkış Hatası:", error);
                showNotification("Hata", "Çıkış yapılırken bir sorun oluştu.", "x-circle", "red");
            }
        };

        /**
         * Auth durumuna göre UI'ı günceller.
         */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserRole = await fetchUserRole(user.uid); 
                
                if (!currentUserRole || currentUserRole === 'none' || currentUserRole === 'Müşteri') {
                    
                    let errorMessage = `Hesabınıza bir personel rolü atanmamış (${user.email}). Lütfen yöneticinizle iletişime geçin.`;
                    
                    try {
                            await signOut(auth);
                    } catch (e) {
                        console.error("Çıkış hatası:", e);
                    }
                    
                    loginErrorElement.textContent = errorMessage;
                    loginErrorElement.classList.remove('hidden');
                    return; 
                }

                // Başarılı giriş ve rol kontrolü
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
                appContainer.classList.add('flex'); // hidden'ı kaldırmak için
                
                const emailDisplay = localStorage.getItem('lastIdentifier') || user.email;
                userInfoP.innerHTML = `Hoş Geldiniz, <span class="font-bold text-white">${currentUserRole} (${emailDisplay.split('@')[0]})</span>`;
                
                if (currentUserRole === 'Admin') {
                    adminLink.classList.remove('hidden');
                } else {
                    adminLink.classList.add('hidden');
                }
                
                // Dashboard'u dinlemeye başla
                setupRealTimeJobListener();
                router.navigate(window.location.hash);

            } else {
                // Oturum kapalı
                appContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                router.navigate('');
                currentUserRole = null;
                
                const lastIdentifier = localStorage.getItem('lastIdentifier');
                if (lastIdentifier) {
                    loginIdentifierInput.value = lastIdentifier;
                }
                
                switchAuthMode('staff');
            }
            lucide.createIcons();
        });


        // --- 5. ROUTER HANDLERS VE TEMPLATES ---
        
        // Dashboard Template ve Handler
        router.add('dashboard', `
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">İş Takip Panosu</h1>
            <div id="dashboard-job-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full text-center text-gray-500 mt-8">
                    <i data-lucide="loader" class="animate-spin w-6 h-6 inline-block mr-2"></i> İşler Yükleniyor...
                </div>
            </div>
        `, () => {
            // Dashboard'a girildiğinde ekstra işlem gerekmez, setupRealTimeJobListener zaten çalışıyor
        });

        // Yeni İş Ekle / Düzenle Template ve Handler
        router.add('new-job', `
            <h1 id="job-form-title" class="text-3xl font-extrabold text-indigo-700 mb-6 border-b pb-2">Yeni İş Kaydı Ekle</h1>
            
            <form id="job-entry-form" class="bg-white p-8 rounded-xl shadow-2xl space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="jobTitle" class="block text-sm font-medium text-gray-700 mb-1">İş/Sipariş Başlığı</label>
                        <input type="text" id="jobTitle" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="orderCode" class="block text-sm font-medium text-gray-700 mb-1">Benzersiz Sipariş Kodu</label>
                        <input type="text" id="orderCode" placeholder="Örn: ORD-2025-001" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 uppercase">
                    </div>
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Müşteri Adı / Firma</label>
                        <input type="text" id="customerName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                        <select id="status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option>Yeni Sipariş</option>
                            <option>Üretim Aşamasında</option>
                            <option>Kalite Kontrol</option>
                            <option>Teslim Edildi</option>
                            <option>İptal Edildi</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Açıklama / Detaylar</label>
                    <textarea id="description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <div id="current-images" class="p-3 bg-gray-100 rounded-lg hidden" data-current-url="">
                    <p class="text-sm font-medium text-gray-600 mb-1">Mevcut Ek Dosya: <span id="current-image-link" class="text-indigo-600 underline cursor-pointer"></span></p>
                </div>
                
                <div>
                    <label for="fileAttachment" class="block text-sm font-medium text-gray-700 mb-1">Ek Dosya / Görsel (Opsiyonel)</label>
                    <input type="file" id="fileAttachment" class="w-full border border-gray-300 rounded-lg p-2 bg-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition space-x-3">
                    <i data-lucide="save" class="w-6 h-6"></i>
                    <span id="form-submit-text">İşi Kaydet</span>
                </button>
                <p id="form-loading" class="text-center text-indigo-600 hidden mt-4">
                    <i data-lucide="loader" class="animate-spin w-4 h-4 inline-block mr-2"></i> Kaydediliyor ve Dosya Yükleniyor...
                </p>
            </form>
        `, async () => {
            // Düzenleme modunda formun doldurulması
            const form = document.getElementById('job-entry-form');
            form.removeEventListener('submit', handleJobFormSubmit);
            form.addEventListener('submit', handleJobFormSubmit);

            const params = new URLSearchParams(window.location.hash.split('?')[1]);
            const editDocId = params.get('edit');

            const jobFormTitle = document.getElementById('job-form-title');
            const formSubmitText = document.getElementById('form-submit-text');
            const currentImagesDiv = document.getElementById('current-images');
            const currentImageLink = document.getElementById('current-image-link');

            if (editDocId) {
                // Düzenleme Modu
                jobFormTitle.textContent = "İş Kaydını Düzenle";
                formSubmitText.textContent = "Güncelle";
                form.dataset.docId = editDocId;

                try {
                    const docSnap = await getDoc(doc(db, 'jobs', editDocId));
                    if (docSnap.exists()) {
                        const job = docSnap.data();
                        document.getElementById('jobTitle').value = job.jobTitle;
                        document.getElementById('orderCode').value = job.orderCode;
                        document.getElementById('customerName').value = job.customerName;
                        document.getElementById('status').value = job.status;
                        document.getElementById('description').value = job.description;

                        // Mevcut görseli göster
                        if (job.attachmentURL) {
                            currentImagesDiv.classList.remove('hidden');
                            currentImagesDiv.dataset.currentUrl = job.attachmentURL;
                            currentImageLink.textContent = `(${job.attachmentURL.split('%2F').pop().split('?')[0].substring(0, 30)}...)`;
                            currentImageLink.onclick = () => window.open(job.attachmentURL, '_blank');
                        } else {
                            currentImagesDiv.classList.add('hidden');
                            currentImagesDiv.dataset.currentUrl = '';
                        }

                    } else {
                        showNotification("Hata", "Düzenlenecek iş kaydı bulunamadı.", "x-circle", "red");
                        router.navigate('#dashboard');
                    }
                } catch (error) {
                    console.error("Düzenleme verisi çekme hatası:", error);
                    showNotification("Hata", "Veri çekilirken sorun oluştu.", "x-circle", "red");
                }

            } else {
                // Yeni Kayıt Modu
                jobFormTitle.textContent = "Yeni İş Kaydı Ekle";
                formSubmitText.textContent = "İşi Kaydet";
                form.reset();
                delete form.dataset.docId;
                currentImagesDiv.classList.add('hidden');
                currentImagesDiv.dataset.currentUrl = '';
            }
            lucide.createIcons();
        });


        // Admin Panel Template ve Handler (İçerik Geliştirilmelidir)
        router.add('admin-panel', `
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2"><i data-lucide="wrench" class="w-7 h-7 inline-block mr-2 text-red-500"></i> Admin Yönetim Paneli</h1>
            <div id="admin-content" class="p-6 bg-white rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-red-600">Personel ve Rol Yönetimi</h3>
                <p class="text-gray-600">Bu bölümde personel rollerini (Admin, Master, Worker) yönetebilir, yeni personel ekleyebilir veya mevcut personeli silebilirsiniz.</p>
                <div class="mt-4 p-4 bg-red-50 border-l-4 border-red-300 text-red-700">
                    <p class="font-bold">UYARI: Rollerin doğru çalışması için Firebase Güvenlik Kurallarınızda (Security Rules) rol kontrolü yapılmalıdır.</p>
                </div>
                
                </div>
        `, async () => {
             if (currentUserRole !== 'Admin') {
                contentArea.innerHTML = `<h1 class="text-3xl font-bold text-red-700">403 - Yetkisiz Erişim</h1><p class="text-gray-500 mt-2">Bu sayfaya sadece Admin erişebilir.</p>`;
                return;
            }
            // Admin paneli için özel veri çekme işlemleri burada başlar. 
            // Mevcut kodda hata veren kısım burasıydı.
            // Örn: Kullanıcı rollerini çekme
            try {
                // Örnek: userRoles koleksiyonundaki ilk 100 kullanıcıyı çek
                const usersQuery = query(collection(db, 'userRoles'), limit(100));
                const snapshot = await getDocs(usersQuery);
                // Burada snapshot.docs üzerinden kullanıcı listesi oluşturulur.
                // showNotification("Admin", `${snapshot.size} kullanıcı rolü çekildi.`, "users", "red");
            } catch (error) {
                 console.error("Admin Panel Veri Çekme Hatası:", error);
                 // Bu hata, büyük ihtimalle "Missing or insufficient permissions" olacaktır.
                 showNotification("Hata", "Admin panel verileri çekilemedi. Firebase Kurallarını kontrol edin.", "alert-triangle", "red");
            }

        });

        // Duyurular Template ve Handler (İçerik Geliştirilmelidir)
         router.add('announcements', `
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2"><i data-lucide="megaphone" class="w-7 h-7 inline-block mr-2 text-green-500"></i> Duyurular</h1>
            <div class="p-6 bg-white rounded-xl shadow-lg space-y-4">
                <div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg">
                    <h3 class="font-bold">Önemli Duyuru: Sistem Güncellemesi</h3>
                    <p class="text-sm">Planlanan yeni özellikler için 25 Kasım gecesi kısa süreli kesinti yaşanacaktır. Tüm personelin bilgisine.</p>
                </div>
                <p class="text-gray-500">Daha fazla duyuru burada listelenecektir...</p>
            </div>
        `, () => {
            // Duyuruların Firebase'den çekilmesi burada yer alabilir
        });


        // --- 6. İLK YÜKLEME VE EVENT LISTENERS ---

        // Buton click eventlerini bağla
        document.getElementById('show-staff-login').addEventListener('click', () => switchAuthMode('staff'));
        document.getElementById('show-customer-tracker').addEventListener('click', () => switchAuthMode('customer'));

        // YENİ EKLEME: Müşteri Sipariş Takip formunu dinlemeye başla
        document.getElementById('customer-order-form').addEventListener('submit', handleCustomerTracking);

        // Diğer form ve buton eventlerini bağla
        emailPasswordForm.addEventListener('submit', handleEmailPasswordLogin);
        logoutButton.addEventListener('click', handleLogout);

        // Router'ı dinlemeye başla
        window.addEventListener('hashchange', () => router.navigate(window.location.hash));
        window.addEventListener('load', () => router.navigate(window.location.hash)); 

        // İkonları ilk yüklemede oluştur
        lucide.createIcons();
    </script>
</body>
</html>
