<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erolpen Ä°ÅŸ Takip Sistemi - Yetkili EriÅŸim (GeliÅŸmiÅŸ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter font for modern look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Custom scrollbar for note sections */
        .max-h-40::-webkit-scrollbar {
            width: 4px;
        }
        .max-h-40::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
        .job-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: default;
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style for required file inputs */
        .file-input-label {
            display: block;
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            text-align: center;
            font-size: 0.875rem;
            line-height: 1.25rem;
            border: 1px solid #d1d5db;
        }
        .file-input:focus + .file-input-label {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); /* Indigo-600 focus ring */
        }
        .file-input:not(:placeholder-shown) + .file-input-label {
            background-color: #d1d5db;
            border-color: #9ca3af;
        }
    </style>
</head>
<body>
    <div id="app" class="w-full">
        </div>

    <script type="module">
        // SÄ°ZÄ°N EKLEDÄ°ÄžÄ°NÄ°Z SÄ°STEM YAPILANDIRMASI
        const FIXED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
            authDomain: "kibrissiparissistemi.firebaseapp.com",
            databaseURL: "https://kibrissiparissistemi-default-rtdb.firebaseio.com",
            projectId: "kibrissiparissistemi",
            storageBucket: "kibrissiparissistemi.firebasestorage.app",
            messagingSenderId: "263531733235",
            appId: "1:263531733235:web:82efdf39ed758a22465786",
            measurementId: "G-JK5S6L90Q5"
        };
        // ----------------------------------------------------------------

        // --- Firebase ModÃ¼l Ä°Ã§e AktarÄ±mlarÄ± (STORAGE EKLENDÄ°) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, Timestamp, query, getDoc, getDocs, setDoc, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; // EKLENDÄ°
        
        // Firebase loglarÄ±nÄ± aÃ§Ä±n (Hata ayÄ±klama iÃ§in Ã¶nemlidir)
        setLogLevel('Debug');
        
        // --- GLOBAL STATE ---
        let db = null;	
        let auth = null;	
        let storage = null; // EKLENDÄ°
        let user = null;	
        let isAuthReady = false;	
        let jobs = [];
        let notes = {};
        let announcements = []; // EKLENDÄ° (Duyuru/Bildirimler)
        let allMasters = {};	
        // NoAuth: GiriÅŸ Gerekli, Unauthorized: RolÃ¼ TanÄ±mlÄ± DeÄŸil (GiriÅŸ Yapamaz)
        let userRoleData = { role: 'Loading', name: 'YÃ¼kleniyor...' };	
        let loading = true;
        let showModal = false;
        let modalMessage = "";
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let isFirebaseInitialized = false;	
        let firebaseStatusText = "YÃ¼kleniyor...";


        // --- UTILITY FUNCTIONS ---
        const calculateWeightedProgress = (stages) => {
            let weightedSum = 0;
            let totalWeight = 0;
            stages.forEach(stage => {
                const progress = stage.progress || 0;
                const weight = stage.weight || 1;
                weightedSum += progress * weight;
                totalWeight += weight;
            });
            return totalWeight === 0 ? 0 : Math.round(weightedSum / totalWeight);
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            const time = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            const d = date.toLocaleDateString('tr-TR');
            return `${time} ${d}`;
        };

        const showNotification = (message) => {
            modalMessage = message;
            showModal = true;
            renderNotificationModal();
            setTimeout(() => {
                showModal = false;
                renderNotificationModal();
            }, 3000);
        };

        // EKLENDÄ°: Firebase Storage'a dosya yÃ¼kleme yardÄ±mcÄ± fonksiyonu
        const uploadFile = async (file, path) => {
            if (!storage || !file) return null;
            // Dosya adÄ±nÄ± gÃ¼venli hale getir
            const uniqueFileName = `${Date.now()}-${file.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase()}`;
            const fileRef = storageRef(storage, `${path}/${uniqueFileName}`);
            const snapshot = await uploadBytes(fileRef, file);
            return await getDownloadURL(snapshot.ref);
        };
        
        // EKLENDÄ°: Dosya tÃ¼rÃ¼ne gÃ¶re uygun simge HTML'i dÃ¶ner
        const getFileIcon = (url) => {
            if (!url) return '';
            const isImage = /\.(jpe?g|png|gif)$/i.test(url);
            const isVideo = /\.(mp4|mov|webm)$/i.test(url);
            const isPdf = /\.pdf$/i.test(url);

            if (isImage) return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-500 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> Resim DosyasÄ±';
            if (isVideo) return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.682v6.636a1 1 0 01-1.447.81L15 14M4 14V8a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2z" /></svg> Video DosyasÄ±';
            if (isPdf) return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg> PDF DosyasÄ±';
            return '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414a1 1 0 00-.707-.293H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg> Dosya';
        }
        
        // --- FIREBASE INITIALIZATION & AUTH ---
        const handleGoogleSignIn = async () => {
            // ... (AynÄ± kaldÄ±) ...
            if (!auth || !isFirebaseInitialized) {
                showNotification("HATA: Firebase Auth servisi baÅŸlatÄ±lamadÄ±.");
                return;
            }
            
            const provider = new GoogleAuthProvider();
            provider.addScope('profile');
            provider.addScope('email');

            try {
                loading = true;
                renderApp(); 
                
                await signInWithPopup(auth, provider);
            } catch (error) {
                loading = false;
                renderApp(); 
                console.error("Google GiriÅŸ HatasÄ±:", error);
                
                if (error.code === 'auth/popup-closed-by-user') {
                    showNotification("GiriÅŸ penceresi kullanÄ±cÄ± tarafÄ±ndan kapatÄ±ldÄ±.");
                } else if (error.code === 'auth/unauthorized-domain') {
                    showNotification("HATA: Firebase Auth Domain ayarlarÄ±nÄ±zÄ± kontrol edin.");
                } else {
                    showNotification(`GiriÅŸ sÄ±rasÄ±nda hata oluÅŸtu: ${error.message}`);
                }
            }
        };

        const initializeFirebase = () => {
            try {
                let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    firebaseConfig = FIXED_FIREBASE_CONFIG;
                    console.warn("Ortam config'i yerine sabit (FIXED_FIREBASE_CONFIG) kullanÄ±lÄ±yor.");
                    firebaseStatusText = "Sabit Config ile BaÅŸlatÄ±ldÄ±";
                } else {
                    firebaseStatusText = "Canvas Config ile BaÅŸlatÄ±ldÄ±";
                }
                
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    console.error("Firebase config bulunamadÄ±. Uygulama sadece statik olarak yÃ¼klenecek.");
                    loading = false;
                    isFirebaseInitialized = false;
                    user = null;
                    isAuthReady = true;
                    userRoleData = { role: 'NoAuth', name: 'GiriÅŸ Gerekli' };
                    firebaseStatusText = "Firebase BAÄžLI DEÄžÄ°L!";
                    renderApp();	
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app); // EKLENDÄ°
                isFirebaseInitialized = true;

                onAuthStateChanged(auth, async (currentUser) => {
                    loading = true;
                    if (currentUser) {
                        user = currentUser;
                        
                        // 1. KullanÄ±cÄ±nÄ±n rol belgesini kontrol et
                        const roleDocRef = doc(db, `artifacts/${APP_ID}/public/data/user_permissions`, user.uid);
                        const roleDoc = await getDoc(roleDocRef);
                        
                        // --- YETKÄ° KONTROLÃœ (Admin TarafÄ±ndan TanÄ±mlanmÄ±ÅŸ Hesap KontrolÃ¼) ---
                        if (roleDoc.exists()) {
                            userRoleData = roleDoc.data();
                            console.log(`KullanÄ±cÄ± rolÃ¼ yÃ¼klendi: ${userRoleData.role}`);
                        } else {
                            // Rol tanÄ±mlÄ± deÄŸilse, Admin sayÄ±sÄ±nÄ± kontrol et (Ä°lk Admin atama mantÄ±ÄŸÄ±)
                            const permissionsColRef = collection(db, `artifacts/${APP_ID}/public/data/user_permissions`);
                            const adminQuery = query(permissionsColRef, where("role", "==", "Admin"));
                            const adminSnapshot = await getDocs(adminQuery);

                            if (adminSnapshot.empty) {
                                // Admin yoksa, ilk Google kullanÄ±cÄ±sÄ±na Admin rolÃ¼ ver ve kaydet
                                userRoleData = {	
                                    role: 'Admin',	
                                    name: user.displayName || user.email.split('@')[0] || 'Patron', 
                                    uid: user.uid
                                };
                                await setDoc(roleDocRef, userRoleData);
                                showNotification("Sistemin ilk kullanÄ±cÄ±sÄ± olarak Admin yetkisi atandÄ±.");
                            } else {
                                // Admin varsa, rolÃ¼ tanÄ±mlÄ± olmayan bu Google kullanÄ±cÄ±sÄ± YETKÄ°SÄ°ZDÄ°R.
                                await signOut(auth); // KÄ±sÄ±tlÄ± hesabÄ± hemen Ã§Ä±kar
                                user = null;
                                userRoleData = { role: 'Unauthorized', name: 'Yetkisiz KullanÄ±cÄ±' };
                                showNotification("HATA: HesabÄ±nÄ±z sisteme Admin tarafÄ±ndan tanÄ±mlanmamÄ±ÅŸtÄ±r. EriÅŸim engellendi.");
                                console.error("Yetkisiz kullanÄ±cÄ± giriÅŸi engellendi:", currentUser.email);
                            }
                        }
                    } else {
                        // Ã‡Ä±kÄ±ÅŸ yapÄ±lmÄ±ÅŸ veya hiÃ§ giriÅŸ yapÄ±lmamÄ±ÅŸsa
                        user = null;	
                        userRoleData = { role: 'NoAuth', name: 'GiriÅŸ Gerekli' };
                        console.log("KullanÄ±cÄ± oturumu aÃ§Ä±lmadÄ±.");
                    }
                    
                    loading = false;
                    isAuthReady = true;
                    if (isFirebaseInitialized && user && userRoleData.role !== 'Unauthorized') {
                        setupFirestoreListeners();
                    } else {
                        jobs = [];	
                        notes = {};
                        announcements = [];
                        allMasters = {};
                    }
                    renderApp();
                });
                
            } catch (error) {
                console.error("Firebase BaÅŸlatma hatasÄ±:", error);
                loading = false;
                isFirebaseInitialized = false;
                user = null;
                isAuthReady = true;
                userRoleData = { role: 'NoAuth', name: 'GiriÅŸ Gerekli' };
                firebaseStatusText = "Firebase BaÅŸlatma HatasÄ±";
                renderApp();
            }
        };

        // --- FIREBASE LISTENERS (Real-Time Data Fetching) ---
        const setupFirestoreListeners = () => {
            if (!db || !isAuthReady || userRoleData.role === 'Loading' || !user) return;

            const jobsColRef = collection(db, `artifacts/${APP_ID}/public/data/jobs`);
            const notesColRef = collection(db, `artifacts/${APP_ID}/public/data/notes`);
            const permissionsColRef = collection(db, `artifacts/${APP_ID}/public/data/user_permissions`);
            const announcementsColRef = collection(db, `artifacts/${APP_ID}/public/data/announcements`); // EKLENDÄ°

            // 1. Ä°zinleri Dinle (TÃ¼m Master'larÄ± listelemek iÃ§in)
            onSnapshot(query(permissionsColRef), (snapshot) => {
                const masters = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.role === 'Master' || data.role === 'Admin') {
                        masters[doc.id] = data;
                    }
                });
                allMasters = masters;
                renderApp();
            }, (error) => console.error("Permissions listener error:", error));

            // 2. Ä°ÅŸleri Dinle (Jobs)
            const jobQuery = userRoleData.role === 'Master'	
                ? query(jobsColRef, where("masters", "array-contains", user.uid)) // Master ise sadece kendine ait iÅŸleri getir
                : query(jobsColRef); // Admin ise tÃ¼m iÅŸleri getir

            onSnapshot(jobQuery, (snapshot) => {
                let fetchedJobs = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const mastersArray = Array.isArray(data.masters) ? data.masters : [];	
                    return {
                        ...data,
                        id: doc.id,
                        masters: mastersArray,	
                        totalProgress: calculateWeightedProgress(data.stages || []),
                    };
                }).sort((a, b) => {
                    // TamamlananlarÄ± sona at
                    if (a.totalProgress === 100 && b.totalProgress !== 100) return 1;
                    if (a.totalProgress !== 100 && b.totalProgress === 100) return -1;
                    // KalÄ±nan yerden devam edenleri Ã¶nce getir
                    if (a.totalProgress > 0 && a.totalProgress < 100 && b.totalProgress === 0) return -1;
                    if (a.totalProgress === 0 && b.totalProgress > 0 && b.totalProgress < 100) return 1;

                    return a.name.localeCompare(b.name); // Alfabetik sÄ±ralama
                });
                
                jobs = fetchedJobs;
                renderApp();
            }, (error) => console.error("Jobs listener error:", error));


            // 3. NotlarÄ± Dinle (Notes)
            onSnapshot(query(notesColRef), (snapshot) => {
                const allNotes = {};
                snapshot.docs.forEach(doc => {
                    const note = doc.data();
                    if (!allNotes[note.jobKey]) {
                        allNotes[note.jobKey] = [];
                    }
                    allNotes[note.jobKey].push(note);
                });

                for (const jobKey in allNotes) {
                    allNotes[jobKey].sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                }
                notes = allNotes;
                renderApp();
            }, (error) => console.error("Notes listener error:", error));

            // 4. DuyurularÄ± Dinle (Announcements/Notifications) - EKLENDÄ°
            const announcementQuery = userRoleData.role === 'Master'	
                ? query(announcementsColRef, 
                        where("targetUsers", "in", [user.uid, 'All']), 
                        orderBy("timestamp", "desc"))
                : query(announcementsColRef, orderBy("timestamp", "desc"));

            onSnapshot(query(announcementsColRef, orderBy("timestamp", "desc")), (snapshot) => {
                let fetchedAnnouncements = snapshot.docs.map(doc => ({
                    ...doc.data(),
                    id: doc.id,
                    timestamp: doc.data().timestamp || Timestamp.fromDate(new Date())
                })).filter(ann => {
                    // Master ise sadece All veya kendi UID'sini iÃ§erenleri gÃ¶ster
                    if (userRoleData.role === 'Master') {
                        const target = ann.targetUsers;
                        if (Array.isArray(target)) {
                            return target.includes(user.uid);
                        }
                        return target === 'All';
                    }
                    return true; // Admin tÃ¼mÃ¼nÃ¼ gÃ¶rÃ¼r
                });
                
                // Sadece son 10 bildirimi tutalÄ±m, performans iÃ§in
                announcements = fetchedAnnouncements.slice(0, 10); 
                renderApp();
            }, (error) => console.error("Announcements listener error:", error));
        };

        // --- JOB/NOTE/ROLE MANIPULATION METHODS ---

        const handleLogout = async () => {
             // ... (AynÄ± kaldÄ±) ...
             if (auth) {
                try {
                    userRoleData = { role: 'Loading', name: 'YÃ¼kleniyor...' };
                    await signOut(auth);
                } catch (error) {
                    console.error("Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken hata:", error);
                    showNotification("Ã‡Ä±kÄ±ÅŸ sÄ±rasÄ±nda hata oluÅŸtu. Konsolu kontrol edin.");
                }
            }
        };

        const handleAssignRole = async (e) => {
            // ... (AynÄ± kaldÄ±) ...
            e.preventDefault();
            if (userRoleData.role !== 'Admin' || !db || !isFirebaseInitialized) {
                showNotification("HATA: Sadece Admin rol atayabilir.");
                return;
            }

            const form = e.target;
            const targetUID = form.targetUID.value.trim();
            const targetRole = form.targetRole.value;
            const targetName = form.targetName.value.trim() || `${targetRole} KullanÄ±cÄ±`;

            if (!targetUID) {
                showNotification("HATA: GeÃ§erli bir KullanÄ±cÄ± UID'si girin.");
                return;
            }

            if (user && targetUID === user.uid && targetRole !== userRoleData.role) {
                showNotification("UYARI: Kendi rolÃ¼nÃ¼zÃ¼ ancak aynÄ± rolle gÃ¼ncelleyebilirsiniz.");
            }

            const roleDocRef = doc(db, `artifacts/${APP_ID}/public/data/user_permissions`, targetUID);
            const newRoleData = {
                role: targetRole,
                name: targetName,
                uid: targetUID
            };

            try {
                await setDoc(roleDocRef, newRoleData);
                showNotification(`UID: ${targetUID.substring(0, 5)}... kullanÄ±cÄ±sÄ±na ${targetName} (${targetRole}) rolÃ¼ baÅŸarÄ±yla atandÄ±.`);
                form.reset();
            } catch (error) {
                console.error("Firestore'a rol atarken hata:", error);
                showNotification(`Hata: Rol atanamadÄ±. Firestore KurallarÄ±nÄ±zÄ± kontrol edin! (Console'da detay)`);
            }
        };

        // GÃœNCELLENDÄ°: MÃ¼ÅŸteri bilgileri ve proje dosyasÄ± eklendi
        const handleAddJob = async (e) => {
            e.preventDefault();
            if (userRoleData.role !== 'Admin' || !db || !isFirebaseInitialized) {
                showNotification("HATA: Sadece Admin iÅŸ ekleyebilir.");
                return;
            }

            const form = e.target;
            const name = form.jobName.value;
            
            // --- YENÄ° MÃœÅžTERÄ° ALANLARI ---
            const customerName = form.customerName.value.trim();
            const phone = form.phone.value.trim();
            const address = form.address.value.trim();
            const deliveryDate = form.deliveryDate.value;
            const projectFile = form.projectFile.files[0];
            // -----------------------------

            const stagesInput = form.jobStages.value.split(',').map(s => s.trim()).filter(s => s);
            const assignedMastersElement = form.assignedMasters;
            const selectedMasterUIDs = assignedMastersElement ? Array.from(assignedMastersElement.options)
                                            .filter(option => option.selected)
                                            .map(option => option.value) : [];


            if (selectedMasterUIDs.length === 0) {
                showNotification("HATA: LÃ¼tfen en az bir usta atayÄ±n.");
                return;
            }

            if (!customerName || !deliveryDate) {
                showNotification("HATA: MÃ¼ÅŸteri AdÄ± ve Teslim Tarihi boÅŸ bÄ±rakÄ±lamaz.");
                return;
            }

            // 1. Proje DosyasÄ±nÄ± YÃ¼kle (varsa)
            let projectFileUrl = null;
            if (projectFile) {
                try {
                    showNotification("Proje dosyasÄ± yÃ¼kleniyor...");
                    projectFileUrl = await uploadFile(projectFile, 'job_projects');
                } catch (error) {
                    showNotification("HATA: Dosya yÃ¼klenemedi. Storage izinlerini kontrol edin.");
                    console.error("Storage Hata:", error);
                    return;
                }
            }


            const stages = stagesInput.map(item => {
                const parts = item.split(':');
                const stageName = parts[0];
                const weight = parseInt(parts[1]) || 1;
                return { name: stageName, progress: 0, weight: weight };
            });

            const newJob = {
                name: name,
                stages: stages,
                masters: selectedMasterUIDs, // Atanan Master UID'leri
                
                // --- YENÄ° ALANLAR ---
                customerName: customerName,
                phone: phone,
                address: address,
                deliveryDate: deliveryDate,
                projectFileUrl: projectFileUrl,
                // ---------------------

                createdBy: user.uid,
                createdByName: userRoleData.name,
                createdAt: Timestamp.fromDate(new Date())
            };

            try {
                const jobsColRef = collection(db, `artifacts/${APP_ID}/public/data/jobs`);
                const docRef = await addDoc(jobsColRef, newJob);

                // --- YENÄ°: Universal Bildirim (Yeni Ä°ÅŸ Eklendi) ---
                const notificationColRef = collection(db, `artifacts/${APP_ID}/public/data/announcements`);
                await addDoc(notificationColRef, {
                    type: 'NewJob',
                    content: `${userRoleData.name}, yeni bir iÅŸ ekledi: ${name} (${customerName}).`,
                    targetUsers: 'All', // Herkese
                    timestamp: Timestamp.fromDate(new Date()),
                    jobId: docRef.id
                });
                // ---------------------------------------------

                showNotification("Yeni Ä°ÅŸ BaÅŸarÄ±yla Eklendi ve TÃ¼m KullanÄ±cÄ±lara Bildirildi!");
                form.reset();
                form.jobStages.value = "Kesim:2,Bantlama:1,Montaj:5,Cila:2";
            } catch (error) {
                console.error("Firestore'a iÅŸ eklerken hata:", error);
                showNotification(`Hata: Ä°ÅŸ eklenemedi. Firestore KurallarÄ±nÄ±zÄ± kontrol edin! (Console'da detay)`);
            }
        };

        // GÃœNCELLENDÄ°: Ä°lerleme %100 olduÄŸunda bildirim eklendi
        const handleUpdateStageProgress = async (jobId, stageIndex, newProgress) => {
            if (userRoleData.role === 'NoAuth' || userRoleData.role === 'Unauthorized' || !db || !isFirebaseInitialized) {
                showNotification("HATA: Ä°lerleme gÃ¼ncellemek iÃ§in yetkiniz yok.");
                return;
            }

            const jobToUpdate = jobs.find(j => j.id === jobId);
            if (!jobToUpdate) return;
            
            if (userRoleData.role === 'Master' && !jobToUpdate.masters.includes(user.uid)) {
                showNotification("HATA: Sadece size atanan iÅŸin ilerlemesini gÃ¼ncelleyebilirsiniz.");
                return;
            }

            const progressValue = Math.max(0, Math.min(100, parseInt(newProgress) || 0));
            if (jobToUpdate.stages[stageIndex].progress === progressValue) return;	

            const newStages = [...jobToUpdate.stages];
            newStages[stageIndex].progress = progressValue;

            try {
                const jobDocRef = doc(db, `artifacts/${APP_ID}/public/data/jobs`, jobId);
                await updateDoc(jobDocRef, {
                    stages: newStages,
                    totalProgress: calculateWeightedProgress(newStages),
                    lastUpdatedBy: user.uid,
                    lastUpdatedAt: Timestamp.fromDate(new Date())
                });
                
                // --- YENÄ°: %100 Tamamlanma Bildirimi ---
                const currentProgress = jobToUpdate.stages[stageIndex].progress;
                if (progressValue === 100 && currentProgress < 100) {
                    const notificationColRef = collection(db, `artifacts/${APP_ID}/public/data/announcements`);
                    await addDoc(notificationColRef, {
                        type: 'ProgressComplete',
                        content: `${userRoleData.name}, ${jobToUpdate.name} iÅŸinin ${jobToUpdate.stages[stageIndex].name} aÅŸamasÄ±nÄ± TAMAMLADI!`,
                        targetUsers: 'All',
                        timestamp: Timestamp.fromDate(new Date()),
                        jobId: jobId
                    });
                    showNotification(`${jobToUpdate.stages[stageIndex].name} aÅŸamasÄ± tamamlandÄ± ve duyuruldu.`);
                }
                // ------------------------------------

            } catch (error) {
                console.error("Ä°lerleme gÃ¼ncellenirken hata:", error);
                showNotification(`Hata: Ä°lerleme gÃ¼ncellenemedi. Ä°zinleri kontrol edin.`);
            }
        };

        // GÃœNCELLENDÄ°: Dosya yÃ¼kleme ve etiketleme (tagging) eklendi
        const handleAddNote = async (e) => {
            e.preventDefault();
            const form = e.target;
            const jobId = form.getAttribute('data-job-id');
            const noteContent = form.noteContent.value;
            const noteFile = form.noteFile.files[0];

            if (!noteContent.trim() && !noteFile) {
                showNotification("HATA: Not eklemek iÃ§in iÃ§erik veya dosya eklenmesi gerekli.");
                return;
            }

            if (userRoleData.role === 'NoAuth' || userRoleData.role === 'Unauthorized' || !db || !isFirebaseInitialized) {
                showNotification("HATA: Not eklemek iÃ§in yetkiniz yok veya Firebase baÄŸlantÄ±sÄ± gerekli.");
                return;
            }
            
            const jobToUpdate = jobs.find(j => j.id === jobId);
            if (!jobToUpdate) return;

            if (userRoleData.role === 'Master' && !jobToUpdate.masters.includes(user.uid)) {
                showNotification("HATA: Sadece size atanan iÅŸe not ekleyebilirsiniz.");
                return;
            }

            // 1. Not DosyasÄ±nÄ± YÃ¼kle (varsa)
            let noteFileUrl = null;
            if (noteFile) {
                try {
                    showNotification("Not dosyasÄ± yÃ¼kleniyor...");
                    noteFileUrl = await uploadFile(noteFile, `job_notes/${jobId}`);
                } catch (error) {
                    showNotification("HATA: Dosya yÃ¼klenemedi. Storage izinlerini kontrol edin.");
                    console.error("Storage Hata:", error);
                    return;
                }
            }

            // 2. Etiketleme (Tagging) MantÄ±ÄŸÄ±
            const taggedMasterUids = [];
            const taggedMasters = [];
            const masterNames = Object.values(allMasters).map(m => m.name.replace(/\s/g, ''));
            
            Object.values(allMasters).forEach(master => {
                const masterTag = `@${master.name.replace(/\s/g, '')}`; // Ã–rn: @AhmetUsta
                if (noteContent.replace(/\s/g, '').includes(masterTag)) {
                    taggedMasters.push(master.name);
                    taggedMasterUids.push(master.uid);
                }
            });
            
            // 3. Notu Kaydet
            const newNote = {
                jobKey: jobId,
                content: noteContent,
                master: userRoleData.name,
                masterUID: user.uid,
                noteFileUrl: noteFileUrl, // YENÄ°
                taggedMasterUids: taggedMasterUids, // YENÄ°
                timestamp: Timestamp.fromDate(new Date())
            };

            try {
                const notesColRef = collection(db, `artifacts/${APP_ID}/public/data/notes`);
                await addDoc(notesColRef, newNote);

                // --- YENÄ°: Not Bildirimi (Etiketlenenlere veya Herkese) ---
                const notificationColRef = collection(db, `artifacts/${APP_ID}/public/data/announcements`);
                let tagText = taggedMasters.length > 0 ? ` (@${taggedMasters.join(', @')})` : '';
                
                await addDoc(notificationColRef, {
                    type: 'NewNote',
                    content: `${userRoleData.name}, ${jobToUpdate.name} iÅŸine yeni bir not/dosya ekledi${tagText}.`,
                    targetUsers: taggedMasterUids.length > 0 ? taggedMasterUids : 'All', // Etiketlenenlere veya Herkese
                    timestamp: Timestamp.fromDate(new Date()),
                    jobId: jobId
                });
                // ---------------------------------------------
                
                showNotification(`Ä°ÅŸ ${jobId.substring(0, 5)} iÃ§in yeni not ve bildirim gÃ¶nderildi.`);
                form.reset();
            } catch (error) {
                console.error("Not eklenirken hata:", error);
                showNotification(`Hata: Not eklenemedi. Ä°zinleri kontrol edin. (Console'da detay)`);
            }
        };


        // EKLENDÄ°: Admin Duyuru Ekleme Fonksiyonu
        const handleAddAnnouncement = async (e) => {
            e.preventDefault();
            if (userRoleData.role !== 'Admin' || !db || !isFirebaseInitialized) {
                showNotification("HATA: Sadece Admin duyuru yapabilir.");
                return;
            }

            const form = e.target;
            const content = form.announcementContent.value.trim();
            const announcementFile = form.announcementFile.files[0];

            if (!content && !announcementFile) {
                showNotification("HATA: Duyuru iÃ§eriÄŸi veya dosya eklenmelidir.");
                return;
            }

            // 1. DosyayÄ± YÃ¼kle (varsa)
            let announcementFileUrl = null;
            if (announcementFile) {
                try {
                    showNotification("Duyuru dosyasÄ± yÃ¼kleniyor...");
                    announcementFileUrl = await uploadFile(announcementFile, 'admin_announcements');
                } catch (error) {
                    showNotification("HATA: Dosya yÃ¼klenemedi. Storage izinlerini kontrol edin.");
                    console.error("Storage Hata:", error);
                    return;
                }
            }

            const newAnnouncement = {
                type: 'AdminAnnouncement',
                content: content,
                fileUrl: announcementFileUrl,
                targetUsers: 'All',
                master: userRoleData.name,
                masterUID: user.uid,
                timestamp: Timestamp.fromDate(new Date())
            };

            try {
                const notificationColRef = collection(db, `artifacts/${APP_ID}/public/data/announcements`);
                await addDoc(notificationColRef, newAnnouncement);
                showNotification("Genel Duyuru BaÅŸarÄ±yla YayÄ±nlandÄ±!");
                form.reset();
            } catch (error) {
                console.error("Duyuru eklenirken hata:", error);
                showNotification(`Hata: Duyuru eklenemedi. Ä°zinleri kontrol edin.`);
            }
        };


        // --- RENDERING FUNCTIONS (Vanilla JS) ---

        const renderNotificationModal = () => {
            // ... (AynÄ± kaldÄ±) ...
            let modalElement = document.getElementById('notification-modal');
            if (!modalElement) {
                modalElement = document.createElement('div');
                modalElement.id = 'notification-modal';
                document.body.appendChild(modalElement);
            }

            modalElement.className = `fixed inset-0 z-50 flex items-start justify-center p-6 transition-opacity duration-300 ${showModal ? 'opacity-100' : 'opacity-0 pointer-events-none'}`;
            modalElement.innerHTML = `
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-xl font-semibold text-center pointer-events-auto">
                    <span>${modalMessage}</span>
                </div>
            `;
        };

        // GÃœNCELLENDÄ°: MÃ¼ÅŸteri bilgileri ve proje dosyasÄ± eklendi
        const createPatronJobCard = (job) => {
            const jobNotes = notes[job.id] || [];
            const isComplete = job.totalProgress === 100;
            
            const assignedMasterNames = job.masters.map(uid => allMasters[uid]?.name || `Bilinmeyen Usta (${uid.substring(0, 4)}...)`).join(', ');

            const stagesHtml = job.stages.map((stage, index) => `
                <li class="flex justify-between items-center ${stage.progress === 100 ? 'text-green-600 font-medium' : 'text-gray-600'}">
                    <span>${stage.name} (AÄŸÄ±rlÄ±k: ${stage.weight || 1})</span>
                    <strong class="text-lg">${stage.progress || 0}%</strong>
                </li>
            `).join('');

            // EKLENDÄ°: Proje DosyasÄ± ve MÃ¼ÅŸteri Bilgileri
            const projectFileHtml = job.projectFileUrl ? `
                <p class="mt-2 text-sm">
                    <a href="${job.projectFileUrl}" target="_blank" class="text-indigo-500 hover:text-indigo-700 font-medium break-all underline">
                        ${getFileIcon(job.projectFileUrl)} Proje DosyasÄ±nÄ± GÃ¶rÃ¼ntÃ¼le
                    </a>
                </p>
            ` : '';

            const notesHtml = jobNotes.length > 0 ? jobNotes.map((note, index) => `
                <div class="p-2 text-xs rounded bg-gray-100 mt-1 border border-gray-200">
                    <span class="font-bold text-indigo-500">${note.master}</span>: <span>${note.content}</span>
                    ${note.noteFileUrl ? `
                        <p class="mt-1 text-xs">
                            <a href="${note.noteFileUrl}" target="_blank" class="text-blue-500 hover:text-blue-700 font-medium underline">
                                ${getFileIcon(note.noteFileUrl)} Ekli DosyayÄ± GÃ¶r
                            </a>
                        </p>
                    ` : ''}
                    <span class="text-gray-400 ml-2 float-right">${formatTimestamp(note.timestamp)}</span>
                </div>
            `).join('') : '<p class="text-gray-500 italic text-xs">Bu iÅŸe ait henÃ¼z bir not yok.</p>';

            return `
                <div class="job-card p-4 border-l-4 rounded-lg shadow-md ${isComplete ? 'border-green-500 bg-white' : 'border-gray-300 bg-white'}" id="patron-card-${job.id}">
                    <h3 class="text-xl font-bold ${isComplete ? 'text-green-600' : 'text-indigo-600'}">${job.name}</h3>
                    <p class="text-sm text-gray-500 mb-2">Atanan Ustalar: <strong class="font-medium">${assignedMasterNames}</strong></p>
                    
                    <div class="p-3 my-2 bg-indigo-50 rounded-md border border-indigo-200">
                        <h4 class="text-sm font-bold text-indigo-700 mb-1">MÃ¼ÅŸteri Bilgileri:</h4>
                        <p class="text-xs text-gray-700">Ad: <strong>${job.customerName}</strong> | Tel: ${job.phone || 'N/A'} | Teslim Tarihi: <strong>${job.deliveryDate || 'N/A'}</strong></p>
                        <p class="text-xs text-gray-700">Adres: ${job.address || 'N/A'}</p>
                        ${projectFileHtml}
                    </div>

                    <div class="mt-3">
                        <p class="text-sm font-semibold">Genel Ä°lerleme (AÄŸÄ±rlÄ±klÄ±): <span class="${isComplete ? 'text-green-700' : 'text-gray-700'}">${job.totalProgress}%</span></p>
                        <div class="progress-bar-container w-full h-3 bg-gray-200 rounded-full overflow-hidden mt-1">
                            <div class="progress-bar h-full text-xs text-white flex items-center justify-center transition-all duration-500	
                                ${isComplete ? 'bg-green-500' : (job.totalProgress > 50 ? 'bg-yellow-500' : 'bg-red-500')}"	
                                style="width: ${job.totalProgress}%">
                                ${job.totalProgress > 10 ? `${job.totalProgress}%` : ''}
                            </div>
                        </div>
                    </div>

                    <details class="mt-4 text-sm text-gray-600">
                        <summary class="cursor-pointer font-medium hover:text-indigo-500">
                            AÅŸama DetaylarÄ± ve Notlar (${jobNotes.length} Not)
                        </summary>
                        <ul class="ml-2 mt-2 space-y-1 list-none p-0">
                            ${stagesHtml}
                        </ul>
                        <h4 class="font-semibold text-sm mt-3 border-t pt-2 text-indigo-700">Ä°ÅŸ NotlarÄ±:</h4>
                        <div class="space-y-1 max-h-40 overflow-y-auto pr-2">
                            ${notesHtml}
                        </div>
                    </details>
                </div>
            `;
        };
        
        // GÃœNCELLENDÄ°: Not formuna dosya ve etiketleme (tagging) eklendi
        const createMasterJobCard = (job) => {
            const jobNotes = notes[job.id] || [];
            const isAuthorized = job.masters.includes(user.uid) || userRoleData.role === 'Admin';	
            
            // YENÄ°: MÃ¼ÅŸteri Bilgileri
            const customerDetailsHtml = `
                <div class="p-2 my-2 bg-indigo-50 rounded-md border border-indigo-200">
                    <h4 class="text-sm font-bold text-indigo-700 mb-1">MÃ¼ÅŸteri: ${job.customerName}</h4>
                    <p class="text-xs text-gray-700">Tel: ${job.phone || 'N/A'} | Teslim Tarihi: <strong>${job.deliveryDate || 'N/A'}</strong></p>
                </div>
            `;

            const stagesHtml = job.stages.map((stage, index) => `
                <div class="flex items-center space-x-3">
                    <label class="flex-grow text-sm font-medium text-gray-700">
                        <span>${stage.name}</span> (AÄŸÄ±rlÄ±k: ${stage.weight || 1}):
                    </label>
                    <input type="number"	
                        data-job-id="${job.id}"
                        data-stage-index="${index}"
                        value="${stage.progress || 0}"
                        min="0" max="100"	
                        class="progress-input w-20 p-2 border border-gray-300 rounded-md text-right focus:ring-yellow-500 focus:border-yellow-500 text-sm"
                        ${!isFirebaseInitialized || !isAuthorized ? 'disabled' : ''}
                    />
                    <span class="font-semibold text-gray-600">%</span>
                </div>
            `).join('');

            const notesHtml = jobNotes.length > 0 ? jobNotes.map((note, index) => `
                <div class="p-2 text-xs rounded bg-gray-100 mt-1 border border-gray-200">
                    <span class="font-bold text-indigo-500">${note.master}</span>: <span>${note.content}</span>
                    ${note.noteFileUrl ? `
                        <p class="mt-1 text-xs">
                            <a href="${note.noteFileUrl}" target="_blank" class="text-blue-500 hover:text-blue-700 font-medium underline">
                                ${getFileIcon(note.noteFileUrl)} Ekli DosyayÄ± GÃ¶r
                            </a>
                        </p>
                    ` : ''}
                    <span class="text-gray-400 ml-2 float-right">${formatTimestamp(note.timestamp)}</span>
                </div>
            `).join('') : '<p class="text-gray-500 italic text-xs">Bu iÅŸe ait henÃ¼z bir not yok.</p>';
            
            const masterName = userRoleData.name || 'Usta';

            return `
                <div class="job-card p-4 border-l-4 border-yellow-500 bg-white rounded-lg shadow-md" id="master-card-${job.id}">
                    <h3 class="text-xl font-bold text-yellow-700">${job.name}</h3>
                    ${customerDetailsHtml}
                    <p class="text-sm text-gray-500 mb-4">Genel Ä°lerleme (AÄŸÄ±rlÄ±klÄ±): <strong>${job.totalProgress}%</strong></p>
                    
                    <div class="space-y-3 mb-6 border-b pb-4">
                        <h4 class="font-semibold text-gray-700 border-b pb-1">AÅŸama Ä°lerlemeni Gir:</h4>
                        ${isAuthorized ? stagesHtml : '<p class="text-red-500 text-sm">Bu iÅŸ size atanmamÄ±ÅŸtÄ±r, ilerleme gÃ¼ncelleyemezsiniz.</p>'}
                        ${!isFirebaseInitialized ? '<p class="text-red-500 text-xs pt-2">Firebase BAÄžLI DEÄžÄ°L. Ä°lerleme gÃ¼ncellenemez.</p>' : ''}
                    </div>
                    
                    <form class="note-form" data-job-id="${job.id}">
                        <h4 class="font-semibold text-gray-700 mb-2">Ustalar ArasÄ± Not BÄ±rak ve Dosya Ekle (Ã–rn: @AhmetUsta etiketle):</h4>
                        <textarea	
                            name="noteContent"
                            placeholder="Malzeme sipariÅŸi verildi. @AhmetUsta kesim bitti. (Resim/Video/PDF ekleyebilirsin)" required	
                            class="w-full p-2 border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-sm note-textarea"
                            ${!isFirebaseInitialized || !isAuthorized ? 'disabled' : ''}
                        ></textarea>
                        
                        <div class="mt-2">
                            <input type="file" name="noteFile" class="file-input hidden" id="noteFile-${job.id}" accept="image/*,video/*,.pdf">
                            <label for="noteFile-${job.id}" class="file-input-label">
                                Dosya Ekle (Resim, Video, PDF)
                            </label>
                        </div>

                        <button type="submit" class="w-full mt-2 font-bold py-2 rounded-lg transition duration-200 shadow-md	
                            ${isFirebaseInitialized && isAuthorized ? 'bg-yellow-600 hover:bg-yellow-700 text-white' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}"
                            ${!isFirebaseInitialized || !isAuthorized ? 'disabled' : ''}>
                            Notu GÃ¶nder (${masterName})
                        </button>
                        <div class="mt-4 border-t pt-3">
                            <h5 class="font-semibold text-gray-600 text-sm mb-1">GeÃ§miÅŸ Notlar:</h5>
                            <div class="space-y-1 max-h-40 overflow-y-auto pr-2">
                                ${notesHtml}
                            </div>
                        </div>
                    </form>
                </div>
            `;
        };

        const renderAnnouncementSection = () => {
            const announcementListHtml = announcements.map(ann => {
                const isGeneral = ann.type === 'AdminAnnouncement';
                const textColor = isGeneral ? 'text-indigo-700' : (ann.type === 'NewJob' ? 'text-green-700' : 'text-yellow-700');
                const bgColor = isGeneral ? 'bg-indigo-100' : (ann.type === 'NewJob' ? 'bg-green-100' : 'bg-yellow-100');
                const icon = isGeneral ? 'ðŸ“¢' : (ann.type === 'NewJob' ? 'ðŸ†•' : (ann.type === 'ProgressComplete' ? 'âœ…' : 'ðŸ’¬'));
                
                const jobLinkHtml = ann.jobId ? `<span class="text-xs text-gray-500 ml-2">(Ä°ÅŸ ID: ${ann.jobId.substring(0, 5)}...)</span>` : '';
                
                return `
                    <div class="p-3 rounded-md shadow-sm ${bgColor} border border-gray-200">
                        <p class="text-sm font-semibold ${textColor}">${icon} ${ann.content} ${jobLinkHtml}</p>
                        ${ann.fileUrl ? `
                            <p class="mt-1 text-xs">
                                <a href="${ann.fileUrl}" target="_blank" class="text-blue-500 hover:text-blue-700 font-medium underline">
                                    ${getFileIcon(ann.fileUrl)} Ekli DosyayÄ± GÃ¶r
                                </a>
                            </p>
                        ` : ''}
                        <span class="text-xs text-gray-400 float-right mt-1">${formatTimestamp(ann.timestamp)}</span>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Son Duyurular ve Bildirimler</h2>
                    <div class="space-y-3 max-h-96 overflow-y-auto p-1">
                        ${announcementListHtml || '<p class="text-gray-500 italic">HenÃ¼z yeni bir duyuru/bildirim yok.</p>'}
                    </div>
                </div>
            `;
        }

        const renderAdminDashboard = () => {
             // --- Admin Duyuru Ekleme Formu ---
            const announcementForm = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Genel Duyuru/Bildirim Ekle</h2>
                    <form id="announcement-form" class="space-y-4">
                        <div>
                            <label for="announcementContent" class="block text-sm font-medium text-gray-700">Duyuru Ä°Ã§eriÄŸi</label>
                            <textarea id="announcementContent" name="announcementContent" rows="3" class="mt-1 w-full p-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div>
                            <label for="announcementFile" class="block text-sm font-medium text-gray-700">Opsiyonel Dosya Ekle (Resim/Video/PDF)</label>
                            <input type="file" id="announcementFile" name="announcementFile" class="mt-1 w-full p-2 border rounded-md" accept="image/*,video/*,.pdf">
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200">
                            Duyuruyu YayÄ±nla (Herkese Bildirim Gider)
                        </button>
                    </form>
                </div>
            `;
            
            // --- Rol Atama ve Ä°ÅŸ Ekleme FormlarÄ± (Kalan KÄ±sÄ±mlar) ---
            const masterOptions = Object.entries(allMasters)
                .filter(([uid, data]) => data.role === 'Master' || data.role === 'Admin')
                .map(([uid, data]) => `<option value="${uid}">${data.name} (${data.role})</option>`).join('');

            const jobAddForm = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Yeni Ä°ÅŸ OluÅŸtur</h2>
                    <form id="add-job-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="customerName" class="block text-sm font-medium text-gray-700">MÃ¼ÅŸteri AdÄ± SoyadÄ± *</label>
                                <input type="text" id="customerName" name="customerName" required class="mt-1 w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Telefon No</label>
                                <input type="text" id="phone" name="phone" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                        </div>
                         <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="deliveryDate" class="block text-sm font-medium text-gray-700">Teslim Tarihi *</label>
                                <input type="date" id="deliveryDate" name="deliveryDate" required class="mt-1 w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="projectFile" class="block text-sm font-medium text-gray-700">Proje DosyasÄ± (Resim/Video/PDF)</label>
                                <input type="file" id="projectFile" name="projectFile" class="mt-1 w-full p-2 border rounded-md" accept="image/*,video/*,.pdf">
                            </div>
                        </div>
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700">Teslimat Adresi</label>
                            <textarea id="address" name="address" rows="2" class="mt-1 w-full p-2 border rounded-md"></textarea>
                        </div>
                        <div>
                            <label for="jobName" class="block text-sm font-medium text-gray-700">Ä°ÅŸ AdÄ± / AÃ§Ä±klamasÄ±</label>
                            <input type="text" id="jobName" name="jobName" required class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="assignedMasters" class="block text-sm font-medium text-gray-700">Atanacak Ustalar (Ctrl/Cmd ile Ã‡oklu SeÃ§im)</label>
                            <select id="assignedMasters" name="assignedMasters" multiple required class="mt-1 w-full p-2 border rounded-md h-24">
                                ${masterOptions}
                            </select>
                        </div>
                        <div>
                            <label for="jobStages" class="block text-sm font-medium text-gray-700">AÅŸamalar (Ad:AÄŸÄ±rlÄ±k, virgÃ¼lle ayÄ±r)</label>
                            <input type="text" id="jobStages" name="jobStages" value="Kesim:2,Bantlama:1,Montaj:5,Cila:2" required class="mt-1 w-full p-2 border rounded-md">
                            <p class="text-xs text-gray-500 mt-1">Ã–rn: Kesim:2,Montaj:5 (AÄŸÄ±rlÄ±k toplam ilerleme yÃ¼zdesini etkiler)</p>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200">
                            Ä°ÅŸi OluÅŸtur
                        </button>
                    </form>
                </div>
            `;
            
            const roleAssignForm = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">KullanÄ±cÄ± Rol Atama</h2>
                    <form id="assign-role-form" class="space-y-4">
                        <div>
                            <label for="targetUID" class="block text-sm font-medium text-gray-700">KullanÄ±cÄ± UID</label>
                            <input type="text" id="targetUID" name="targetUID" placeholder="Rol atamak istediÄŸiniz Google kullanÄ±cÄ±sÄ±nÄ±n UID'si" required class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="targetName" class="block text-sm font-medium text-gray-700">KullanÄ±cÄ± AdÄ± (Opsiyonel)</label>
                            <input type="text" id="targetName" name="targetName" placeholder="Ã–rn: Ahmet Usta" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="targetRole" class="block text-sm font-medium text-gray-700">Rol SeÃ§in</label>
                            <select id="targetRole" name="targetRole" required class="mt-1 w-full p-2 border rounded-md">
                                <option value="Admin">Admin (TÃ¼m Yetki)</option>
                                <option value="Master">Master (Ä°lerleme GÃ¼ncelleme)</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200">
                            RolÃ¼ Ata/GÃ¼ncelle
                        </button>
                    </form>
                    <div class="mt-6 border-t pt-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">TanÄ±mlÄ± KullanÄ±cÄ±lar:</h3>
                        <ul class="space-y-1 max-h-40 overflow-y-auto">
                            ${Object.values(allMasters).map(m => `
                                <li class="text-sm text-gray-700 p-1 bg-gray-50 rounded">
                                    <strong>${m.name}</strong> (${m.role}) - <span class="text-xs text-gray-500">${m.uid.substring(0, 8)}...</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;

            return `
                <div class="container mx-auto p-4 md:p-8">
                    <h1 class="text-3xl font-extrabold text-indigo-700 mb-6">Admin YÃ¶netim Paneli</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div class="lg:col-span-2">${jobAddForm}</div>
                        <div>${roleAssignForm}</div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                         <div>${announcementForm}</div>
                         <div class="lg:col-span-1">${renderAnnouncementSection()}</div>
                    </div>

                    <h2 class="text-3xl font-extrabold text-indigo-700 mb-6 border-t pt-6">TÃ¼m Ä°ÅŸler (${jobs.length})</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        ${jobs.map(createPatronJobCard).join('')}
                    </div>
                </div>
            `;
        };

        const renderMasterPanel = () => {
             return `
                <div class="container mx-auto p-4 md:p-8">
                    <h1 class="text-3xl font-extrabold text-yellow-700 mb-6">Usta Ä°ÅŸ Takip Paneli</h1>

                    <div class="mb-8">${renderAnnouncementSection()}</div>

                    <h2 class="text-3xl font-extrabold text-yellow-700 mb-6 border-t pt-6">Size Atanan Ä°ÅŸler (${jobs.length})</h2>
                    <p class="text-sm text-gray-600 mb-4">Not eklerken diÄŸer ustalarÄ± etiketlemek iÃ§in @KullanÄ±cÄ±AdÄ± (Ã¶rneÄŸin @AliUsta) formatÄ±nÄ± kullanabilirsiniz. Etiketlenen ustaya Ã¶zel bildirim gider.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        ${jobs.map(createMasterJobCard).join('')}
                    </div>
                </div>
            `;
        };


        const renderApp = () => {
            const app = document.getElementById('app');
            renderNotificationModal();
            
            const userIdDisplay = user?.uid || 'N/A';
            const userRole = userRoleData.role;
            const userName = userRoleData.name;

            // --- GÄ°RÄ°Åž VE YETKÄ° KONTROL EKRANI ---
            if (loading || userRoleData.role === 'Loading') {
                 app.innerHTML = `
                     <div class="fixed inset-0 flex items-center justify-center bg-gray-100">
                         <div class="text-center text-gray-500 p-8 bg-white shadow-xl rounded-xl">
                             <div class="animate-pulse">Sistem Verileri YÃ¼kleniyor...</div>
                             <p class="text-xs mt-2">${firebaseStatusText}</p>
                         </div>
                     </div>
                 `;
                 return;
            }
            
            if (userRole === 'NoAuth' || userRole === 'Unauthorized') {
                 app.innerHTML = `
                     <div class="fixed inset-0 flex items-center justify-center bg-gray-100 p-4">
                         <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl text-center">
                             <h1 class="text-3xl font-extrabold text-indigo-600 mb-4">Erolpen Ä°ÅŸ Takip Sistemi</h1>
                             <p class="text-gray-600 mb-6">${userRole === 'Unauthorized' ? 'HesabÄ±nÄ±z YÃ¶netici tarafÄ±ndan tanÄ±mlanmamÄ±ÅŸtÄ±r.' : 'LÃ¼tfen yetkili hesabÄ±nÄ±zla giriÅŸ yapÄ±n.'}</p>
                             
                             ${userRole === 'NoAuth' ? `
                                 <button id="google-login-btn" class="w-full flex items-center justify-center px-6 py-3 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-red-600 hover:bg-red-700 transition duration-200" title="Google ile GiriÅŸ Yap">
                                     <svg class="h-5 w-5 mr-3" aria-hidden="true" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.5-.18-2.22H12v4.26h6.25c-.26 1.34-1.04 2.47-2.21 3.23l.05.04 3.49 2.71.01.03c2.04-1.88 3.22-4.67 3.22-7.85z" fill="#4285F4"/><path d="M12 23c3.08 0 5.67-1.02 7.56-2.74l-3.5-2.71c-.96.64-2.2 1.02-3.83 1.02-2.96 0-5.46-1.99-6.34-4.66H1.72l-.01.03-3.79 2.94-.02.04C2.37 20.89 6.8 23 12 23z" fill="#34A853"/><path d="M5.66 14.07c-.12-.35-.19-.71-.19-1.07s.07-.72.19-1.07V8.98L1.87 6.04 1.84 6c-1.3 2.62-1.3 5.75 0 8.36l3.82 2.94.02-.03c-.01-.63-.04-1.26 0-1.9z" fill="#FBBC05"/><path d="M12 5.37c1.65 0 3.12.57 4.3 1.66l3.05-3.05C17.67 1.5 15.08.48 12 .48 6.8 0 2.37 2.11-.01 6.05l3.83 2.95c.88-2.67 3.38-4.66 6.33-4.66z" fill="#EA4335"/></svg>
                                     Google Ä°le GiriÅŸ Yap
                                 </button>` : `
                                 <p class="p-4 bg-red-100 text-red-700 rounded-lg">EriÅŸim engellendi. LÃ¼tfen YÃ¶neticinizle iletiÅŸime geÃ§in.</p>
                                 <button id="google-login-btn" class="w-full mt-4 flex items-center justify-center px-6 py-3 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200">
                                     Tekrar Dene
                                 </button>
                                 `
                             }
                             <p class="text-xs text-gray-400 mt-4">${firebaseStatusText}</p>
                         </div>
                     </div>
                 `;
                 if (document.getElementById('google-login-btn')) {
                    document.getElementById('google-login-btn').addEventListener('click', handleGoogleSignIn);
                 }
                 return;
            }

            // --- YETKÄ°LÄ° KULLANICI EKRANI ---
            const panelHtml = userRole === 'Admin' ? renderAdminDashboard() : renderMasterPanel();

            app.innerHTML = `
                <header class="bg-white shadow sticky top-0 z-10">
                    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                        <div class="flex items-center">
                            <h1 class="text-xl font-bold text-gray-800">${userRole === 'Admin' ? 'Admin Paneli' : 'Master Paneli'}</h1>
                            <span class="ml-4 text-sm font-medium text-indigo-600 border-l pl-4 hidden sm:block">
                                HoÅŸ Geldiniz, ${userName}
                            </span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-500 hidden md:block">Rol: ${userRole}</span>
                            <button id="logout-btn" class="px-3 py-1 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ${userRole === 'Admin' ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-600 hover:bg-gray-700'} transition duration-200">
                                Ã‡Ä±kÄ±ÅŸ Yap
                            </button>
                        </div>
                    </div>
                </header>
                <main>
                    ${panelHtml}
                </main>
                <footer class="text-center p-4 text-xs text-gray-400 mt-8 border-t">
                    Erolpen Ä°ÅŸ Takip Sistemi - Firebase Status: ${firebaseStatusText} (UID: ${userIdDisplay.substring(0, 8)}...)
                </footer>
            `;

            // --- EVENT LISTENERS'I ATAMA (GÃ¼ncellendi) ---
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            if (userRole === 'Admin') {
                document.getElementById('add-job-form').addEventListener('submit', handleAddJob);
                document.getElementById('assign-role-form').addEventListener('submit', handleAssignRole);
                document.getElementById('announcement-form').addEventListener('submit', handleAddAnnouncement); // YENÄ°
            }

            // Ä°lerleme GÃ¼ncelleme Dinleyicileri (Admin ve Master)
            document.querySelectorAll('.progress-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const jobId = e.target.getAttribute('data-job-id');
                    const stageIndex = parseInt(e.target.getAttribute('data-stage-index'));
                    const newProgress = e.target.value;
                    handleUpdateStageProgress(jobId, stageIndex, newProgress);
                });
            });

            // Not Ekleme Dinleyicileri (Admin ve Master)
            document.querySelectorAll('.note-form').forEach(form => {
                form.addEventListener('submit', handleAddNote);
            });
        };


        // UygulamayÄ± BaÅŸlat
        initializeFirebase();
    </script>
</body>
</html>
