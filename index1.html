<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erolpen İş Takip Sistemi - Yetkili Erişim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter font for modern look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Custom scrollbar for note sections */
        .max-h-40::-webkit-scrollbar {
            width: 4px;
        }
        .max-h-40::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
        .job-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: default;
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .progress-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body>
    <div id="app" class="w-full">
        </div>

    <script type="module">
        // ----------------------------------------------------------------
        // ### DÜZELTME 1: erolpen PROJESİNİN CONFIG BİLGİLERİNİ BURAYA YAPIŞTIRIN! ###
        // Firebase Console > Project Settings (Dişli çark) > Your apps > Web app (</>)
        // ORADAKİ config OBJESİNİN TAMAMINI KOPYALAYIN.
        // ÖRNEK CONFIG:
        const FIXED_FIREBASE_CONFIG = {
              apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
  authDomain: "kibrissiparissistemi.firebaseapp.com",
  databaseURL: "https://kibrissiparissistemi-default-rtdb.firebaseio.com",
  projectId: "kibrissiparissistemi",
  storageBucket: "kibrissiparissistemi.firebasestorage.app",
  messagingSenderId: "263531733235",
  appId: "1:263531733235:web:82efdf39ed758a22465786",
  measurementId: "G-JK5S6L90Q5
        };
        // ----------------------------------------------------------------
        
        // --- Firebase Modül İçe Aktarımları (Storage Eklendi) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, Timestamp, query, getDoc, getDocs, setDoc, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Firebase loglarını açın (Hata ayıklama için önemlidir)
        setLogLevel('Debug');
        
        // --- GLOBAL STATE ---
        let db = null; 
        let auth = null; 
        let storage = null; // Storage servisi eklendi
        let user = null; 
        let isAuthReady = false; 
        let jobs = [];
        let notes = {};
        let allMasters = {}; 
        let userRoleData = { role: 'Loading', name: 'Yükleniyor...' }; 
        let loading = true;
        let showModal = false;
        let modalMessage = "";
        
        const APP_ID = 'erolpen'; // Firestore kurallarımızdaki proje ID'miz
        let isFirebaseInitialized = false; 
        let firebaseStatusText = "Yükleniyor...";


        // --- UTILITY FUNCTIONS ---
        const calculateWeightedProgress = (stages) => {
            let weightedSum = 0;
            let totalWeight = 0;
            stages.forEach(stage => {
                const progress = stage.progress || 0;
                const weight = stage.weight || 1;
                weightedSum += progress * weight;
                totalWeight += weight;
            });
            return totalWeight === 0 ? 0 : Math.round(weightedSum / totalWeight);
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            const time = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            const d = date.toLocaleDateString('tr-TR');
            return `${time} ${d}`;
        };

        const showNotification = (message) => {
            modalMessage = message;
            showModal = true;
            renderNotificationModal();
            setTimeout(() => {
                showModal = false;
                renderNotificationModal();
            }, 3000);
        };
        
        // --- FIREBASE INITIALIZATION & AUTH ---
        const handleGoogleSignIn = async () => {
            if (!auth || !isFirebaseInitialized) {
                showNotification("HATA: Firebase Auth servisi başlatılamadı.");
                return;
            }
            
            const provider = new GoogleAuthProvider();
            provider.addScope('profile');
            provider.addScope('email');

            try {
                loading = true;
                renderApp(); 
                await signInWithPopup(auth, provider);
            } catch (error) {
                loading = false;
                renderApp(); 
                console.error("Google Giriş Hatası:", error);
                
                if (error.code === 'auth/popup-closed-by-user') {
                    showNotification("Giriş penceresi kullanıcı tarafından kapatıldı.");
                } else if (error.code === 'auth/unauthorized-domain') {
                    showNotification("HATA: Firebase Auth Domain ayarlarınızı kontrol edin.");
                } else {
                    showNotification(`Giriş sırasında hata oluştu: ${error.message}`);
                }
            }
        };

        const initializeFirebase = () => {
            try {
                // Burada kodunuzda bulunan sabit config kullanılıyor.
                // LÜTFEN FIXED_FIREBASE_CONFIG'İ erolpen BİLGİLERİYLE GÜNCELLEYİN.
                let firebaseConfig = FIXED_FIREBASE_CONFIG; 
                
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes('EROLPEN_API_KEY')) {
                    console.error("Firebase config (erolpen bilgileri) doldurulmamış.");
                    loading = false;
                    isFirebaseInitialized = false;
                    user = null;
                    isAuthReady = true;
                    userRoleData = { role: 'NoAuth', name: 'Giriş Gerekli' };
                    firebaseStatusText = "Firebase BAĞLI DEĞİL. Config'i DOLDURUN!";
                    renderApp(); 
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app); // Storage başlatıldı
                isFirebaseInitialized = true;
                firebaseStatusText = "Firebase Başlatıldı";

                onAuthStateChanged(auth, async (currentUser) => {
                    loading = true;
                    if (currentUser) {
                        user = currentUser;
                        
                        // 1. Kullanıcının rol belgesini kontrol et
                        const roleDocRef = doc(db, `artifacts/${APP_ID}/public/data/user_permissions`, user.uid);
                        const roleDoc = await getDoc(roleDocRef);
                        
                        // --- YETKİ KONTROLÜ (Admin Tarafından Tanımlanmış Hesap Kontrolü) ---
                        if (roleDoc.exists()) {
                            userRoleData = roleDoc.data();
                            console.log(`Kullanıcı rolü yüklendi: ${userRoleData.role}`);
                        } else {
                            // Rol tanımlı değilse, Admin sayısını kontrol et (İlk Admin atama mantığı)
                            const permissionsColRef = collection(db, `artifacts/${APP_ID}/public/data/user_permissions`);
                            const adminQuery = query(permissionsColRef, where("role", "==", "Admin"));
                            const adminSnapshot = await getDocs(adminQuery);

                            if (adminSnapshot.empty) {
                                // Admin yoksa, ilk Google kullanıcısına Admin rolü ver ve kaydet
                                userRoleData = { 
                                    role: 'Admin', 
                                    name: user.displayName || user.email.split('@')[0] || 'Patron', 
                                    uid: user.uid
                                };
                                await setDoc(roleDocRef, userRoleData);
                                showNotification("Sistemin ilk kullanıcısı olarak Admin yetkisi atandı.");
                            } else {
                                // Admin varsa, rolü tanımlı olmayan bu Google kullanıcısı YETKİSİZ.
                                await signOut(auth); 
                                user = null;
                                userRoleData = { role: 'Unauthorized', name: 'Yetkisiz Kullanıcı' };
                                showNotification("HATA: Hesabınız sisteme Admin tarafından tanımlanmamıştır. Erişim engellendi.");
                                console.error("Yetkisiz kullanıcı girişi engellendi:", currentUser.email);
                            }
                        }
                    } else {
                        // Çıkış yapılmış veya hiç giriş yapılmamışsa
                        user = null; 
                        userRoleData = { role: 'NoAuth', name: 'Giriş Gerekli' };
                        console.log("Kullanıcı oturumu açılmadı.");
                    }
                    
                    loading = false;
                    isAuthReady = true;
                    if (isFirebaseInitialized && user && userRoleData.role !== 'Unauthorized') {
                        setupFirestoreListeners();
                    } else {
                        jobs = []; 
                        notes = {};
                        allMasters = {};
                    }
                    renderApp();
                });
                
            } catch (error) {
                console.error("Firebase Başlatma hatası:", error);
                loading = false;
                isFirebaseInitialized = false;
                user = null;
                isAuthReady = true;
                userRoleData = { role: 'NoAuth', name: 'Giriş Gerekli' };
                firebaseStatusText = "Firebase Başlatma Hatası";
                renderApp();
            }
        };

        // --- DOSYA YÜKLEME FONKSİYONU ---
        const handleFileUpload = async (file, noteContent) => {
            if (!file || !storage || !user) {
                showNotification("HATA: Dosya veya yetki eksik.");
                return null;
            }

            const fileExtension = file.name.split('.').pop();
            const fileName = `${Timestamp.fromDate(new Date()).toMillis()}-${user.uid.substring(0, 5)}.${fileExtension}`;
            const storagePath = `uploads/${fileName}`;
            const fileRef = ref(storage, storagePath);

            try {
                // Dosyayı yükle
                const snapshot = await uploadBytes(fileRef, file);
                
                // İndirme URL'sini al
                const fileURL = await getDownloadURL(snapshot.ref);

                showNotification(`Dosya başarıyla yüklendi: ${file.name}`);
                
                // Not içeriğini URL ile zenginleştir
                const fileLink = `[Dosya: ${file.name}](${fileURL})`;
                const newNoteContent = `${noteContent.trim() ? noteContent + ' | ' : ''} ${fileLink}`;

                return {
                    url: fileURL,
                    note: newNoteContent
                };

            } catch (error) {
                console.error("Dosya yüklenirken hata:", error);
                showNotification(`HATA: Dosya yüklenemedi. Storage Kurallarınızı kontrol edin! (${error.code})`);
                return null;
            }
        };


        // --- FIREBASE LISTENERS (Real-Time Data Fetching) ---
        const setupFirestoreListeners = () => {
            if (!db || !isAuthReady || userRoleData.role === 'Loading' || !user) return;

            const jobsColRef = collection(db, `artifacts/${APP_ID}/public/data/jobs`);
            const notesColRef = collection(db, `artifacts/${APP_ID}/public/data/notes`);
            const permissionsColRef = collection(db, `artifacts/${APP_ID}/public/data/user_permissions`);

            // 1. İzinleri Dinle (Tüm Master'ları listelemek için)
            onSnapshot(query(permissionsColRef), (snapshot) => {
                const masters = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.role === 'Master' || data.role === 'Admin') {
                        masters[doc.id] = data;
                    }
                });
                allMasters = masters;
                renderApp();
            }, (error) => console.error("Permissions listener error:", error));

            // 2. İşleri Dinle (Jobs)
            const jobQuery = userRoleData.role === 'Master' 
                ? query(jobsColRef, where("masters", "array-contains", user.uid))
                : query(jobsColRef);

            onSnapshot(jobQuery, (snapshot) => {
                let fetchedJobs = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const mastersArray = Array.isArray(data.masters) ? data.masters : []; 
                    return {
                        ...data,
                        id: doc.id,
                        masters: mastersArray, 
                        totalProgress: calculateWeightedProgress(data.stages || []),
                    };
                }).sort((a, b) => {
                    // Tamamlananları sona at
                    if (a.totalProgress === 100 && b.totalProgress !== 100) return 1;
                    if (a.totalProgress !== 100 && b.totalProgress === 100) return -1;
                    // Kalınan yerden devam edenleri önce getir
                    if (a.totalProgress > 0 && a.totalProgress < 100 && b.totalProgress === 0) return -1;
                    if (a.totalProgress === 0 && b.totalProgress > 0 && b.totalProgress < 100) return 1;

                    return a.name.localeCompare(b.name); // Alfabetik sıralama
                });
                
                jobs = fetchedJobs;
                renderApp();
            }, (error) => console.error("Jobs listener error:", error));


            // 3. Notları Dinle (Notes)
            onSnapshot(query(notesColRef), (snapshot) => {
                const allNotes = {};
                snapshot.docs.forEach(doc => {
                    const note = doc.data();
                    if (!allNotes[note.jobKey]) {
                        allNotes[note.jobKey] = [];
                    }
                    allNotes[note.jobKey].push(note);
                });

                for (const jobKey in allNotes) {
                    allNotes[jobKey].sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                }
                notes = allNotes;
                renderApp();
            }, (error) => console.error("Notes listener error:", error));
        };

        // --- JOB/NOTE/ROLE MANIPULATION METHODS ---

        const handleLogout = async () => {
            if (auth) {
                try {
                    userRoleData = { role: 'Loading', name: 'Yükleniyor...' };
                    await signOut(auth);
                } catch (error) {
                    console.error("Çıkış yapılırken hata:", error);
                    showNotification("Çıkış sırasında hata oluştu. Konsolu kontrol edin.");
                }
            }
        };

        const handleAssignRole = async (e) => {
            e.preventDefault();
            if (userRoleData.role !== 'Admin' || !db || !isFirebaseInitialized) {
                showNotification("HATA: Sadece Admin rol atayabilir.");
                return;
            }

            const form = e.target;
            const targetUID = form.targetUID.value.trim();
            const targetRole = form.targetRole.value;
            const targetName = form.targetName.value.trim() || `${targetRole} Kullanıcı`;

            if (!targetUID) {
                showNotification("HATA: Geçerli bir Kullanıcı UID'si girin.");
                return;
            }

            if (user && targetUID === user.uid && targetRole !== userRoleData.role) {
                showNotification("UYARI: Kendi rolünüzü ancak aynı rolle güncelleyebilirsiniz.");
            }

            const roleDocRef = doc(db, `artifacts/${APP_ID}/public/data/user_permissions`, targetUID);
            const newRoleData = {
                role: targetRole,
                name: targetName,
                uid: targetUID
            };

            try {
                await setDoc(roleDocRef, newRoleData);
                showNotification(`UID: ${targetUID.substring(0, 5)}... kullanıcısına ${targetName} (${targetRole}) rolü başarıyla atandı.`);
                form.reset();
            } catch (error) {
                console.error("Firestore'a rol atarken hata:", error);
                showNotification(`Hata: Rol atanamadı. Firestore Kurallarınızı kontrol edin! (Console'da detay)`);
            }
        };

        const handleAddJob = async (e) => {
            e.preventDefault();
            if (userRoleData.role !== 'Admin' || !db || !isFirebaseInitialized) {
                showNotification("HATA: Sadece Admin iş ekleyebilir.");
                return;
            }

            const form = e.target;
            const name = form.jobName.value;
            const stagesInput = form.jobStages.value.split(',').map(s => s.trim()).filter(s => s);
            const assignedMastersElement = form.assignedMasters;
            const selectedMasterUIDs = assignedMastersElement ? Array.from(assignedMastersElement.options)
                                         .filter(option => option.selected)
                                         .map(option => option.value) : [];


            if (selectedMasterUIDs.length === 0) {
                showNotification("HATA: Lütfen en az bir usta atayın.");
                return;
            }

            const stages = stagesInput.map(item => {
                const parts = item.split(':');
                const stageName = parts[0];
                const weight = parseInt(parts[1]) || 1;
                return { name: stageName, progress: 0, weight: weight };
            });

            const newJob = {
                name: name,
                stages: stages,
                masters: selectedMasterUIDs, 
                createdBy: user.uid,
                createdByName: userRoleData.name,
                createdAt: Timestamp.fromDate(new Date())
            };

            try {
                const jobsColRef = collection(db, `artifacts/${APP_ID}/public/data/jobs`);
                await addDoc(jobsColRef, newJob);
                showNotification("Yeni İş Başarıyla Eklendi!");
                form.reset();
                form.jobStages.value = "Kesim:2,Bantlama:1,Montaj:5,Cila:2";
            } catch (error) {
                console.error("Firestore'a iş eklerken hata:", error);
                showNotification(`Hata: İş eklenemedi. Firestore Kurallarınızı kontrol edin! (Console'da detay)`);
            }
        };

        const handleUpdateStageProgress = async (jobId, stageIndex, newProgress) => {
            if (userRoleData.role === 'NoAuth' || userRoleData.role === 'Unauthorized' || !db || !isFirebaseInitialized) {
                showNotification("HATA: İlerleme güncellemek için yetkiniz yok.");
                return;
            }

            const jobToUpdate = jobs.find(j => j.id === jobId);
            if (!jobToUpdate) return;
            
            if (userRoleData.role === 'Master' && !jobToUpdate.masters.includes(user.uid)) {
                showNotification("HATA: Sadece size atanan işin ilerlemesini güncelleyebilirsiniz.");
                return;
            }

            const progressValue = Math.max(0, Math.min(100, parseInt(newProgress) || 0));
            if (jobToUpdate.stages[stageIndex].progress === progressValue) return; 

            const newStages = [...jobToUpdate.stages];
            newStages[stageIndex].progress = progressValue;

            try {
                const jobDocRef = doc(db, `artifacts/${APP_ID}/public/data/jobs`, jobId);
                await updateDoc(jobDocRef, {
                    stages: newStages,
                    totalProgress: calculateWeightedProgress(newStages),
                    lastUpdatedBy: user.uid,
                    lastUpdatedAt: Timestamp.fromDate(new Date())
                });
            } catch (error) {
                console.error("İlerleme güncellenirken hata:", error);
                showNotification(`Hata: İlerleme güncellenemedi. İzinleri kontrol edin.`);
            }
        };

        // DÜZELTİLMİŞ NOT EKLEME VE DOSYA YÜKLEME BİRLEŞİMİ
        const handleNoteFormSubmit = async (e) => {
            e.preventDefault();
            const jobId = e.target.getAttribute('data-job-id');
            const noteContentElement = e.target.querySelector('.note-textarea');
            const fileInputElement = e.target.querySelector('.file-input');
            
            let noteContent = noteContentElement.value.trim();
            const file = fileInputElement.files[0];

            if (!noteContent && !file) {
                showNotification("Lütfen bir not yazın veya dosya seçin.");
                return;
            }

            if (userRoleData.role === 'NoAuth' || userRoleData.role === 'Unauthorized' || !db || !isFirebaseInitialized) {
                showNotification("HATA: Not/Dosya eklemek için yetkiniz yok.");
                return;
            }
            
            const jobToUpdate = jobs.find(j => j.id === jobId);
            if (!jobToUpdate) return;

            if (userRoleData.role === 'Master' && !jobToUpdate.masters.includes(user.uid)) {
                showNotification("HATA: Sadece size atanan işe not ekleyebilirsiniz.");
                return;
            }

            if (file) {
                const uploadResult = await handleFileUpload(file, noteContent);
                if (!uploadResult) return; // Yükleme hatası varsa dur
                noteContent = uploadResult.note;
            }


            const newNote = {
                jobKey: jobId,
                content: noteContent,
                master: userRoleData.name,
                masterUID: user.uid,
                timestamp: Timestamp.fromDate(new Date())
            };

            try {
                const notesColRef = collection(db, `artifacts/${APP_ID}/public/data/notes`);
                await addDoc(notesColRef, newNote);
                showNotification(`İş ${jobId.substring(0, 5)} için yeni not eklendi.`);
                
                // Formu ve dosya seçimi alanını temizle
                noteContentElement.value = '';
                fileInputElement.value = '';

            } catch (error) {
                console.error("Not eklenirken hata:", error);
                showNotification(`Hata: Not eklenemedi. İzinleri kontrol edin. (Console'da detay)`);
            }
        };


        // --- RENDERING FUNCTIONS (Vanilla JS) ---

        const renderNotificationModal = () => {
            let modalElement = document.getElementById('notification-modal');
            if (!modalElement) {
                modalElement = document.createElement('div');
                modalElement.id = 'notification-modal';
                document.body.appendChild(modalElement);
            }

            modalElement.className = `fixed inset-0 z-50 flex items-start justify-center p-6 transition-opacity duration-300 ${showModal ? 'opacity-100' : 'opacity-0 pointer-events-none'}`;
            modalElement.innerHTML = `
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-xl font-semibold text-center pointer-events-auto">
                    <span>${modalMessage}</span>
                </div>
            `;
        };

        const createPatronJobCard = (job) => {
            const jobNotes = notes[job.id] || [];
            const isComplete = job.totalProgress === 100;
            
            const assignedMasterNames = job.masters.map(uid => allMasters[uid]?.name || `Bilinmeyen Usta (${uid.substring(0, 4)}...)`).join(', ');

            const stagesHtml = job.stages.map((stage, index) => `
                <li class="flex justify-between items-center ${stage.progress === 100 ? 'text-green-600 font-medium' : 'text-gray-600'}">
                    <span>${stage.name} (Ağırlık: ${stage.weight || 1})</span>
                    <strong class="text-lg">${stage.progress || 0}%</strong>
                </li>
            `).join('');

            const notesHtml = jobNotes.length > 0 ? jobNotes.map((note, index) => {
                let content = note.content;
                // Dosya linklerini tanıma ve HTML linkine çevirme (Markdown formatından)
                const linkRegex = /\[Dosya: (.*?)\]\((.*?)\)/g;
                content = content.replace(linkRegex, (match, fileName, fileURL) => {
                    return `Dosya: <a href="${fileURL}" target="_blank" class="text-blue-500 hover:text-blue-700 underline font-semibold">${fileName}</a>`;
                });

                return `
                    <div class="p-2 text-xs rounded bg-gray-100 mt-1 border border-gray-200">
                        <span class="font-bold text-indigo-500">${note.master}</span>: <span>${content}</span>
                        <span class="text-gray-400 ml-2 float-right">${formatTimestamp(note.timestamp)}</span>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500 italic text-xs">Bu işe ait henüz bir not yok.</p>';

            return `
                <div class="job-card p-4 border-l-4 rounded-lg shadow-md ${isComplete ? 'border-green-500 bg-white' : 'border-gray-300 bg-white'}" id="patron-card-${job.id}">
                    <h3 class="text-xl font-bold ${isComplete ? 'text-green-600' : 'text-indigo-600'}">${job.name}</h3>
                    <p class="text-sm text-gray-500 mb-2">Atanan Ustalar: <strong class="font-medium">${assignedMasterNames}</strong></p>
                    
                    <div class="mt-3">
                        <p class="text-sm font-semibold">Genel İlerleme (Ağırlıklı): <span class="${isComplete ? 'text-green-700' : 'text-gray-700'}">${job.totalProgress}%</span></p>
                        <div class="progress-bar-container w-full h-3 bg-gray-200 rounded-full overflow-hidden mt-1">
                            <div class="progress-bar h-full text-xs text-white flex items-center justify-center transition-all duration-500 
                                ${isComplete ? 'bg-green-500' : (job.totalProgress > 50 ? 'bg-yellow-500' : 'bg-red-500')}" 
                                style="width: ${job.totalProgress}%">
                                ${job.totalProgress > 10 ? `${job.totalProgress}%` : ''}
                            </div>
                        </div>
                    </div>

                    <details class="mt-4 text-sm text-gray-600">
                        <summary class="cursor-pointer font-medium hover:text-indigo-500">
                            Aşama Detayları ve Notlar (${jobNotes.length} Not)
                        </summary>
                        <ul class="ml-2 mt-2 space-y-1 list-none p-0">
                            ${stagesHtml}
                        </ul>
                        <h4 class="font-semibold text-sm mt-3 border-t pt-2 text-indigo-700">İş Notları:</h4>
                        <div class="space-y-1 max-h-40 overflow-y-auto pr-2">
                            ${notesHtml}
                        </div>
                    </details>
                </div>
            `;
        };
        
        const createMasterJobCard = (job) => {
            const jobNotes = notes[job.id] || [];
            const isAuthorized = job.masters.includes(user.uid) || userRoleData.role === 'Admin'; 
            
            const stagesHtml = job.stages.map((stage, index) => `
                <div class="flex items-center space-x-3">
                    <label class="flex-grow text-sm font-medium text-gray-700">
                        <span>${stage.name}</span> (Ağırlık: ${stage.weight || 1}):
                    </label>
                    <input type="number" 
                        data-job-id="${job.id}"
                        data-stage-index="${index}"
                        value="${stage.progress || 0}"
                        min="0" max="100" 
                        class="progress-input w-20 p-2 border border-gray-300 rounded-md text-right focus:ring-yellow-500 focus:border-yellow-500 text-sm"
                        ${!isFirebaseInitialized || !isAuthorized ? 'disabled' : ''}
                    />
                    <span class="font-semibold text-gray-600">%</span>
                </div>
            `).join('');

             const notesHtml = jobNotes.length > 0 ? jobNotes.map((note, index) => {
                let content = note.content;
                const linkRegex = /\[Dosya: (.*?)\]\((.*?)\)/g;
                content = content.replace(linkRegex, (match, fileName, fileURL) => {
                    return `Dosya: <a href="${fileURL}" target="_blank" class="text-blue-500 hover:text-blue-700 underline font-semibold">${fileName}</a>`;
                });

                return `
                    <div class="p-2 text-xs rounded bg-gray-100 mt-1 border border-gray-200">
                        <span class="font-bold text-indigo-500">${note.master}</span>: <span>${content}</span>
                        <span class="text-gray-400 ml-2 float-right">${formatTimestamp(note.timestamp)}</span>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500 italic text-xs">Bu işe ait henüz bir not yok.</p>';
            
            const masterName = userRoleData.name || 'Usta';

            return `
                <div class="job-card p-4 border-l-4 border-yellow-500 bg-white rounded-lg shadow-md" id="master-card-${job.id}">
                    <h3 class="text-xl font-bold text-yellow-700">${job.name}</h3>
                    <p class="text-sm text-gray-500 mb-4">Genel İlerleme (Ağırlıklı): <strong>${job.totalProgress}%</strong></p>
                    
                    <div class="space-y-3 mb-6 border-b pb-4">
                        <h4 class="font-semibold text-gray-700 border-b pb-1">Aşama İlerlemeni Gir:</h4>
                        ${isAuthorized ? stagesHtml : '<p class="text-red-500 text-sm">Bu iş size atanmamıştır, ilerleme güncelleyemezsiniz.</p>'}
                        ${!isFirebaseInitialized ? '<p class="text-red-500 text-xs pt-2">Firebase BAĞLI DEĞİL. İlerleme güncellenemez.</p>' : ''}
                    </div>
                    
                    <form class="note-form" data-job-id="${job.id}">
                        <h4 class="font-semibold text-gray-700 mb-2">Ustalar Arası Not Bırak ve Dosya Yükle:</h4>
                        <textarea 
                            name="noteContent"
                            placeholder="Malzeme siparişi verildi, kesim bitti vb. (Opsiyonel)" 
                            class="w-full p-2 border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-sm note-textarea mb-2"
                            ${!isFirebaseInitialized || !isAuthorized ? 'disabled' : ''}
                        ></textarea>
                        <input type="file" name="fileInput" class="file-input w-full p-2 border rounded-lg text-sm mb-2"
                            ${!isFirebaseInitialized || !isAuthorized ? 'disabled' : ''} />

                        <button type="submit" class="w-full mt-2 font-bold py-2 rounded-lg transition duration-200 shadow-md 
                            ${isFirebaseInitialized && isAuthorized ? 'bg-yellow-600 hover:bg-yellow-700 text-white' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}"
                            ${!isFirebaseInitialized || !isAuthorized ? 'disabled' : ''}>
                            Not/Dosya Gönder (${masterName})
                        </button>
                        <div class="mt-4 border-t pt-3">
                            <h5 class="font-semibold text-gray-600 text-sm mb-1">Geçmiş Notlar:</h5>
                            <div class="space-y-1 max-h-40 overflow-y-auto pr-2">
                                ${notesHtml}
                            </div>
                        </div>
                    </form>
                </div>
            `;
        };

        const renderAdminPanel = () => {
            const masterOptions = Object.keys(allMasters).map(uid => {
                const master = allMasters[uid];
                return `<option value="${uid}">${master.name} (${master.role})</option>`;
            }).join('');

            const assignedMastersList = Object.keys(allMasters).map(uid => {
                const master = allMasters[uid];
                return `<li class="text-sm border-b p-1"><strong>${master.name}</strong> (${master.role}) - UID: ${uid}</li>`;
            }).join('');

            return `
                <div class="p-6 bg-white shadow-lg rounded-xl mb-6">
                    <h2 class="text-2xl font-bold text-red-600 border-b pb-3 mb-4">ADMIN PANELİ (Erolpen)</h2>
                    
                    <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                        <h3 class="text-xl font-semibold text-red-500 mb-3">Kullanıcı Rolü Yönetimi</h3>
                        <form id="assignRoleForm">
                            <div class="space-y-2">
                                <input name="targetUID" type="text" placeholder="Hedef Kullanıcı UID" required class="w-full p-2 border rounded-lg text-sm">
                                <input name="targetName" type="text" placeholder="Kullanıcı Adı (Opsiyonel)" class="w-full p-2 border rounded-lg text-sm">
                                <select name="targetRole" required class="w-full p-2 border rounded-lg text-sm">
                                    <option value="Master">Usta (Master)</option>
                                    <option value="Admin">Yönetici (Admin)</option>
                                </select>
                                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-200">
                                    Rol Atamayı Kaydet
                                </button>
                            </div>
                        </form>
                        <div class="mt-4 border-t pt-3">
                            <h4 class="font-semibold text-sm mb-2">Tanımlı Kullanıcılar:</h4>
                            <ul class="max-h-40 overflow-y-auto pr-2 bg-white rounded">
                                ${assignedMastersList || '<li class="text-gray-500 italic text-sm p-1">Henüz tanımlı kullanıcı yok.</li>'}
                            </ul>
                        </div>
                    </div>

                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h3 class="text-xl font-semibold text-red-500 mb-3">Yeni İş/Proje Oluşturma</h3>
                        <form id="addJobForm">
                            <div class="space-y-3">
                                <input name="jobName" type="text" placeholder="İş/Proje Adı (Örn: Müşteri Adı - Proje)" required class="w-full p-2 border rounded-lg text-sm">
                                <input name="jobStages" type="text" placeholder="Aşamalar (Örn: Kesim:2,Bantlama:1,Montaj:5)" value="Kesim:2,Bantlama:1,Montaj:5,Cila:2" required class="w-full p-2 border rounded-lg text-sm">
                                <select name="assignedMasters" multiple required class="w-full p-2 border rounded-lg text-sm h-32">
                                    <option value="" disabled>--- Usta Seç (Çoklu Seçim) ---</option>
                                    ${masterOptions}
                                </select>
                                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-200">
                                    İşi Oluştur
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        };

        const renderApp = () => {
            const app = document.getElementById('app');
            renderNotificationModal();
            
            const userIdDisplay = user?.uid || 'N/A';
            const userRole = userRoleData.role;
            const userName = userRoleData.name;

            // --- GİRİŞ VE YETKİ KONTROL EKRANI ---
            if (loading || userRoleData.role === 'Loading') {
                 app.innerHTML = `
                    <div class="fixed inset-0 flex items-center justify-center bg-gray-100">
                        <div class="text-center text-gray-500 p-8 bg-white shadow-xl rounded-xl">
                            <div class="animate-pulse">Sistem Verileri Yükleniyor...</div>
                            <p class="text-xs mt-2">${firebaseStatusText}</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (userRole === 'NoAuth' || userRole === 'Unauthorized') {
                 app.innerHTML = `
                    <div class="fixed inset-0 flex items-center justify-center bg-gray-100 p-4">
                        <div class="text-center p-8 bg-white shadow-xl rounded-xl max-w-sm w-full">
                            <h1 class="text-2xl font-bold text-indigo-600 mb-4">Erolpen İş Takip Sistemi</h1>
                            ${userRole === 'Unauthorized' ? 
                                '<p class="text-red-500 font-semibold mb-4">Erişim Reddedildi. Hesabınız Admin tarafından sisteme tanımlanmamıştır.</p>' :
                                '<p class="text-gray-600 mb-6">Yetkili erişim için Google hesabınızla giriş yapın.</p>'
                            }
                            
                            <button id="signInButton" class="w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                                <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 0C4.47 0 0 4.47 0 10s4.47 10 10 10c2.65 0 4.97-1.05 6.72-2.78l-1.99-1.55c-1.12.87-2.61 1.4-4.73 1.4-3.52 0-6.38-2.86-6.38-6.38s2.86-6.38 6.38-6.38c1.64 0 3.09.61 4.22 1.58l1.97-1.54C14.9 1.76 12.65 0 10 0z M10 4c-3.31 0-6 2.69-6 6s2.69 6 6 6c1.67 0 3.1-.68 4.18-1.78l-1.57-1.56c-.73.68-1.68 1.09-2.61 1.09-2.26 0-4.08-1.82-4.08-4.08s1.82-4.08 4.08-4.08c1.78 0 2.87.82 3.49 1.45l1.64-1.61C13.25 4.54 11.66 4 10 4z"/></svg>
                                Google İle Giriş Yap
                            </button>
                            <p class="text-xs text-gray-400 mt-4">${firebaseStatusText}</p>
                        </div>
                    </div>
                `;
                document.getElementById('signInButton')?.addEventListener('click', handleGoogleSignIn);
                return;
            }

            // --- ANA UYGULAMA EKRANI (Admin/Master) ---
            const isPatron = userRole === 'Admin';
            const sortedJobs = jobs.slice().sort((a, b) => {
                const isAComplete = a.totalProgress === 100;
                const isBComplete = b.totalProgress === 100;
                
                if (isAComplete && !isBComplete) return 1;
                if (!isAComplete && isBComplete) return -1;
                return a.name.localeCompare(b.name);
            });

            const jobsHtml = sortedJobs.map(job => 
                isPatron ? createPatronJobCard(job) : createMasterJobCard(job)
            ).join('');

            app.innerHTML = `
                <header class="bg-white shadow-md p-4 sticky top-0 z-10">
                    <div class="max-w-7xl mx-auto flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-indigo-700">Erolpen İş Takip (${userRole})</h1>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-600 font-medium">${userName}</span>
                            <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                                Çıkış Yap
                            </button>
                        </div>
                    </div>
                </header>

                <main class="max-w-7xl mx-auto p-4 md:p-6">
                    ${isPatron ? renderAdminPanel() : ''}

                    <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">
                        ${isPatron ? 'Tüm Projeler (Patron Görünümü)' : 'Atanan İşler (Usta Görünümü)'}
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${jobsHtml.length > 0 ? jobsHtml : 
                            `<p class="col-span-full text-center text-gray-500 p-10 bg-white rounded-xl shadow-lg">
                                ${isPatron ? 'Henüz hiç iş oluşturulmamış.' : 'Size atanmış aktif bir iş bulunmamaktadır.'}
                            </p>`
                        }
                    </div>
                </main>
                <footer class="text-center text-xs text-gray-400 p-4 mt-8 border-t">
                    Firebase Status: ${firebaseStatusText} | UID: ${userIdDisplay}
                </footer>
            `;

            // Olay Dinleyicileri Ekleme
            document.getElementById('logoutButton')?.addEventListener('click', handleLogout);
            document.getElementById('assignRoleForm')?.addEventListener('submit', handleAssignRole);
            document.getElementById('addJobForm')?.addEventListener('submit', handleAddJob);

            // İlerleme Güncelleme Dinleyicisi
            document.querySelectorAll('.progress-input').forEach(input => {
                const jobId = input.dataset.jobId;
                const stageIndex = parseInt(input.dataset.stageIndex);
                // input değiştiğinde veya odağı kaybettiğinde güncelle
                input.addEventListener('change', (e) => handleUpdateStageProgress(jobId, stageIndex, e.target.value));
                input.addEventListener('blur', (e) => handleUpdateStageProgress(jobId, stageIndex, e.target.value));
            });

            // Not Ekleme Dinleyicisi (Düzeltildi)
            document.querySelectorAll('.note-form').forEach(form => {
                form.removeEventListener('submit', handleNoteFormSubmit);
                form.addEventListener('submit', handleNoteFormSubmit);
            });
        };

        // Uygulamayı Başlat
        initializeFirebase();
    </script>
</body>
</html>
