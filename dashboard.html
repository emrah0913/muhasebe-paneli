<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atölye Yönetim Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
            authDomain: "kibrissiparissistemi.firebaseapp.com",
            projectId: "kibrissiparissistemi",
            storageBucket: "kibrissiparissistemi.appspot.com",
            messagingSenderId: "263531733235",
            appId: "1:263531733235:web:82efdf39ed758a22465786",
            measurementId: "G-JK5S6L90Q5"
        };

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.storage = getStorage(app);
        window.functions = getFunctions(app);
        window.fb = { onAuthStateChanged, signOut, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, query, orderBy, serverTimestamp, ref, uploadBytes, getDownloadURL, deleteObject, httpsCallable };
        window.firebaseReady = true; 

        setPersistence(window.auth, browserLocalPersistence)
          .catch((error) => { console.error("Oturum kalıcılığı ayarlanırken hata:", error); });
        
        console.log("Firebase başarıyla başlatıldı.");

        const alpineScript = document.createElement('script');
        alpineScript.src = 'https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js';
        alpineScript.defer = true;
        document.head.appendChild(alpineScript);
        console.log("Alpine.js yüklemesi manuel olarak tetiklendi.");
    </script>
    
    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .sidebar-link:hover { background-color: #374151; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        .stat-card { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .status-badge { padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
        .highlight-new { animation: highlight 2s ease-out; }
        @keyframes highlight { 0% { background-color: #fefcbf; } 100% { background-color: transparent; } }
        @media print { /* stiller... */ }
    </style>
</head>
<body x-data="appState()" x-init="init()">

    <div x-show="!appReady" x-cloak class="flex items-center justify-center h-screen bg-gray-100">
        <div class="text-center">
            <p class="text-lg font-semibold text-gray-700">Yükleniyor...</p>
            <p class="text-sm text-gray-500">Giriş durumu kontrol ediliyor.</p>
        </div>
    </div>

    <div x-show="appReady" x-cloak class="flex h-screen bg-gray-100 font-sans no-print">
        <nav class="flex flex-col w-64 bg-gray-800 text-white">
            <div class="flex items-center justify-center h-20 border-b border-gray-700"><h1 class="text-2xl font-bold">Atölye Paneli</h1></div>
            <div class="flex-1 px-4 py-6 space-y-1">
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'dashboard'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'dashboard'}">Gösterge Paneli</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'cariler'; viewingCustomer = null" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'cariler'}">Cariler</a>
                <a href="#" @click.prevent="activeTab = 'siparisler'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'siparisler'}">Siparişler</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'stok'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'stok'}">Stok Takibi</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'giderler'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'giderler'}">Giderler</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'personeller'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'personeller'}">Personeller</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'kasa'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'kasa'}">Kasa</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'users'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'users'}">Kullanıcı Yönetimi</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'formlar'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'formlar'}">Formlar</a>
            </div>
            <div class="mt-auto p-4 border-t border-gray-700"><button @click="signOut()" class="w-full text-left flex items-center px-4 py-2 rounded-lg sidebar-link">Çıkış Yap</button></div>
        </nav>

        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            
            <div x-show="activeTab === 'dashboard'" x-cloak>
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Gösterge Paneli</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="stat-card"><h3 class="text-gray-500 font-semibold">TOPLAM MÜŞTERİ</h3><p class="text-4xl font-bold text-indigo-600 mt-2" x-text="customers.length"></p></div>
                    <div class="stat-card"><h3 class="text-gray-500 font-semibold">AKTİF SİPARİŞLER</h3><p class="text-4xl font-bold text-blue-600 mt-2" x-text="orders.filter(o => !['Teslim Edildi', 'İptal Edildi'].includes(o.status)).length"></p></div>
                    <div class="stat-card"><h3 class="text-gray-500 font-semibold">PERSONEL SAYISI</h3><p class="text-4xl font-bold text-teal-600 mt-2" x-text="personnel.length"></p></div>
                    <div class="stat-card" :class="cashFlowTotals.net >= 0 ? 'bg-green-50' : 'bg-red-50'"><h3 class="font-semibold" :class="cashFlowTotals.net >= 0 ? 'text-green-800' : 'text-red-800'">NET KASA DURUMU</h3><p class="text-4xl font-bold mt-2" :class="cashFlowTotals.net >= 0 ? 'text-green-600' : 'text-red-600'" x-text="formatCurrency(cashFlowTotals.net)"></p></div>
                </div>
            </div>
            
            <div x-show="activeTab === 'cariler'" x-cloak>
                <div x-show="!viewingCustomer" x-transition>
                    <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Müşteriler</h2><button @click="openModal('newCustomer')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Yeni Müşteri Ekle</button></div>
                    <div class="mb-4"><input type="text" x-model="searchTerm" placeholder="Müşteri No, Ad veya Telefon ile Ara..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50"><tr><th class="p-3">No</th><th>Adı Soyadı</th><th>Telefon</th><th class="text-right">Bakiye</th><th>İşlemler</th></tr></thead>
                            <tbody>
                                <template x-for="customer in filteredCustomers" :key="customer.id"><tr class="border-b hover:bg-gray-50"><td class="p-3 font-mono font-bold" x-text="customer.id"></td><td x-text="customer.name"></td><td x-text="customer.phone"></td><td class="text-right font-semibold" :class="getCustomerBalance(customer.id).balance > 0 ? 'text-red-600' : 'text-green-600'" x-text="formatCurrency(getCustomerBalance(customer.id).balance)"></td><td><button @click="viewCustomerDetail(customer)" class="text-indigo-600 hover:underline">Detay</button> <button @click="deleteDocAndFiles('customers', customer.id.toString(), customer.projectFileUrl ? [customer.projectFileUrl] : [])" class="text-red-600 hover:underline ml-2">Sil</button></td></tr></template>
                                <tr x-show="filteredCustomers.length === 0"><td colspan="5" class="text-center p-6 text-gray-500">Müşteri bulunamadı.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <template x-if="viewingCustomer">
                    <div x-transition x-cloak>
                        <div class="mb-6"><a href="#" @click.prevent="viewingCustomer = null" class="text-indigo-600 hover:underline flex items-center">&larr; Müşteri Listesine Dön</a><h2 class="text-3xl font-bold text-gray-800 mt-2" x-text="viewingCustomer.name"></h2></div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md"><h3 class="font-bold text-lg mb-2">Müşteri Bilgileri</h3><p><strong>Telefon:</strong> <span x-text="viewingCustomer.phone"></span></p><p><strong>Adres:</strong> <span x-text="viewingCustomer.address"></span></p></div>
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="font-bold text-lg mb-2">Finansal Durum</h3><p class="text-4xl font-bold" :class="getCustomerBalance(viewingCustomer.id).balance > 0 ? 'text-red-500' : 'text-green-500'" x-text="formatCurrency(getCustomerBalance(viewingCustomer.id).balance)"></p><button @click="openModal('newPayment', viewingCustomer)" class="w-full mt-2 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-bold">ÖDEME EKLE</button></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                            <h3 class="font-bold text-lg mb-2">Proje Dosyası Yönetimi</h3>
                            <template x-if="viewingCustomer.projectFileUrl"><a :href="viewingCustomer.projectFileUrl" target="_blank" class="text-indigo-600 hover:underline font-semibold">Yüklenen Projeyi Gör</a></template>
                            <template x-if="!viewingCustomer.projectFileUrl"><p class="text-gray-500">Bu müşteri için henüz proje dosyası yüklenmemiş.</p></template>
                            <div class="mt-4">
                                <input type="file" class="hidden" :id="'project-upload-' + viewingCustomer.id" @change="uploadProjectFile(viewingCustomer, $event)">
                                <template x-if="viewingCustomer.isProjectUploading"><span class="text-sm text-gray-500">Proje Yükleniyor...</span></template>
                                <template x-if="!viewingCustomer.isProjectUploading"><label :for="'project-upload-' + viewingCustomer.id" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer">Proje Yükle / Değiştir</label></template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="activeTab === 'siparisler'" x-cloak>
                 <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Sipariş Yönetimi</h2><button x-show="userRole === 'admin'" @click="openModal('newOrder')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Yeni Sipariş Ekle</button></div>
                 <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                     <table class="w-full text-left">
                        <thead><tr><th class="p-3">Kod/Müşteri</th><th>Ürün & Dosyalar</th><th>Durum</th><th x-show="userRole === 'admin'" class="text-right">Tutar</th><th x-show="userRole === 'admin'">İşlem</th></tr></thead>
                        <tbody>
                            <template x-for="order in sortedOrders" :key="order.id">
                                <tr class="border-b hover:bg-gray-50" :class="{ 'highlight-new': order.isNew }">
                                    <td class="p-3"><p class="font-mono font-bold" x-text="order.code"></p><p class="text-sm text-gray-600" x-text="customers.find(c=>c.id == order.customerId)?.name || '...'"></p></td>
                                    <td>
                                        <p x-text="order.product"></p>
                                        <div class="flex items-center space-x-4 mt-2">
                                            <template x-if="getProjectUrlForOrder(order)"><a :href="getProjectUrlForOrder(order)" target="_blank" class="text-green-600 hover:underline text-sm font-bold">&#128221; Projeyi Gör</a></template>
                                            <div class="relative">
                                                <input type="file" accept="image/*" class="hidden" :id="'file-upload-' + order.id" @change="uploadPhoto(order, $event)">
                                                <template x-if="order.isUploading"><span class="text-sm text-gray-500">Yükleniyor...</span></template>
                                                <template x-if="!order.isUploading">
                                                    <a x-show="order.photoUrl" :href="order.photoUrl" target="_blank" class="text-indigo-600 hover:underline text-sm font-semibold">&#128247; Fotoğrafı Gör</a>
                                                    <label :for="'file-upload-' + order.id" class="text-blue-600 hover:underline text-sm cursor-pointer">[Ekle/Değiştir]</label>
                                                </template>
                                            </div>
                                        </div>
                                        <p x-show="order.deliveryNote && userRole === 'admin'" class="text-sm text-red-600 mt-1"><strong>Not:</strong> <span x-text="order.deliveryNote"></span></p>
                                    </td>
                                    <td>
                                        <div class="relative" x-data="{ open: false }"><button @click="open = !open" class="status-badge" :class="getStatusColor(order.status)"><span x-text="order.status"></span> &darr;</button><div x-show="open" @click.away="open = false" x-transition class="absolute z-10 mt-1 w-48 bg-white rounded-md shadow-lg border"><template x-for="status in availableStatuses" :key="status"><a href="#" @click.prevent="changeOrderStatus(order, status); open = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" x-text="status"></a></template></div></div>
                                    </td>
                                    <td x-show="userRole === 'admin'" class="text-right font-semibold" x-text="formatCurrency(order.price)"></td>
                                    <td x-show="userRole === 'admin'"><button @click="deleteDocAndFiles('orders', order.id, order.photoUrl ? [order.photoUrl] : [])" class="text-red-600 hover:underline">Sil</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                 </div>
            </div>
            
            <div x-show="activeTab === 'stok'" x-cloak>
                <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Stok Takibi</h2><button @click="openModal('newStock')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Yeni Malzeme Ekle</button></div>
                <div class="bg-white p-6 rounded-lg shadow-md"><table class="w-full text-left"><thead class="bg-gray-50"><tr><th class="p-3">Malzeme Adı</th><th>Miktar</th><th>Birim</th><th>İşlem</th></tr></thead><tbody><template x-for="item in stock" :key="item.id"><tr class="border-b hover:bg-gray-50"><td class="p-3 font-semibold" x-text="item.name"></td><td x-text="item.quantity"></td><td class="text-gray-500" x-text="item.unit"></td><td><button @click="deleteDocAndFiles('stock', item.id)" class="text-red-600 hover:underline">Sil</button></td></tr></template></tbody></table></div>
            </div>

            <div x-show="activeTab === 'giderler'" x-cloak>
                <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Gider Yönetimi</h2><button @click="openModal('newExpense')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Yeni Gider Ekle</button></div>
                 <div class="bg-white p-6 rounded-lg shadow-md"><table class="w-full text-left"><thead class="bg-gray-50"><tr><th class="p-3">Tarih</th><th>Kategori</th><th>Açıklama</th><th class="text-right">Tutar</th><th>İşlem</th></tr></thead><tbody><template x-for="expense in expenses" :key="expense.id"><tr class="border-b hover:bg-gray-50"><td class="p-3" x-text="expense.date"></td><td><span class="status-badge text-gray-800 bg-gray-200" x-text="expense.category"></span></td><td x-text="expense.description"></td><td class="text-right font-bold text-red-600" x-text="formatCurrency(expense.amount)"></td><td><button @click="deleteDocAndFiles('expenses', expense.id)" class="text-red-600 hover:underline">Sil</button></td></tr></template></tbody></table></div>
            </div>

            <div x-show="activeTab === 'personeller'" x-cloak>
                <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Personel Yönetimi</h2><button @click="openModal('newPersonnel')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Yeni Personel Ekle</button></div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50"><tr><th class="p-3">Adı Soyadı</th><th>Maaş Bilgisi</th><th class="text-right">Kalan Maaş</th><th class="text-center">İşlemler</th></tr></thead><tbody><template x-for="p in personnel" :key="p.id"><tr class="border-b hover:bg-gray-50"><td class="p-3 font-semibold" x-text="p.name"></td><td x-text="formatCurrency(p.salary) + ' / ' + p.salaryType"></td><td class="text-right font-bold" :class="getPersonnelBalance(p.id) > 0 ? 'text-red-600' : 'text-green-600'" x-text="formatCurrency(getPersonnelBalance(p.id))"></td><td class="text-center space-x-2"><button @click="openModal('newPersonnelPayment', p)" class="text-sm bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded">Ödeme Yap</button><button @click="deleteDocAndFiles('personnel', p.id)" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded">Sil</button></td></tr></template></tbody></table></div>
            </div>

            <div x-show="activeTab === 'users'" x-cloak>
                 <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Kullanıcı Yönetimi</h2><button @click="openModal('newUser')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Yeni Kullanıcı Ekle</button></div>
                 <div class="bg-white p-6 rounded-lg shadow-md"><table class="w-full text-left"><thead><tr><th class="p-3">E-posta</th><th>Rol</th><th>İşlem</th></tr></thead><tbody><template x-for="user in users" :key="user.id"><tr class="border-b">
                    <td class="p-3" x-text="user.email"></td>
                    <td><span class="status-badge bg-gray-200" x-text="user.role"></span></td>
                    <td><button @click="deleteUser(user.id)" class="text-red-600 hover:underline disabled:opacity-50" :disabled="users.length <= 1">Sil</button></td>
                </tr></template></tbody></table></div>
            </div>
            
        </main>
    </div>
    
    <div x-show="isModalOpen" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 no-print" @click.away="isModalOpen = false">
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-lg" @click.stop>
            </div>
    </div>

<script>
    function appState() {
        return {
            appReady: false, activeTab: 'dashboard', userRole: 'uretici', isModalOpen: false, modalType: '', isLoading: false,
            searchTerm: '', viewingCustomer: null, customerDetailTab: 'active',
            newCustomer: {}, newOrder: {}, newExpense: {}, newStock: {}, newPayment: {}, newPersonnel: {}, newPersonnelPayment: {}, payingPersonnel: null,
            newUser: { email: '', password: '', role: 'uretici' }, payingCustomer: null,
            customers: [], orders: [], payments: [], stock: [], expenses: [], personnel: [], personnelPayments: [], users: [],
            availableStatuses: ['Onaylandı', 'Üretimde', 'Hazır', 'Teslim Edildi', 'Eksik Var', 'İptal Edildi'],

            get filteredCustomers() { if (!this.searchTerm) return this.customers; const s = this.searchTerm.toLowerCase(); return this.customers.filter(c => c.name.toLowerCase().includes(s) || (c.phone && c.phone.includes(s)) || c.id.toString().includes(s)); },
            get sortedOrders() { return [...this.orders].sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); },
            get cashFlowTotals() { const income = this.payments.reduce((s, p) => s + (p.amount || 0), 0); const expense = this.expenses.reduce((s, e) => s + (e.amount || 0), 0); return { income, expense, net: income - expense }; },
            
            init() {
                if (typeof window.firebaseReady === 'undefined') { setTimeout(() => this.init(), 100); return; }
                
                fb.onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        try {
                            const tokenResult = await user.getIdTokenResult(true);
                            this.userRole = tokenResult.claims.role || 'uretici'; 
                            this.activeTab = (this.userRole === 'admin') ? 'dashboard' : 'siparisler';
                            this.setupRealtimeListeners();
                            this.appReady = true;
                        } catch (error) {
                            console.error("Token alınırken hata, çıkış yapılıyor.", error);
                            await fb.signOut(window.auth);
                        }
                    } else {
                        if (!window.location.pathname.includes('index.html')) { window.location.href = 'index.html'; }
                    }
                });
            },
            setupRealtimeListeners() {
                const listenTo = (collectionName, targetArray, orderByField = 'createdAt', orderDirection = 'desc') => {
                    const q = fb.query(fb.collection(window.db, collectionName), fb.orderBy(orderByField, orderDirection));
                    fb.onSnapshot(q, (snapshot) => {
                        this[targetArray] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                };
                listenTo('customers', 'customers', 'name', 'asc');
                listenTo('orders', 'orders');
                listenTo('personnel', 'personnel', 'name', 'asc');
                listenTo('stock', 'stock', 'name', 'asc');
                listenTo('expenses', 'expenses');
                listenTo('payments', 'payments');
                listenTo('personnelPayments', 'personnelPayments');
                listenTo('users', 'users', 'email', 'asc');
            },
            openModal(type, data = null) {
                this.modalType = type;
                if (type === 'newCustomer') { const nextId = (this.customers.length > 0 ? Math.max(...this.customers.map(c => parseInt(c.id))) : 100) + 1; this.newCustomer = { id: nextId, name: '', phone: '', address: '' }; }
                if (type === 'newUser') { this.newUser = { email: '', password: '', role: 'uretici' }; }
                if (type === 'newOrder') { this.newOrder = { customerId: '', product: '', price: null }; }
                if (type === 'newPersonnel') { this.newPersonnel = { name: '', salary: null, salaryType: 'Aylık' }; }
                if (type === 'newStock') { this.newStock = { name: '', quantity: null, unit: '' }; }
                if (type === 'newExpense') { this.newExpense = { date: new Date().toLocaleDateString('tr-TR'), category: 'Diğer', description: '', amount: null }; }
                if (type === 'newPersonnelPayment') { this.payingPersonnel = data; this.newPersonnelPayment = { amount: null, description: ''}; }
                if (type === 'newPayment') { this.payingCustomer = data; this.newPayment = { amount: null, description: '' }; }
                this.isModalOpen = true;
            },
            async addCustomer() {
                if (!this.newCustomer.name || !this.newCustomer.id) return alert('Müşteri No ve Adı zorunludur.');
                if (this.customers.some(c => c.id.toString() === this.newCustomer.id.toString())) return alert('Bu Müşteri No zaten kullanılıyor.');
                const newCustomerData = { ...this.newCustomer, id: parseInt(this.newCustomer.id), createdAt: fb.serverTimestamp(), projectFileUrl: '', isProjectUploading: false };
                await fb.setDoc(fb.doc(window.db, 'customers', newCustomerData.id.toString()), newCustomerData);
                this.isModalOpen = false;
            },
            async addOrder() {
                if (!this.newOrder.customerId || !this.newOrder.product || !this.newOrder.price) return alert('Tüm alanlar zorunludur.');
                const customerOrders = this.orders.filter(o => o.customerId == this.newOrder.customerId);
                const newCount = customerOrders.length > 0 ? Math.max(...customerOrders.map(o => parseInt(o.code.split('-')[1] || 0))) + 1 : 1;
                const newOrderData = { ...this.newOrder, code: `${this.newOrder.customerId}-${newCount}`, customerId: parseInt(this.newOrder.customerId), price: parseFloat(this.newOrder.price), createdAt: fb.serverTimestamp(), deliveryNote: '', photoUrl: '', isUploading: false, status: 'Onaylandı' };
                await fb.addDoc(fb.collection(window.db, 'orders'), newOrderData);
                this.isModalOpen = false;
            },
            async addPersonnel() {
                if (!this.newPersonnel.name || !this.newPersonnel.salary) return alert('Personel Adı ve Maaşı zorunludur.');
                const data = { ...this.newPersonnel, salary: parseFloat(this.newPersonnel.salary), createdAt: fb.serverTimestamp() };
                await fb.addDoc(fb.collection(window.db, 'personnel'), data);
                this.isModalOpen = false;
            },
            async addPersonnelPayment() {
                if (!this.newPersonnelPayment.amount || !this.payingPersonnel) return;
                const paymentData = { personnelId: this.payingPersonnel.id, name: this.payingPersonnel.name, amount: parseFloat(this.newPersonnelPayment.amount), description: this.newPersonnelPayment.description, createdAt: fb.serverTimestamp() };
                await fb.addDoc(fb.collection(window.db, 'personnelPayments'), paymentData);
                const expenseData = { category: 'Personel', description: `${this.payingPersonnel.name} - ${this.newPersonnelPayment.description || 'Maaş Ödemesi'}`, amount: parseFloat(this.newPersonnelPayment.amount), date: new Date().toLocaleDateString('tr-TR'), createdAt: fb.serverTimestamp() };
                await fb.addDoc(fb.collection(window.db, 'expenses'), expenseData);
                this.isModalOpen = false;
            },
            async addStockItem() {
                if (!this.newStock.name || !this.newStock.quantity || !this.newStock.unit) return alert('Tüm alanlar zorunludur.');
                const data = { ...this.newStock, quantity: parseFloat(this.newStock.quantity), name: this.newStock.name.toLowerCase(), createdAt: fb.serverTimestamp() };
                await fb.addDoc(fb.collection(window.db, 'stock'), data);
                this.isModalOpen = false;
            },
            async addExpense() {
                if (!this.newExpense.description || !this.newExpense.amount) return alert('Açıklama ve Tutar zorunludur.');
                const data = { ...this.newExpense, amount: parseFloat(this.newExpense.amount), createdAt: fb.serverTimestamp() };
                await fb.addDoc(fb.collection(window.db, 'expenses'), data);
                this.isModalOpen = false;
            },
            async createNewUser() {
                if (!this.newUser.email || !this.newUser.password) { alert('E-posta ve şifre zorunludur.'); return; }
                this.isLoading = true;
                try {
                    const createUserFunc = fb.httpsCallable(window.functions, 'createNewUser');
                    const result = await createUserFunc({ email: this.newUser.email, password: this.newUser.password, role: this.newUser.role });
                    alert(result.data.result);
                    this.isModalOpen = false;
                } catch (error) { console.error("Kullanıcı oluşturma hatası:", error); alert("Hata: " + error.message); }
                finally { this.isLoading = false; }
            },
            async changeOrderStatus(order, newStatus) {
                let updatedData = { status: newStatus };
                if (newStatus === 'Eksik Var') {
                    const note = prompt('Lütfen açıklama giriniz:', order.deliveryNote || '');
                    if (note !== null) updatedData.deliveryNote = note;
                } else { updatedData.deliveryNote = ''; }
                await fb.updateDoc(fb.doc(window.db, 'orders', order.id), updatedData);
            },
            async deleteDocAndFiles(collectionName, docId, filePaths = []) {
                if (!confirm('Bu kaydı kalıcı olarak silmek istediğinizden emin misiniz?')) return;
                try {
                    for (const path of filePaths) { if (path) { const fileRef = fb.ref(window.storage, path); await fb.deleteObject(fileRef).catch(e => console.warn("Dosya silinemedi:", e.code)); } }
                    await fb.deleteDoc(fb.doc(window.db, collectionName, docId.toString()));
                    alert('Kayıt başarıyla silindi.');
                } catch (error) { console.error("Silme hatası:", error); alert("Kayıt silinirken bir hata oluştu."); }
            },
            async uploadFile(file, path) {
                if (!file) return null;
                const fileRef = fb.ref(window.storage, path);
                await fb.uploadBytes(fileRef, file);
                return await fb.getDownloadURL(fileRef);
            },
            async uploadPhoto(order, event) {
                const file = event.target.files[0]; if (!file) return;
                order.isUploading = true;
                const url = await this.uploadFile(file, `orders/${order.id}/${Date.now()}-${file.name}`);
                if (url) await fb.updateDoc(fb.doc(window.db, 'orders', order.id), { photoUrl: url });
                order.isUploading = false;
                event.target.value = null;
            },
            async uploadProjectFile(customer, event) {
                const file = event.target.files[0]; if(file) customer.isProjectUploading = true;
                const url = await this.uploadFile(file, `projects/${customer.id}/${file.name}`);
                if (url) await fb.updateDoc(fb.doc(window.db, 'customers', customer.id.toString()), { projectFileUrl: url });
                customer.isProjectUploading = false;
                event.target.value = null;
            },
            async signOut() { if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) { await fb.signOut(window.auth); }},
            
            getProjectUrlForOrder(order) { return this.customers.find(c => c.id == order.customerId)?.projectFileUrl || null; },
            getCustomerBalance(customerId) { const totalOrders = this.orders.filter(o => o.customerId == customerId && o.status !== 'İptal Edildi').reduce((s, o) => s + (o.price || 0), 0); const totalPayments = this.payments.filter(p => p.customerId == customerId).reduce((s, p) => s + (p.amount || 0), 0); return { balance: totalOrders - totalPayments }; },
            getPersonnelBalance(personnelId) { const p = this.personnel.find(p => p.id === personnelId); if (!p) return 0; const totalPayments = this.personnelPayments.filter(payment => payment.personnelId === personnelId).reduce((sum, payment) => sum + (payment.amount || 0), 0); return p.salary - totalPayments; },
            formatCurrency(amount) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(amount != null ? amount : 0); },
            getStatusColor(status) { return {'Onaylandı':'bg-gray-200','Üretimde':'text-blue-800 bg-blue-200','Hazır':'text-teal-800 bg-teal-200','Teslim Edildi':'text-green-800 bg-green-200','Eksik Var':'text-yellow-800 bg-yellow-200','İptal Edildi':'text-red-800 bg-red-200'}[status] || 'bg-gray-200'; },
            viewCustomerDetail(customer) { this.viewingCustomer = customer; this.activeTab = 'cariler'; this.customerDetailTab = 'active'; }
        }
    }
</script>
</body>
</html>
