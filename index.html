<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>İş Takip Paneli</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800" x-data="panel()" x-init="init()">

  <!-- GİRİŞ EKRANI -->
  <div x-show="!user" class="flex flex-col items-center justify-center h-screen space-y-4">
    <h1 class="text-2xl font-bold">İş Takip Paneli</h1>
    <button @click="googleLogin"
      class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
      Google ile Giriş Yap
    </button>
  </div>

  <!-- ANA PANEL -->
  <div x-show="user" class="p-6" x-cloak>
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold">Hoş geldin, <span x-text="user.displayName"></span></h2>
      <button @click="logout" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">Çıkış</button>
    </div>

    <!-- SADECE ADMIN GÖRÜR -->
    <template x-if="role === 'admin'">
      <div class="space-y-4">
        <h3 class="text-lg font-semibold">İş Atama</h3>
        <input x-model="newJob.projeAdi" type="text" placeholder="Proje Adı" class="border p-2 rounded w-full" />
        <input x-model="newJob.usta" type="text" placeholder="Usta (email)" class="border p-2 rounded w-full" />
        <input x-model="newJob.baslama" type="date" class="border p-2 rounded w-full" />
        <input x-model="newJob.teslim" type="date" class="border p-2 rounded w-full" />
        <button @click="addJob" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">İş Ata</button>
      </div>
    </template>

    <!-- TÜM KULLANICILAR GÖRÜR -->
    <div class="mt-8">
      <h3 class="text-lg font-semibold mb-2">İş Listesi</h3>
      <template x-if="jobs.length === 0">
        <p class="text-gray-500">Henüz iş yok.</p>
      </template>
      <div class="space-y-2">
        <template x-for="(job, i) in jobs" :key="i">
          <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
            <div>
              <p class="font-semibold" x-text="job.projeAdi"></p>
              <p class="text-sm text-gray-500">Başlama: <span x-text="job.baslama"></span> | Teslim: <span x-text="job.teslim"></span></p>
              <p class="text-sm text-gray-600">Durum: <span x-text="job.yuzde + '%'"></span></p>
            </div>
            <template x-if="role !== 'admin'">
              <input type="number" min="0" max="100" class="border p-1 w-20 text-center rounded"
                x-model.number="job.yuzde"
                @change="updateProgress(job)">
            </template>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
      authDomain: "kibrissiparissistemi.firebaseapp.com",
      databaseURL: "https://kibrissiparissistemi-default-rtdb.firebaseio.com",
      projectId: "kibrissiparissistemi",
      storageBucket: "kibrissiparissistemi.firebasestorage.app",
      messagingSenderId: "263531733235",
      appId: "1:263531733235:web:82efdf39ed758a22465786",
      measurementId: "G-JK5S6L90Q5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.panel = function () {
      return {
        user: null,
        role: null,
        jobs: [],
        newJob: { projeAdi: '', usta: '', baslama: '', teslim: '', yuzde: 0 },

        async init() {
          onAuthStateChanged(auth, async (usr) => {
            if (usr) {
              this.user = usr;
              const roleRef = doc(db, "users", usr.uid);
              const roleSnap = await getDoc(roleRef);
              if (roleSnap.exists()) {
                this.role = roleSnap.data().role;
              } else {
                await setDoc(roleRef, { email: usr.email, role: "usta" });
                this.role = "usta";
              }
              this.loadJobs();
            } else {
              this.user = null;
              this.role = null;
              this.jobs = [];
            }
          });
        },

        async googleLogin() {
          const provider = new GoogleAuthProvider();
          await signInWithPopup(auth, provider);
        },

        async logout() {
          await signOut(auth);
        },

        async addJob() {
          if (!this.newJob.projeAdi || !this.newJob.usta) return alert("Tüm alanları doldurun!");
          await addDoc(collection(db, "jobs"), {
            projeAdi: this.newJob.projeAdi,
            usta: this.newJob.usta,
            baslama: this.newJob.baslama,
            teslim: this.newJob.teslim,
            yuzde: 0,
            createdAt: Date.now()
          });
          alert("İş atandı!");
          this.newJob = { projeAdi: '', usta: '', baslama: '', teslim: '', yuzde: 0 };
          this.loadJobs();
        },

        async loadJobs() {
          const q = this.role === "admin"
            ? query(collection(db, "jobs"))
            : query(collection(db, "jobs"), where("usta", "==", this.user.email));

          const snap = await getDocs(q);
          this.jobs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        },

        async updateProgress(job) {
          await updateDoc(doc(db, "jobs", job.id), { yuzde: job.yuzde });
        }
      };
    };
  </script>
</body>
</html>
