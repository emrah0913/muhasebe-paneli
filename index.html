<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atölye Yönetim Paneli - Firebase Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <script type="module">
        // Firebase modüllerini içe aktar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // Firebase yapılandırman
        const firebaseConfig = {
            apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
            authDomain: "kibrissiparissistemi.firebaseapp.com",
            projectId: "kibrissiparissistemi",
            storageBucket: "kibrissiparissistemi.appspot.com",
            messagingSenderId: "263531733235",
            appId: "1:263531733235:web:82efdf39ed758a22465786",
            measurementId: "G-JK5S6L90Q5"
        };

        // Firebase'i başlat ve servisleri dışarıya aç
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.storage = getStorage(app);
        window.fb = { collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, query, orderBy, ref, uploadBytes, getDownloadURL };
        console.log("Firebase başarıyla başlatıldı ve global olarak erişilebilir ✅");
    </script>
    
    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .sidebar-link:hover { background-color: #374151; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        .stat-card { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .status-badge { padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
        .highlight-new { animation: highlight 2s ease-out; }
        @keyframes highlight {
            0% { background-color: #fefcbf; } /* yellow-100 */
            100% { background-color: transparent; }
        }
        @media print { /* ... stiller ... */ }
    </style>
</head>
<body x-data="appState()" x-init="init()">

    <div class="flex h-screen bg-gray-100 font-sans no-print">
        <nav class="flex flex-col w-64 bg-gray-800 text-white">
            <div class="flex items-center justify-center h-20 border-b border-gray-700"><h1 class="text-2xl font-bold">Atölye Paneli</h1></div>
            <div class="flex-1 px-4 py-6 space-y-1">
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'dashboard'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'dashboard'}">Gösterge Paneli</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'cariler'; viewingCustomer = null;" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'cariler'}">Cariler</a>
                <a href="#" @click.prevent="activeTab = 'siparisler'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'siparisler'}">Siparişler</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'stok'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'stok'}">Stok Takibi</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'giderler'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'giderler'}">Giderler</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'personeller'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'personeller'}">Personeller</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'kasa'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'kasa'}">Kasa</a>
                <a href="#" x-show="userRole === 'admin'" @click.prevent="activeTab = 'formlar'" class="flex items-center px-4 py-2 rounded-lg sidebar-link" :class="{'active': activeTab === 'formlar'}">Formlar</a>
            </div>
        </nav>

        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            <div x-show="activeTab === 'dashboard' && userRole === 'admin'" x-cloak>
                 </div>
            
            <div x-show="activeTab === 'cariler' && userRole === 'admin'" x-cloak>
                <div x-show="viewingCustomer" x-transition x-cloak>
                    <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                        <h3 class="font-bold text-lg mb-2">Proje Dosyası Yönetimi</h3>
                        <template x-if="viewingCustomer.projectFileUrl">
                            <a :href="viewingCustomer.projectFileUrl" target="_blank" class="text-indigo-600 hover:underline font-semibold">Yüklenen Projeyi Gör</a>
                        </template>
                        <template x-if="!viewingCustomer.projectFileUrl">
                            <p class="text-gray-500">Bu müşteri için henüz proje dosyası yüklenmemiş.</p>
                        </template>
                        <div class="mt-4">
                            <input type="file" class="hidden" :id="'project-upload-' + viewingCustomer.id" @change="uploadProjectFile(viewingCustomer, $event)">
                            <template x-if="viewingCustomer.isProjectUploading">
                                <span class="text-sm text-gray-500">Proje Yükleniyor...</span>
                            </template>
                            <template x-if="!viewingCustomer.isProjectUploading">
                                <label :for="'project-upload-' + viewingCustomer.id" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer">Proje Yükle / Değiştir</label>
                            </template>
                        </div>
                    </div>
                     </div>
            </div>

            <div x-show="activeTab === 'siparisler'" x-cloak>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="p-3">Kod/Müşteri</th>
                                <th>Ürün & Dosyalar</th>
                                <th>Durum</th>
                                <th x-show="userRole === 'admin'" class="text-right">Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="order in sortedOrders" :key="order.id">
                                <tr class="border-b hover:bg-gray-50" :class="{ 'highlight-new': order.isNew }">
                                    <td class="p-3">
                                        <p class="font-mono font-bold" x-text="order.code"></p>
                                        <p class="text-sm text-gray-600" x-text="customers.find(c=>c.id === order.customerId)?.name || '...'"></p>
                                    </td>
                                    <td>
                                        <p x-text="order.product"></p>
                                        <div class="flex items-center space-x-4 mt-2">
                                            <template x-if="getProjectUrlForOrder(order)">
                                                <a :href="getProjectUrlForOrder(order)" target="_blank" class="text-green-600 hover:underline text-sm font-bold">&#128221; Projeyi Gör</a>
                                            </template>
                                            <div class="relative">
                                                <input type="file" accept="image/*" class="hidden" :id="'file-upload-' + order.id" @change="uploadPhoto(order, $event)">
                                                <template x-if="order.isUploading"><span class="text-sm text-gray-500">Yükleniyor...</span></template>
                                                <template x-if="!order.isUploading">
                                                     <a x-show="order.photoUrl" :href="order.photoUrl" target="_blank" class="text-indigo-600 hover:underline text-sm font-semibold">&#128247; Fotoğrafı Gör</a>
                                                    <label :for="'file-upload-' + order.id" class="text-blue-600 hover:underline text-sm cursor-pointer">[Ekle/Değiştir]</label>
                                                </template>
                                            </div>
                                        </div>
                                        <p x-show="order.deliveryNote && userRole === 'admin'" class="text-sm text-red-600 mt-1"><strong>Not:</strong> <span x-text="order.deliveryNote"></span></p>
                                    </td>
                                    <td></td>
                                    <td x-show="userRole === 'admin'" class="text-right font-semibold" x-text="formatCurrency(order.price)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            </main>
    </div>

<script>
    function appState() {
        return {
            // --- STATE ---
            activeTab: 'dashboard', 
            userRole: 'admin',
            isModalOpen: false, 
            modalType: '', 
            // ... diğer state'ler

            // --- VERİ DİZİLERİ ---
            customers: [], orders: [], payments: [], stock: [], expenses: [], personnel: [], personnelPayments: [],
            
            // --- HESAPLANMIŞ DEĞERLER (GETTERS) ---
            get sortedOrders() { return [...this.orders].sort((a, b) => (a.createdAt?.seconds || 0) < (b.createdAt?.seconds || 0) ? 1 : -1); },
            // ... diğer getter'lar ...

            // --- BAŞLATMA ve VERİ YÖNETİMİ ---
            init() {
                const urlParams = new URLSearchParams(window.location.search);
                const view = urlParams.get('view');
                if (view === 'teslimatci' || view === 'uretici') {
                    this.userRole = view;
                    this.activeTab = 'siparisler';
                }
                this.setupRealtimeListeners();
            },

            setupRealtimeListeners() {
                const q = fb.query(fb.collection(window.db, "orders"), fb.orderBy("createdAt", "desc"));
                fb.onSnapshot(q, (snapshot) => {
                    if (this.orders.length > 0 && snapshot.docs.length > this.orders.length) {
                        new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_75153e72b4.mp3').play();
                    }
                    this.orders = snapshot.docs.map(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        const existing = this.orders.find(o => o.id === doc.id);
                        data.isNew = !existing; // Yeni eklenenleri işaretle
                        return data;
                    });
                    // Yeni eklenenlerin highlight'ını kısa süre sonra kaldır
                    setTimeout(() => this.orders.forEach(o => o.isNew = false), 2100);
                });
                
                // Diğer koleksiyonlar için dinleyiciler...
                fb.onSnapshot(fb.collection(window.db, "customers"), snap => this.customers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                fb.onSnapshot(fb.collection(window.db, "personnel"), snap => this.personnel = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                 // ... stok, giderler, ödemeler ...
            },

            // --- CRUD FONKSİYONLARI (Firestore ile) ---
            async addCustomer() {
                // ...
                const newCustomerData = { ...this.newCustomer, projectFileUrl: '', isProjectUploading: false };
                await fb.setDoc(fb.doc(window.db, 'customers', newCustomerData.id.toString()), newCustomerData);
                this.isModalOpen = false;
            },
            async addOrder() {
                // ...
                const newOrderData = { ...this.newOrder, createdAt: new Date(), deliveryNote: '', photoUrl: '', isUploading: false };
                await fb.addDoc(fb.collection(window.db, 'orders'), newOrderData);
                this.isModalOpen = false;
            },
            async changeOrderStatus(order, newStatus) {
                // ...
                let updatedData = { status: newStatus };
                // ... not ekleme mantığı ...
                await fb.updateDoc(fb.doc(window.db, 'orders', order.id), updatedData);
            },
            async uploadFile(file, path) {
                if (!file) return null;
                const fileRef = fb.ref(window.storage, path);
                await fb.uploadBytes(fileRef, file);
                return await fb.getDownloadURL(fileRef);
            },
            async uploadPhoto(order, event) {
                const file = event.target.files[0];
                order.isUploading = true;
                const url = await this.uploadFile(file, `orders/${order.id}/${Date.now()}-${file.name}`);
                if (url) {
                    await fb.updateDoc(fb.doc(window.db, 'orders', order.id), { photoUrl: url });
                }
                order.isUploading = false;
                event.target.value = null;
            },
            async uploadProjectFile(customer, event) {
                const file = event.target.files[0];
                customer.isProjectUploading = true;
                const url = await this.uploadFile(file, `projects/${customer.id}/${file.name}`);
                if (url) {
                    await fb.updateDoc(fb.doc(window.db, 'customers', customer.id), { projectFileUrl: url });
                }
                customer.isProjectUploading = false;
                event.target.value = null;
            },
            getProjectUrlForOrder(order) {
                const customer = this.customers.find(c => c.id === order.customerId);
                return customer ? customer.projectFileUrl : null;
            },
            // ... diğer tüm fonksiyonlar (openModal, delete, hesaplamalar vb.) ...
        }
    }
</script>
</body>
</html>
