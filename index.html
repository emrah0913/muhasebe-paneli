import React, { useState, useEffect, useMemo } from 'react';
import { 
  ShoppingCart, Settings, Package, ChevronRight, Trash2, Plus, Minus, Menu, X,
  Calculator, ClipboardList, Home, ChevronLeft, Info, ChevronDown, LayoutGrid, Printer, User, Eye, Box
} from 'lucide-react';

// --- ADMİN AYARLARI (BAŞLANGIÇ DEĞERLERİ) ---
const INITIAL_SETTINGS = {
  materialPrices: { 'Suntalam': 320, 'MDFlam': 480, 'Lake': 1200, 'Membran': 850, 'Akrilik': 950 },
  glassDoorPrice: 1100, // Camlı kapak m² birim fiyatı
  hardwarePrices: {
    hinges: { 'Blum': 130, 'Hettich': 110, 'Samet': 65 },
    slides: { 'Blum': 480, 'Hettich': 420, 'Samet': 280 },
    slidingSystem: 850,
    liftSystemBrands: { 'Samet': 450, 'Blum': 1200, 'Hettich': 950 }
  },
  laborFactor: 1.4, 
  profitMargin: 1.25
};

// --- ÜRÜN KATALOĞU ---
const PRODUCTS = [
  // ALT DOLAPLAR
  { id: 100, parentCat: 'Alt Dolaplar', subCat: 'Kapaklı', name: 'Kapaklı Alt Dolap', type: 'hinged_base', image: 'https://images.unsplash.com/photo-1556911223-e45242d50730?auto=format&fit=crop&q=80&w=400', defaultWidth: 60, defaultHeight: 72, defaultDepth: 56 },
  { id: 105, parentCat: 'Alt Dolaplar', subCat: 'Köşe', name: 'Köşe Alt Dolap (L)', type: 'corner_base', image: 'https://images.unsplash.com/photo-1556912161-0062402d2948?auto=format&fit=crop&q=80&w=400', defaultWidth: 90, defaultHeight: 72, defaultDepth: 56 },
  { id: 106, parentCat: 'Alt Dolaplar', subCat: 'Kör Köşe', name: 'Kör Alt Dolap', type: 'blind_corner_base', image: 'https://images.unsplash.com/photo-1556911223-e45242d50730?auto=format&fit=crop&q=80&w=400', defaultWidth: 100, defaultHeight: 72, defaultDepth: 56 },
  { id: 2, parentCat: 'Alt Dolaplar', subCat: 'Çekmeceli', name: 'Çekmeceli Alt Dolap', type: 'drawer', image: 'https://images.unsplash.com/photo-1556912170-4537da395983?auto=format&fit=crop&q=80&w=400', defaultWidth: 60, defaultHeight: 72, defaultDepth: 56, drawerCount: 3 },
  
  // ÜST DOLAPLAR
  { id: 201, parentCat: 'Üst Dolaplar', subCat: 'Kapaklı', name: 'Kapaklı Üst Modül', type: 'hinged_upper', image: 'https://images.unsplash.com/photo-1588854337236-6889d631faa8?auto=format&fit=crop&q=80&w=600', defaultWidth: 60, defaultHeight: 60, defaultDepth: 32 },
  { id: 202, parentCat: 'Üst Dolaplar', subCat: 'Devirme', name: 'Devirme Kapak Üst Modül', type: 'lift_upper', image: 'https://images.unsplash.com/photo-1595428774223-ef52624120d2?auto=format&fit=crop&q=80&w=600', defaultWidth: 80, defaultHeight: 40, defaultDepth: 32 },
  { id: 203, parentCat: 'Üst Dolaplar', subCat: 'Kör Köşe', name: 'Kör Üst Modül', type: 'blind_upper', image: 'https://images.unsplash.com/photo-1556911223-e45242d50730?auto=format&fit=crop&q=80&w=600', defaultWidth: 90, defaultHeight: 60, defaultDepth: 32 },
  { id: 204, parentCat: 'Üst Dolaplar', subCat: 'Köşe', name: 'Köşe Üst Modül (L)', type: 'corner_upper', image: 'https://images.unsplash.com/photo-1556912161-0062402d2948?auto=format&fit=crop&q=80&w=600', defaultWidth: 60, defaultHeight: 60, defaultDepth: 32 },
  
  // DUVAR DOLAPLARI
  { id: 300, parentCat: 'Duvar Dolapları', subCat: 'Özel Üretim', name: 'Duvar Ünitesi Dolabı', type: 'wall_cabinet', image: 'https://images.unsplash.com/photo-1618219908412-a29a1bb7b86e?auto=format&fit=crop&q=80&w=400', defaultWidth: 150, defaultHeight: 220, defaultDepth: 60, doorCount: 2 }
];

const App = () => {
  const [view, setView] = useState('home');
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [cart, setCart] = useState([]);
  const [settings, setSettings] = useState(INITIAL_SETTINGS);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [activeFilter, setActiveFilter] = useState({ parent: null });
  const [customer, setCustomer] = useState({ name: '', phone: '', address: '' });
  const [showTeklifPreview, setShowTeklifPreview] = useState(false);

  const [bulkConfig, setBulkConfig] = useState({ bodyMaterial: 'Suntalam', doorMaterial: 'MDFlam', hardwareBrand: 'Samet' });

  useEffect(() => {
    const saved = localStorage.getItem('carpenter_final_v20');
    if (saved) setCart(JSON.parse(saved));
    const savedSettings = localStorage.getItem('carpenter_settings_v1');
    if (savedSettings) setSettings(JSON.parse(savedSettings));
  }, []);

  useEffect(() => {
    localStorage.setItem('carpenter_final_v20', JSON.stringify(cart));
    localStorage.setItem('carpenter_settings_v1', JSON.stringify(settings));
  }, [cart, settings]);

  // --- FİYAT HESAPLAMA MOTORU ---
  const calculateItemPrice = (item, currentSettings) => {
    const { config, product } = item;
    const w1 = parseFloat(config.width) || 0;
    const w2 = parseFloat(config.width2) || 0;
    const w3 = parseFloat(config.width3) || 0;
    const h = parseFloat(config.height) || 0;
    const d = parseFloat(config.depth) || 0;
    const drawerCount = parseInt(config.drawerCount) || 0;
    const shelfCount = parseInt(config.shelfCount) || 0;
    const doorCount = parseInt(config.doorCount) || 1;

    let bodyArea = 0;
    let doorArea = 0;
    let hardwareCost = 0;

    if (product.type === 'wall_cabinet') {
      let totalWidth = w1;
      if (config.cabinetShape === 'L') totalWidth = w1 + w2;
      if (config.cabinetShape === 'U') totalWidth = w1 + w2 + w3;
      bodyArea = ((totalWidth + d) * (h + d)) / 10000;
      doorArea = (totalWidth * h) / 10000; 
      if (config.doorType === 'sliding') hardwareCost += currentSettings.hardwarePrices.slidingSystem || 0;
      else hardwareCost += (Math.ceil(totalWidth / 45) || 2) * 2 * currentSettings.hardwarePrices.hinges[config.hardwareBrand];
    } 
    else if (['corner_base', 'corner_upper'].includes(product.type)) {
      let totalWidth = w1 + w2;
      bodyArea = ((totalWidth * d * 2) + (totalWidth * h)) / 10000;
      bodyArea = bodyArea * 1.25; 
      doorArea = (totalWidth * h) / 10000;
      hardwareCost = doorCount * 2 * currentSettings.hardwarePrices.hinges[config.hardwareBrand];
    }
    else if (['blind_corner_base', 'blind_upper'].includes(product.type)) {
      bodyArea = ((h * d * 2) + (w1 * d * 2) + (w1 * h)) / 10000;
      if (shelfCount > 0) bodyArea += (shelfCount * (w1 * d)) / 10000;
      bodyArea = bodyArea * 1.15;
      doorArea = ((w1 / 2) * h) / 10000;
      hardwareCost = doorCount * 2 * currentSettings.hardwarePrices.hinges[config.hardwareBrand];
    }
    else {
      bodyArea = ((h * d * 2) + (w1 * d * 2) + (w1 * h)) / 10000;
      if (shelfCount > 0) bodyArea += (shelfCount * (w1 * d)) / 10000;
      doorArea = (w1 * h) / 10000;

      if (product.type === 'lift_upper') {
        hardwareCost = currentSettings.hardwarePrices.liftSystemBrands[config.hardwareBrand] || 0;
      } else if (product.type === 'drawer') {
        hardwareCost = drawerCount * currentSettings.hardwarePrices.slides[config.hardwareBrand];
      } else {
        hardwareCost = doorCount * 2 * currentSettings.hardwarePrices.hinges[config.hardwareBrand];
      }
    }

    // Camlı Kapak Farkı: Eğer Camlı seçildiyse kapak maliyeti özel fiyattan hesaplanır
    const doorPrice = config.doorStyle === 'glass' ? currentSettings.glassDoorPrice : currentSettings.materialPrices[config.doorMaterial];
    
    const total = (bodyArea * currentSettings.materialPrices[config.bodyMaterial] + 
                   doorArea * (doorPrice || 0) + 
                   hardwareCost) * currentSettings.laborFactor * currentSettings.profitMargin;
    
    return Math.round(total) || 0;
  };

  const cartTotal = useMemo(() => cart.reduce((sum, item) => sum + (calculateItemPrice(item, settings) * (item.qty || 1)), 0), [cart, settings]);

  const addToCart = (product) => {
    const isSpecial = ['hinged_base', 'corner_base', 'blind_corner_base', 'hinged_upper', 'lift_upper', 'blind_upper', 'corner_upper'].includes(product.type);
    const newItem = {
      id: Date.now(),
      product,
      qty: 1,
      config: {
        width: product.defaultWidth,
        width2: 90, width3: 100,
        height: product.defaultHeight,
        depth: product.defaultDepth,
        bodyMaterial: bulkConfig.bodyMaterial,
        doorMaterial: bulkConfig.doorMaterial,
        hardwareBrand: bulkConfig.hardwareBrand,
        cabinetShape: ['corner_base', 'corner_upper'].includes(product.type) ? 'L' : 'Düz', 
        doorType: product.type === 'lift_upper' ? 'lift' : 'hinged', 
        doorStyle: 'normal', // normal, glass
        drawerCount: product.type === 'drawer' ? 3 : 0,
        shelfCount: isSpecial ? 2 : 0,
        doorCount: product.type === 'lift_upper' ? 1 : (product.doorCount || 2)
      }
    };
    setCart([...cart, newItem]);
    setView('cart');
  };

  const updateItemConfig = (id, field, value) => {
    setCart(cart.map(item => item.id === id ? { ...item, config: { ...item.config, [field]: value } } : item));
  };

  const applyBulkToAll = () => {
    if (cart.length === 0) return;
    setCart(cart.map(item => ({
      ...item,
      config: { ...item.config, bodyMaterial: bulkConfig.bodyMaterial, doorMaterial: bulkConfig.doorMaterial, hardwareBrand: bulkConfig.hardwareBrand }
    })));
  };

  const Sidebar = () => (
    <>
      <div className={`fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] transition-opacity duration-300 print:hidden ${isMenuOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={() => setIsMenuOpen(false)} />
      <aside className={`fixed top-0 left-0 h-full w-64 bg-white z-[70] shadow-xl transition-transform duration-300 ${isMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
        <div className="p-4 border-b flex justify-between items-center bg-slate-50/50 italic uppercase tracking-tighter leading-none"><span className="font-black text-lg">Kategoriler</span><button onClick={() => setIsMenuOpen(false)} className="p-2 hover:bg-white rounded-lg transition shadow-sm"><X size={20} /></button></div>
        <div className="p-4 space-y-2">
          <button onClick={() => { setActiveFilter({parent:null}); setView('home'); setIsMenuOpen(false); }} className={`w-full text-left font-black text-[10px] p-4 rounded-xl uppercase tracking-[0.2em] transition ${!activeFilter.parent ? 'bg-black text-white shadow-xl shadow-black/20' : 'text-slate-400 hover:bg-slate-50'}`}>Tüm Ürünler</button>
          {['Alt Dolaplar', 'Üst Dolaplar', 'Duvar Dolapları'].map(cat => (
            <button key={cat} onClick={() => { setActiveFilter({parent:cat}); setView('home'); setIsMenuOpen(false); }} className={`w-full text-left font-black text-[10px] p-4 rounded-xl uppercase tracking-[0.2em] transition ${activeFilter.parent === cat ? 'bg-black text-white shadow-xl shadow-black/20' : 'text-slate-400 hover:bg-slate-50'}`}>{cat}</button>
          ))}
        </div>
      </aside>
    </>
  );

  const TeklifModal = () => (
    <div className="fixed inset-0 z-[200] bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-4 overflow-y-auto print:hidden">
      <div className="bg-white w-full max-w-4xl rounded-[40px] shadow-2xl relative animate-in zoom-in duration-300 flex flex-col max-h-[95vh]">
        <div className="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-[40px] shrink-0 italic uppercase tracking-tighter">
          <div className="flex items-center gap-3"><ClipboardList className="text-amber-500" /><h3 className="font-black text-lg">Teklif Önizleme</h3></div>
          <div className="flex gap-2">
            <button onClick={() => setShowTeklifPreview(false)} className="px-6 py-2 rounded-xl font-bold text-xs bg-white border hover:bg-slate-50">Kapat</button>
            <button onClick={() => window.print()} className="px-6 py-2 rounded-xl font-black text-xs bg-black text-white flex items-center gap-2 shadow-lg italic tracking-tighter uppercase leading-none"><Printer size={16} /> Yazdır / PDF</button>
          </div>
        </div>
        <div className="flex-grow overflow-y-auto p-12 bg-white flex justify-center text-black">
            <div className="w-full max-w-[800px]">
                <div className="flex justify-between items-start border-b-4 border-black pb-8 mb-10 italic uppercase tracking-tighter leading-none">
                    <div><h1 className="text-4xl font-black mb-1">TEKLİF FORMU</h1><p className="text-xs font-bold text-slate-400 font-mono">#{Date.now().toString().slice(-6)} | {new Date().toLocaleDateString('tr-TR')}</p></div>
                    <div className="text-right"><h2 className="font-black text-2xl uppercase">DOLAP<span className="text-slate-300 italic">HUB</span></h2><p className="text-[10px] font-black text-slate-400 mt-1 uppercase tracking-widest italic tracking-tighter leading-none">Üretim ve Tasarım</p></div>
                </div>
                <div className="grid grid-cols-2 gap-12 mb-10 border-2 border-slate-50 p-8 rounded-3xl bg-slate-50/30 italic uppercase tracking-tighter">
                    <div><p className="text-[9px] font-black text-slate-300 uppercase mb-3 tracking-widest leading-none">Müşteri</p><h3 className="font-black text-2xl mb-1 uppercase italic">{customer.name || '---'}</h3><p className="text-sm font-bold text-slate-600 italic tracking-tighter leading-none">{customer.phone || '---'}</p><p className="text-xs text-slate-500 mt-2 italic leading-relaxed italic">{customer.address || '---'}</p></div>
                    <div className="text-right flex flex-col justify-end italic"><p className="text-[9px] font-black text-slate-300 uppercase mb-3 tracking-widest leading-none">Toplam Tutar</p><h2 className="text-5xl font-black tracking-tighter italic">{(cartTotal || 0).toLocaleString('tr-TR')} TL</h2></div>
                </div>
                <table className="w-full text-left border-collapse italic uppercase tracking-tighter">
                    <thead><tr className="border-b-2 border-black"><th className="py-4 text-[10px] font-black uppercase">Modül</th><th className="py-4 text-[10px] font-black uppercase text-center">Ölçüler</th><th className="py-4 text-[10px] font-black uppercase">Malzeme & Donanım</th><th className="py-4 text-[10px] font-black uppercase text-right">Tutar</th></tr></thead>
                    <tbody>
                        {cart.map(item => (
                            <tr key={item.id} className="border-b border-slate-100 italic tracking-tighter leading-none">
                                <td className="py-5 font-bold text-sm text-slate-800 uppercase italic">{item.product.name}</td>
                                <td className="py-5 text-xs font-bold text-slate-500 text-center uppercase italic">
                                    {['corner_base', 'corner_upper'].includes(item.product.type) ? `${item.config.width}+${item.config.width2}` : item.config.width}x{item.config.height}
                                </td>
                                <td className="py-5 text-[10px]">
                                    <span className="font-bold text-slate-400 text-[9px] italic">Gövde:</span> <span className="font-black text-slate-700 italic">{item.config.bodyMaterial}</span><br/>
                                    <span className="font-bold text-slate-400 text-[9px] italic">Kapak:</span> <span className="font-black text-slate-700 italic">{item.config.doorStyle === 'glass' ? 'CAMLI' : item.config.doorMaterial}</span><br/>
                                    <span className="text-amber-600 font-bold text-[9px] mt-1 block italic leading-none">
                                        {item.config.doorType === 'lift' ? `Piston Marka: ${item.config.hardwareBrand}` : 
                                         ['drawer', 'wall_cabinet'].includes(item.product.type) ? `${item.config.hardwareBrand} Donanım` : 'Menteşeli / Raf Sistemi'}
                                        {item.config.doorStyle === 'glass' && ` | Cam Kapak`}
                                    </span>
                                </td>
                                <td className="py-5 text-right font-black text-sm italic">{(calculateItemPrice(item, settings) || 0).toLocaleString('tr-TR')} TL</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#FAFAFA] text-slate-900 font-sans selection:bg-black selection:text-white">
      <header className="p-4 flex justify-between items-center bg-white border-b border-slate-50 sticky top-0 z-50 print:hidden shadow-sm italic uppercase tracking-tighter leading-none">
        <div className="flex items-center gap-3">
          <button onClick={() => setIsMenuOpen(true)} className="p-2.5 bg-slate-50 rounded-xl hover:bg-slate-100 transition border border-slate-100 shadow-sm"><Menu size={20} /></button>
          <div className="flex items-center gap-2 cursor-pointer" onClick={() => { setView('home'); setActiveFilter({parent:null}); }}>
            <div className="w-8 h-8 bg-black rounded-lg flex items-center justify-center text-white shadow-lg"><Package size={16} /></div>
            <span className="font-black text-lg">DOLAP<span className="text-slate-300 italic">HUB</span></span>
          </div>
        </div>
        <div className="flex gap-4 items-center">
          <button onClick={() => setView('admin')} className="text-slate-300 hover:text-black transition"><Settings size={18} /></button>
          <button onClick={() => setView('cart')} className="relative p-2.5 bg-black text-white rounded-xl shadow-lg transition active:scale-95">
            <ShoppingCart size={18} />
            {cart.length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-[9px] font-black w-4 h-4 rounded-full flex items-center justify-center border-2 border-white font-black">{cart.length}</span>}
          </button>
        </div>
      </header>

      <Sidebar />
      {showTeklifPreview && <TeklifModal />}

      <main className="py-6 px-4 print:hidden animate-in fade-in duration-500">
        {view === 'home' && (
          <div className="max-w-6xl mx-auto italic uppercase tracking-tighter leading-none">
            <h2 className="text-xl font-black mb-6 tracking-tight flex items-center gap-2 px-1 text-slate-900 leading-none"><LayoutGrid size={18} className="text-slate-300"/> {activeFilter.parent || 'Tüm Modüller'}</h2>
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 italic tracking-tighter leading-none">
              {PRODUCTS.filter(p => !activeFilter.parent || p.parentCat === activeFilter.parent).map(p => (
                <div key={p.id} className="bg-white p-2.5 rounded-2xl border border-slate-100 hover:border-black transition-all cursor-pointer group shadow-sm hover:shadow-xl" onClick={() => setSelectedProduct(p)}>
                  <div className="aspect-square rounded-xl overflow-hidden bg-slate-50 mb-3 shadow-inner"><img src={p.image} className="w-full h-full object-cover group-hover:scale-110 transition duration-500" /></div>
                  <h4 className="font-bold text-[11px] leading-tight mb-3 h-8 line-clamp-2 px-1 text-slate-800 uppercase italic leading-none">{p.name}</h4>
                  <button onClick={(e) => { e.stopPropagation(); addToCart(p); }} className="w-full py-2 bg-slate-50 text-black text-[9px] font-black rounded-xl hover:bg-black hover:text-white transition uppercase shadow-sm italic leading-none">HIZLI EKLE</button>
                </div>
              ))}
            </div>
            {selectedProduct && (
              <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm italic uppercase tracking-tighter leading-none">
                 <div className="bg-white w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl relative animate-in zoom-in">
                    <button onClick={() => setSelectedProduct(null)} className="absolute top-4 right-4 bg-white/80 p-1.5 rounded-full z-10 hover:bg-white"><X size={20}/></button>
                    <img src={selectedProduct.image} className="w-full aspect-video object-cover" />
                    <div className="p-8"><h3 className="text-2xl font-black mb-2 tracking-tighter italic uppercase">{selectedProduct.name}</h3><button onClick={() => { addToCart(selectedProduct); setSelectedProduct(null); }} className="w-full py-4 bg-black text-white font-black rounded-2xl text-[10px] uppercase tracking-widest shadow-xl hover:scale-[1.02] transition italic tracking-tighter leading-none">SEPETE EKLE & KONFİGÜRE ET</button></div>
                 </div>
              </div>
            )}
          </div>
        )}

        {view === 'cart' && (
          <div className="max-w-6xl mx-auto italic uppercase tracking-tighter leading-none">
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
              <div className="lg:col-span-8 space-y-4">
                <div className="flex justify-between items-center mb-2 px-1 italic uppercase tracking-tighter leading-none"><h2 className="text-2xl font-black tracking-tight text-slate-800 flex items-center gap-2">Teklif Sepeti <span className="text-slate-200 font-normal italic tracking-tighter leading-none">/ {cart.length}</span></h2><button onClick={() => setView('home')} className="text-[10px] font-black uppercase bg-white border border-slate-100 px-4 py-2 rounded-xl flex items-center gap-1 hover:bg-slate-50 transition shadow-sm font-bold tracking-widest leading-none"><Plus size={12}/> Modül Ekle</button></div>

                {cart.length > 0 ? (
                  <>
                    <div className="bg-white p-5 rounded-[28px] border border-slate-100 shadow-sm flex flex-col md:flex-row items-center gap-4 border-l-4 border-l-slate-900 relative overflow-hidden italic uppercase tracking-tighter leading-none">
                      <div className="flex items-center gap-2 px-3 border-r pr-5 hidden md:flex shrink-0"><Settings size={22} className="text-slate-300" /><span className="text-[10px] font-black text-slate-400 uppercase leading-none tracking-widest">Toplu<br/>Seçim</span></div>
                      <div className="grid grid-cols-2 gap-3 flex-grow w-full">
                        <div className="flex flex-col"><label className="text-[8px] font-black text-slate-400 uppercase mb-1 ml-1">Gövde Malzemesi</label><select value={bulkConfig.bodyMaterial} onChange={e => setBulkConfig({...bulkConfig, bodyMaterial: e.target.value})} className="bg-slate-50 border-none rounded-xl p-3 text-[10px] font-bold outline-none italic">{Object.keys(settings.materialPrices).map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                        <div className="flex flex-col"><label className="text-[8px] font-black text-slate-400 uppercase mb-1 ml-1">Kapak Malzemesi</label><select value={bulkConfig.doorMaterial} onChange={e => setBulkConfig({...bulkConfig, doorMaterial: e.target.value})} className="bg-slate-50 border-none rounded-xl p-3 text-[10px] font-bold outline-none italic">{Object.keys(settings.materialPrices).map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                      </div>
                      <button onClick={applyBulkToAll} className="bg-black text-white text-[10px] font-black px-6 py-5 rounded-xl hover:scale-105 transition italic tracking-tighter leading-none uppercase">TÜMÜNE UYGULA</button>
                    </div>

                    <div className="space-y-4">
                      {cart.map(item => (
                        <div key={item.id} className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex flex-col gap-6 border-l-4 border-l-slate-100 hover:border-l-black transition-all group">
                          <div className="flex items-center gap-5 border-b border-slate-50 pb-5 uppercase italic tracking-tighter leading-none">
                            <div className="w-16 h-16 rounded-2xl overflow-hidden shrink-0 shadow-sm border border-slate-100 italic uppercase"><img src={item.product.image} className="w-full h-full object-cover shadow-inner" /></div>
                            <div className="flex-grow"><h4 className="font-black text-base mb-2 italic uppercase">{item.product.name}</h4><div className="flex items-center gap-3 italic leading-none"><span className="text-[10px] font-black bg-slate-900 text-white px-3 py-1 rounded-lg italic leading-none">{(calculateItemPrice(item, settings) || 0).toLocaleString('tr-TR')} TL</span><span className="text-[9px] text-slate-300 font-bold uppercase tracking-widest italic leading-none">Gövde: {item.config.bodyMaterial} / Kapak: {item.config.doorMaterial}</span></div></div>
                            <button onClick={() => setCart(cart.filter(c => c.id !== item.id))} className="text-slate-200 hover:text-red-500 transition-colors p-2"><Trash2 size={20} /></button>
                          </div>
                          
                          <div className="grid grid-cols-2 md:grid-cols-6 lg:grid-cols-10 gap-3 italic tracking-widest uppercase leading-none">
                            <div><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none">En 1 (cm)</label><input type="number" value={item.config.width} onChange={e => updateItemConfig(item.id, 'width', e.target.value)} className="w-full bg-slate-50 p-3 rounded-xl text-[11px] font-black text-center border-none shadow-inner italic leading-none" /></div>
                            
                            {['corner_base', 'corner_upper', 'wall_cabinet'].includes(item.product.type) && item.config.cabinetShape !== 'Düz' && (
                                <div><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none">En 2 (cm)</label><input type="number" value={item.config.width2} onChange={e => updateItemConfig(item.id, 'width2', e.target.value)} className="w-full bg-slate-50 p-3 rounded-xl text-[11px] font-black text-center border-none shadow-inner italic leading-none" /></div>
                            )}
                            
                            <div><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none">Boy (cm)</label><input type="number" value={item.config.height} onChange={e => updateItemConfig(item.id, 'height', e.target.value)} className="w-full bg-slate-50 p-3 rounded-xl text-[11px] font-black text-center border-none shadow-inner italic leading-none" /></div>
                            <div><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none">Derin (cm)</label><input type="number" value={item.config.depth} onChange={e => updateItemConfig(item.id, 'depth', e.target.value)} className="w-full bg-slate-50 p-3 rounded-xl text-[11px] font-black text-center border-none shadow-inner italic leading-none" /></div>

                            {/* ÜST DOLAPLAR İÇİN KAPAK STİLİ (NORMAL / CAMLI) */}
                            {item.product.parentCat === 'Üst Dolaplar' && (
                                <div className="col-span-2 md:col-span-2"><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none italic tracking-widest">Kapak Stili</label><select value={item.config.doorStyle} onChange={e => updateItemConfig(item.id, 'doorStyle', e.target.value)} className="w-full bg-amber-50 text-[10px] p-3 rounded-xl border-none font-bold italic shadow-inner uppercase appearance-none"><option value="normal">Normal Kapak</option><option value="glass">Camlı Kapak</option></select></div>
                            )}

                            {/* ÖZEL SEÇENEKLER */}
                            {['hinged_base', 'corner_base', 'blind_corner_base', 'hinged_upper', 'blind_upper', 'corner_upper'].includes(item.product.type) ? (
                                <>
                                    {item.config.doorType !== 'lift' && (
                                        <div><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none">Kapak</label><input type="number" value={item.config.doorCount} onChange={e => updateItemConfig(item.id, 'doorCount', e.target.value)} className="w-full bg-slate-50 p-3 rounded-xl text-[11px] font-black text-center border-none shadow-inner italic leading-none" /></div>
                                    )}
                                    <div><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none">Raf</label><input type="number" value={item.config.shelfCount} onChange={e => updateItemConfig(item.id, 'shelfCount', e.target.value)} className="w-full bg-slate-50 p-3 rounded-xl text-[11px] font-black text-center border-none shadow-inner italic leading-none" /></div>
                                </>
                            ) : null}

                            {item.product.type === 'lift_upper' && (
                                <>
                                    <div className="col-span-2"><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase tracking-widest italic leading-none">Piston</label><select value={item.config.hardwareBrand} onChange={e => updateItemConfig(item.id, 'hardwareBrand', e.target.value)} className="w-full bg-slate-50 text-[10px] p-3 rounded-xl border-none font-bold uppercase italic shadow-inner">{Object.keys(settings.hardwarePrices.liftSystemBrands).map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                                    <div><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none">Raf</label><input type="number" value={item.config.shelfCount} onChange={e => updateItemConfig(item.id, 'shelfCount', e.target.value)} className="w-full bg-slate-50 p-3 rounded-xl text-[11px] font-black text-center border-none shadow-inner italic leading-none" /></div>
                                </>
                            )}
                            
                            {item.product.type === 'drawer' && (
                                <>
                                    <div><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none">Çekmece</label><input type="number" value={item.config.drawerCount} onChange={e => updateItemConfig(item.id, 'drawerCount', e.target.value)} className="w-full bg-slate-50 p-3 rounded-xl text-[11px] font-black text-center border-none shadow-inner italic leading-none" /></div>
                                    <div className="md:col-span-2 lg:col-span-1"><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase leading-none">Ray Marka</label><select value={item.config.hardwareBrand} onChange={e => updateItemConfig(item.id, 'hardwareBrand', e.target.value)} className="w-full bg-slate-50 text-[10px] p-3 rounded-xl border-none font-bold italic uppercase shadow-inner">{['Samet', 'Blum', 'Hettich'].map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                                </>
                            )}

                            <div className="col-span-2 md:col-span-2 lg:col-span-2"><label className="text-[9px] font-black text-slate-300 block mb-1.5 uppercase tracking-widest italic leading-none">Gövde / Kapak</label><div className="flex gap-1 italic"><select value={item.config.bodyMaterial} onChange={e => updateItemConfig(item.id, 'bodyMaterial', e.target.value)} className="flex-1 bg-slate-50 text-[9px] p-3 rounded-xl border-none font-bold uppercase italic shadow-inner appearance-none">{Object.keys(settings.materialPrices).map(m => <option key={m} value={m}>{m.slice(0,3)} (G)</option>)}</select><select value={item.config.doorMaterial} onChange={e => updateItemConfig(item.id, 'doorMaterial', e.target.value)} className="flex-1 bg-slate-50 text-[9px] p-3 rounded-xl border-none font-bold uppercase italic shadow-inner appearance-none">{Object.keys(settings.materialPrices).map(m => <option key={m} value={m}>{m.slice(0,3)} (K)</option>)}</select></div></div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </>
                ) : (
                  <div className="text-center py-32 bg-white rounded-[40px] border-2 border-dashed border-slate-100 flex flex-col items-center uppercase italic"><div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4"><ShoppingCart size={32} className="text-slate-200" /></div><p className="font-bold text-slate-400 text-sm tracking-widest leading-none">Sepetiniz Boş</p></div>
                )}
              </div>

              <div className="lg:col-span-4 space-y-6 italic tracking-tighter uppercase leading-none italic uppercase leading-none">
                <div className="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm relative overflow-hidden italic"><h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-300 mb-8 flex items-center gap-3"><User size={16}/> Müşteri Detay</h3><div className="space-y-4"><input type="text" placeholder="Ad Soyad" value={customer.name} onChange={e => setCustomer({...customer, name: e.target.value})} className="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none text-sm font-bold placeholder:text-slate-200 focus:ring-1 focus:ring-black italic uppercase" /><input type="tel" placeholder="Telefon" value={customer.phone} onChange={e => setCustomer({...customer, phone: e.target.value})} className="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none text-sm font-bold placeholder:text-slate-200 focus:ring-1 focus:ring-black italic uppercase" /><textarea placeholder="Teslimat Adresi" value={customer.address} onChange={e => setCustomer({...customer, address: e.target.value})} className="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none text-sm font-bold placeholder:text-slate-200 h-28 resize-none focus:ring-1 focus:ring-black italic uppercase leading-relaxed"></textarea></div></div>
                <div className="bg-white p-10 rounded-[48px] shadow-sm border border-slate-100 italic tracking-tighter leading-none"><p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em] mb-4 italic">Toplam Tutar</p><h3 className="text-6xl font-black mb-12 tracking-tighter text-slate-900 italic leading-none">{(cartTotal || 0).toLocaleString('tr-TR')} <span className="text-base text-slate-300 italic font-normal ml-1">TL</span></h3><button disabled={cart.length === 0} onClick={() => setShowTeklifPreview(true)} className="w-full py-5 bg-black text-white rounded-[24px] font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-3 hover:bg-slate-800 shadow-xl shadow-black/20 disabled:opacity-20 italic tracking-tighter leading-none">TEKLİF DOSYASI HAZIRLA</button></div>
              </div>
            </div>
          </div>
        )}

        {view === 'admin' && (
          <div className="max-w-2xl mx-auto space-y-8 py-4 italic uppercase tracking-tighter leading-none uppercase italic uppercase leading-none">
            <div className="flex items-center gap-4 mb-4"><button onClick={() => setView('home')} className="p-2 bg-white rounded-xl shadow-sm hover:bg-slate-50 transition"><ChevronLeft/></button><h2 className="text-3xl font-black tracking-tighter italic uppercase leading-none italic uppercase">Admin Paneli</h2></div>
            <div className="bg-white p-10 rounded-[48px] border border-slate-100 shadow-sm space-y-8 uppercase italic uppercase italic leading-none">
              <div><h3 className="text-[10px] font-black text-slate-300 uppercase mb-6 italic tracking-tighter leading-none italic uppercase">Malzeme m² Birim Fiyatlar</h3><div className="space-y-4 italic uppercase">
                {Object.keys(settings.materialPrices).map(m => (
                  <div key={m} className="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100 italic uppercase"><span className="text-sm font-black text-slate-600 italic uppercase tracking-tighter">{m}</span><div className="flex items-center gap-2"><input type="number" value={settings.materialPrices[m]} onChange={e => setSettings({...settings, materialPrices: {...settings.materialPrices, [m]: Number(e.target.value)}})} className="w-24 bg-white p-2.5 rounded-xl text-right font-black outline-none border-none text-sm shadow-sm italic focus:ring-1 focus:ring-black uppercase italic" /><span className="text-[10px] font-black text-slate-300 uppercase italic leading-none">TL</span></div></div>
                ))}
                <div className="flex justify-between items-center bg-amber-50 p-4 rounded-2xl border border-amber-100 italic uppercase shadow-sm"><span className="text-sm font-black text-amber-700 italic">Camlı Kapak (m²)</span><div className="flex items-center gap-2"><input type="number" value={settings.glassDoorPrice} onChange={e => setSettings({...settings, glassDoorPrice: Number(e.target.value)})} className="w-24 bg-white p-2.5 rounded-xl text-right font-black outline-none border-none text-sm shadow-sm italic focus:ring-1 focus:ring-amber-500 uppercase italic" /><span className="text-[10px] font-black text-amber-300 uppercase italic leading-none">TL</span></div></div>
              </div></div>
            </div>
          </div>
        )}
      </main>

      <style>{`
        @media print { body * { visibility: hidden; } .print\\:block, .print\\:block * { visibility: visible; } .print\\:block { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20mm; } .print\\:hidden { display: none !important; } }
        select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='C19 9l-7 7-7-7'/%3E%3C/svg%3E"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1em; padding-right: 2.5rem; }
      `}</style>
    </div>
  );
};

export default App;
