<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marangozhane Yönetim Paneli</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <div class="max-w-3xl mx-auto mt-10 bg-white rounded-2xl shadow p-6">
    <h1 class="text-3xl font-bold text-center text-blue-600 mb-4">
      Marangozhane Yönetim Paneli
    </h1>
    <p class="text-center text-gray-500 mb-6">Firebase ile gerçek zamanlı iş ve aşama takibi</p>

    <div class="text-center mb-6">
      <label class="mr-2 font-semibold">Simüle Edilen Kullanıcı:</label>
      <select id="ustaSelect" class="border rounded-lg px-3 py-2">
        <option value="Mehmet">Mehmet (Usta)</option>
        <option value="Ahmet">Ahmet (Usta)</option>
        <option value="Ayşe">Ayşe (Usta)</option>
      </select>
    </div>

    <div id="ustaPaneli" class="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
      <h2 id="ustaBaslik" class="text-lg font-semibold text-yellow-800 mb-2">
        Usta Paneli (Mehmet)
      </h2>
      <p class="text-sm text-yellow-700 mb-4">
        Sadece size atanan işlerin aşama yüzdelerini anlık olarak güncelleyebilirsiniz.
      </p>

      <!-- İş listesi -->
      <div id="isListesi" class="space-y-3"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
      authDomain: "kibrissiparissistemi.firebaseapp.com",
      databaseURL: "https://kibrissiparissistemi-default-rtdb.firebaseio.com",
      projectId: "kibrissiparissistemi",
      storageBucket: "kibrissiparissistemi.firebasestorage.app",
      messagingSenderId: "263531733235",
      appId: "1:263531733235:web:82efdf39ed758a22465786",
      measurementId: "G-JK5S6L90Q5"
    };

    // Firebase başlat
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const ustaSelect = document.getElementById("ustaSelect");
    const isListesi = document.getElementById("isListesi");
    const ustaBaslik = document.getElementById("ustaBaslik");

    // Usta seçimi değiştiğinde listeyi güncelle
    ustaSelect.addEventListener("change", () => {
      const ustaAdi = ustaSelect.value;
      ustaBaslik.textContent = `Usta Paneli (${ustaAdi})`;
      isListesi.innerHTML = "";
      loadJobs(ustaAdi);
    });

    // İşleri yükle
    function loadJobs(ustaAdi) {
      const jobsRef = ref(db, "jobs");
      onValue(jobsRef, (snapshot) => {
        isListesi.innerHTML = "";

        if (!snapshot.exists()) {
          isListesi.innerHTML = `<p class="text-gray-500 text-sm">Henüz kayıtlı iş bulunmuyor.</p>`;
          return;
        }

        snapshot.forEach((child) => {
          const job = child.val();
          const jobId = child.key;

          if (job.usta === ustaAdi) {
            const jobEl = document.createElement("div");
            jobEl.className = "border border-gray-200 bg-white rounded-lg p-3 shadow-sm";

            jobEl.innerHTML = `
              <div class="flex justify-between items-center">
                <div>
                  <p class="font-semibold text-gray-800">${job.isAdi}</p>
                  <p class="text-sm text-gray-500">Durum: ${job.durum || "Beklemede"}</p>
                </div>
                <div>
                  <input type="number" id="progress-${jobId}" value="${job.yuzde || 0}" min="0" max="100"
                    class="border border-gray-300 rounded-md px-2 py-1 w-16 text-center">
                  <button class="ml-2 bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600"
                    onclick="guncelleYuzde('${jobId}')">Kaydet</button>
                </div>
              </div>
            `;
            isListesi.appendChild(jobEl);
          }
        });
      });
    }

    // Yüzde güncelle
    window.guncelleYuzde = async (jobId) => {
      const yuzdeInput = document.getElementById(`progress-${jobId}`);
      const yeniYuzde = parseInt(yuzdeInput.value);
      const jobRef = ref(db, `jobs/${jobId}`);
      await update(jobRef, { yuzde: yeniYuzde });
      alert("Aşama yüzdesi güncellendi ✅");
    };

    // Başlangıçta Mehmet için yükle
    loadJobs("Mehmet");
  </script>
</body>
</html>
