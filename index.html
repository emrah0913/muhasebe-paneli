<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marangozhane İş Takip Sistemi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter font for modern look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Custom scrollbar for note sections */
        .max-h-40::-webkit-scrollbar {
            width: 4px;
        }
        .max-h-40::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="app" class="w-full">
        <!-- Uygulama burada JavaScript tarafından yüklenecektir -->
    </div>

    <!-- Firebase ve Uygulama Mantığı -->
    <script type="module">
        // SİZİN EKLEDİĞİNİZ KIBRIS SİPARİŞ SİSTEMİ YAPILANDIRMASI
        const FIXED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
            authDomain: "kibrissiparissistemi.firebaseapp.com",
            databaseURL: "https://kibrissiparissistemi-default-rtdb.firebaseio.com",
            projectId: "kibrissiparissistemi",
            storageBucket: "kibrissiparissistemi.firebasestorage.app",
            messagingSenderId: "263531733235",
            appId: "1:263531733235:web:82efdf39ed758a22465786",
            measurementId: "G-JK5S6L90Q5"
        };
        // ----------------------------------------------------------------

        // --- Firebase Modül İçe Aktarımları ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, Timestamp, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let db = null; // Firestore referansı
        let auth = null; // Auth referansı
        let user = null; // Kimliği doğrulanmış kullanıcı
        let jobs = [];
        let notes = {};
        let roles = ['Patron', 'Usta 1', 'Usta 2']; // Başlangıç rolleri
        let currentRole = "Patron";
        let loading = true;
        let showModal = false;
        let modalMessage = "";
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let isFirebaseInitialized = false; 

        // --- UTILITY FUNCTIONS ---

        const calculateWeightedProgress = (stages) => {
            let weightedSum = 0;
            let totalWeight = 0;
            stages.forEach(stage => {
                const progress = stage.progress || 0;
                const weight = stage.weight || 1;
                weightedSum += progress * weight;
                totalWeight += weight;
            });
            return totalWeight === 0 ? 0 : Math.round(weightedSum / totalWeight);
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            const time = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            const d = date.toLocaleDateString('tr-TR');
            return `${time} ${d}`;
        };

        const showNotification = (message) => {
            modalMessage = message;
            showModal = true;
            renderNotificationModal();
            setTimeout(() => {
                showModal = false;
                renderNotificationModal();
            }, 3000);
        };

        // --- FIREBASE INITIALIZATION & AUTH ---
        const initializeFirebase = () => {
            try {
                let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Eğer ortamdan geçerli config gelmezse, sabit config'i kullanıyoruz.
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    firebaseConfig = FIXED_FIREBASE_CONFIG;
                    console.warn("Ortam config'i yerine sabit (FIXED_FIREBASE_CONFIG) kullanılıyor.");
                }
                
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    console.error("Firebase config bulunamadı. Uygulama sadece statik olarak yüklenecek.");
                    loading = false;
                    isFirebaseInitialized = false;
                    user = { uid: 'NO_FIREBASE', displayName: 'Misafir' }; 
                    renderApp(); 
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                // setLogLevel('error'); 
                isFirebaseInitialized = true;

                const authenticateUser = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Canvas token ile oturum açıldı.");
                        } else {
                            // Anonim oturum açmayı deniyoruz. Reddedilirse bile uygulama çalışmaya devam edecek.
                            await signInAnonymously(auth);
                            console.log("Anonim olarak oturum açıldı.");
                        }
                    } catch (error) {
                        // Kimlik doğrulama hatası (Anonim giriş reddedilmesi gibi)
                        console.error("Firebase Kimlik Doğrulama Hatası:", error.code, error.message);
                        
                        // Hata durumunda bile, eğer kurallarımız herkese açık (if true) ise 
                        // Firestore işlemlerini yapmak için bir Misafir kullanıcı modeli oluşturuyoruz.
                        if (!user) { // Eğer oturum açma hiç gerçekleşmediyse
                            user = { uid: 'GUEST_USER', displayName: 'Anonim Kullanıcı' }; 
                        }
                        loading = false;
                        renderApp();
                    }
                };

                onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        user = currentUser;
                    } else if (!user || user.uid === 'GUEST_USER') {
                        // Logout veya başarısız Auth durumunda Misafir kullanıcıya geçiş
                        user = { uid: 'GUEST_USER', displayName: 'Anonim Kullanıcı' }; 
                    }
                    
                    loading = false;
                    if (isFirebaseInitialized) {
                        setupFirestoreListeners();
                    }
                    renderApp();
                });

                authenticateUser();
                
            } catch (error) {
                console.error("Firebase Başlatma hatası:", error);
                loading = false;
                isFirebaseInitialized = false;
                user = { uid: 'INIT_ERROR', displayName: 'Hata' };
                renderApp();
            }
        };

        // --- FIREBASE LISTENERS (Real-Time Data Fetching) ---
        const setupFirestoreListeners = () => {
            if (!db || !user || !isFirebaseInitialized) return;

            const jobsColRef = collection(db, `artifacts/${APP_ID}/public/data/jobs`);
            const notesColRef = collection(db, `artifacts/${APP_ID}/public/data/notes`);
            // YENİ KOLEKSİYON: Roller
            const rolesColRef = collection(db, `artifacts/${APP_ID}/public/data/roles`);

            // 1. İşleri Dinle (Jobs)
            onSnapshot(query(jobsColRef), (snapshot) => {
                jobs = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        id: doc.id,
                        totalProgress: calculateWeightedProgress(data.stages || []),
                    };
                }).sort((a, b) => {
                    if (a.totalProgress === 100 && b.totalProgress !== 100) return 1;
                    if (a.totalProgress !== 100 && b.totalProgress === 100) return -1;
                    return a.name.localeCompare(b.name);
                });
                renderApp();
            }, (error) => console.error("Jobs listener error:", error));

            // 2. Notları Dinle (Notes)
            onSnapshot(query(notesColRef), (snapshot) => {
                const allNotes = {};
                snapshot.docs.forEach(doc => {
                    const note = doc.data();
                    if (!allNotes[note.jobKey]) {
                        allNotes[note.jobKey] = [];
                    }
                    allNotes[note.jobKey].push(note);
                });

                for (const jobKey in allNotes) {
                    allNotes[jobKey].sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                }
                notes = allNotes;
                renderApp();
            }, (error) => console.error("Notes listener error:", error));

            // 3. Rolleri Dinle (Roles) - YENİ
            onSnapshot(query(rolesColRef), (snapshot) => {
                const masterRoles = ['Patron']; // Patron her zaman listede olmalı
                snapshot.docs.forEach(doc => {
                    const roleData = doc.data();
                    if (roleData.name && roleData.type === 'master' && !masterRoles.includes(roleData.name)) {
                        masterRoles.push(roleData.name);
                    }
                });
                roles = masterRoles;
                renderApp();
            }, (error) => console.error("Roles listener error:", error));
        };

        // --- JOB/NOTE/ROLE MANIPULATION METHODS ---

        const handleLogout = async () => {
            if (auth) {
                try {
                    await signOut(auth);
                    // onAuthStateChanged tetiklenecek ve GUEST_USER'a düşecek.
                } catch (error) {
                    console.error("Çıkış yapılırken hata:", error);
                }
            }
        };
        
        const handleRoleChange = (event) => {
            currentRole = event.target.value;
            renderApp();
        };

        // YENİ: Usta/Rol Ekleme Fonksiyonu
        const handleAddRole = async (e) => {
            e.preventDefault();
            if (!db || !isFirebaseInitialized) {
                showNotification("HATA: Rol eklemek için Firebase bağlantısı gerekli.");
                return;
            }

            const form = e.target;
            const roleName = form.roleName.value.trim();
            
            if (roles.includes(roleName)) {
                showNotification(`HATA: ${roleName} zaten mevcut!`);
                return;
            }

            const newRoleDoc = {
                name: roleName,
                type: 'master', // Şu an sadece usta rollerini ekliyoruz
                createdBy: user.uid,
                createdAt: Timestamp.fromDate(new Date())
            };

            try {
                const rolesColRef = collection(db, `artifacts/${APP_ID}/public/data/roles`);
                await addDoc(rolesColRef, newRoleDoc);
                showNotification(`${roleName} ustası başarıyla eklendi!`);
                form.reset();
            } catch (error) {
                console.error("Firestore'a rol eklerken hata:", error);
                showNotification(`Hata: Rol eklenemedi. İzinleri kontrol edin. (Console'da detay)`);
            }
        };


        const handleAddJob = async (e) => {
            e.preventDefault();
            if (!db || !isFirebaseInitialized) {
                showNotification("HATA: İş eklemek için Firebase bağlantısı gerekli.");
                return;
            }

            const form = e.target;
            const name = form.jobName.value;
            const stagesInput = form.jobStages.value.split(',').map(s => s.trim()).filter(s => s);
            // Ustaları seçilen listeden alıyoruz.
            const selectedMasters = Array.from(form.assignedMasters.options)
                                    .filter(option => option.selected)
                                    .map(option => option.value);

            if (selectedMasters.length === 0) {
                showNotification("HATA: Lütfen en az bir usta atayın.");
                return;
            }

            const stages = stagesInput.map(item => {
                const parts = item.split(':');
                const stageName = parts[0];
                const weight = parseInt(parts[1]) || 1;
                return { name: stageName, progress: 0, weight: weight };
            });

            const newJob = {
                name: name,
                stages: stages,
                masters: selectedMasters, // Güncellenen usta listesi
                createdBy: user.uid,
                createdByName: user.displayName || "Bilinmiyor",
                createdAt: Timestamp.fromDate(new Date())
            };

            try {
                const jobsColRef = collection(db, `artifacts/${APP_ID}/public/data/jobs`);
                await addDoc(jobsColRef, newJob);
                showNotification("Yeni İş Başarıyla Eklendi!");
                form.reset();
                form.jobStages.value = "Kesim:2,Bantlama:1,Montaj:5,Cila:2";
            } catch (error) {
                console.error("Firestore'a iş eklerken hata:", error);
                showNotification(`Hata: İş eklenemedi. İzinleri kontrol edin. (Console'da detay)`);
            }
        };

        const handleUpdateStageProgress = async (jobId, stageIndex, newProgress) => {
            if (!db || !isFirebaseInitialized) {
                showNotification("HATA: İlerleme güncellemek için Firebase bağlantısı gerekli.");
                return;
            }

            const jobToUpdate = jobs.find(j => j.id === jobId);
            if (!jobToUpdate) return;

            const progressValue = Math.max(0, Math.min(100, parseInt(newProgress) || 0));

            const newStages = [...jobToUpdate.stages];
            newStages[stageIndex].progress = progressValue;

            try {
                const jobDocRef = doc(db, `artifacts/${APP_ID}/public/data/jobs`, jobId);
                await updateDoc(jobDocRef, {
                    stages: newStages,
                    totalProgress: calculateWeightedProgress(newStages),
                    lastUpdatedBy: user.uid,
                    lastUpdatedAt: Timestamp.fromDate(new Date())
                });
            } catch (error) {
                console.error("İlerleme güncellenirken hata:", error);
                showNotification(`Hata: İlerleme güncellenemedi. İzinleri kontrol edin.`);
            }
        };

        const handleAddNote = async (jobId, noteContent) => {
            if (!noteContent.trim() || !db || !isFirebaseInitialized) {
                showNotification("HATA: Not eklemek için Firebase bağlantısı gerekli.");
                return;
            }

            const newNote = {
                jobKey: jobId,
                content: noteContent,
                master: currentRole,
                masterUID: user.uid,
                timestamp: Timestamp.fromDate(new Date())
            };

            try {
                const notesColRef = collection(db, `artifacts/${APP_ID}/public/data/notes`);
                await addDoc(notesColRef, newNote);
                showNotification(`İş ${jobId.substring(0, 5)} için yeni not eklendi.`);
            } catch (error) {
                console.error("Not eklenirken hata:", error);
                showNotification(`Hata: Not eklenemedi. İzinleri kontrol edin. (Console'da detay)`);
            }
        };


        // --- RENDERING FUNCTIONS (Vanilla JS) ---

        const renderNotificationModal = () => {
            let modalElement = document.getElementById('notification-modal');
            if (!modalElement) {
                modalElement = document.createElement('div');
                modalElement.id = 'notification-modal';
                document.body.appendChild(modalElement);
            }

            modalElement.className = `fixed inset-0 z-50 flex items-start justify-center p-6 transition-opacity duration-300 ${showModal ? 'opacity-100' : 'opacity-0 pointer-events-none'}`;
            modalElement.innerHTML = `
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-xl font-semibold text-center pointer-events-auto">
                    <span>${modalMessage}</span>
                </div>
            `;
        };

        const createPatronJobCard = (job) => {
            const jobNotes = notes[job.id] || [];
            const isComplete = job.totalProgress === 100;

            const stagesHtml = job.stages.map((stage, index) => `
                <li class="${stage.progress === 100 ? 'text-green-600' : 'text-gray-600'}">
                    ${stage.name} (Ağırlık: ${stage.weight || 1}): <strong>${stage.progress || 0}%</strong>
                </li>
            `).join('');

            const notesHtml = jobNotes.length > 0 ? jobNotes.map((note, index) => `
                <div class="p-2 text-xs rounded bg-gray-100 mt-1 border border-gray-200">
                    <span class="font-bold text-indigo-500">${note.master}</span>: <span>${note.content}</span>
                    <span class="text-gray-400 ml-2 float-right">${formatTimestamp(note.timestamp)}</span>
                </div>
            `).join('') : '<p class="text-gray-500 italic text-xs">Bu işe ait henüz bir not yok.</p>';

            return `
                <div class="job-card p-4 border-l-4 rounded-lg shadow-md ${isComplete ? 'border-green-400 bg-green-50' : 'border-gray-300 bg-white'}" id="patron-card-${job.id}">
                    <h3 class="text-xl font-bold text-indigo-600">${job.name}</h3>
                    <p class="text-sm text-gray-500 mb-2">Atanan Ustalar: <strong class="font-medium">${job.masters.join(', ')}</strong></p>
                    
                    <!-- İlerleme Çubuğu -->
                    <div class="mt-3">
                        <p class="text-sm font-semibold">Genel İlerleme (Ağırlıklı): <span class="${isComplete ? 'text-green-700' : 'text-gray-700'}">${job.totalProgress}%</span></p>
                        <div class="progress-bar-container w-full h-3 bg-gray-200 rounded-full overflow-hidden mt-1">
                            <div class="progress-bar h-full text-xs text-white flex items-center justify-center transition-all duration-500 ${isComplete ? 'bg-green-500' : (job.totalProgress > 50 ? 'bg-yellow-500' : 'bg-red-500')}" 
                                style="width: ${job.totalProgress}%">
                                ${job.totalProgress > 10 ? `${job.totalProgress}%` : ''}
                            </div>
                        </div>
                    </div>

                    <details class="mt-4 text-sm text-gray-600">
                        <summary class="cursor-pointer font-medium hover:text-indigo-500">
                            Aşama Detayları ve Notlar (${jobNotes.length} Not)
                        </summary>
                        <ul class="list-disc list-inside ml-2 mt-2 space-y-1">
                            ${stagesHtml}
                        </ul>
                        <h4 class="font-semibold text-sm mt-3 border-t pt-2">İş Notları:</h4>
                        <div class="space-y-1 max-h-40 overflow-y-auto pr-2">
                            ${notesHtml}
                        </div>
                    </details>
                </div>
            `;
        };
        
        const createMasterJobCard = (job) => {
            const jobNotes = notes[job.id] || [];
            
            const stagesHtml = job.stages.map((stage, index) => `
                <div class="flex items-center space-x-3">
                    <label class="flex-grow text-sm">
                        <span>${stage.name}</span> (Ağırlık: ${stage.weight || 1}):
                    </label>
                    <input type="number" 
                        data-job-id="${job.id}"
                        data-stage-index="${index}"
                        value="${stage.progress || 0}"
                        min="0" max="100" 
                        class="progress-input w-20 p-2 border border-gray-300 rounded-md text-right focus:ring-yellow-500 focus:border-yellow-500 text-sm"
                        ${!isFirebaseInitialized ? 'disabled' : ''}
                    />
                    <span class="font-semibold text-gray-600">%</span>
                </div>
            `).join('');

            const notesHtml = jobNotes.length > 0 ? jobNotes.map((note, index) => `
                <div class="p-2 text-xs rounded bg-gray-100 mt-1 border border-gray-200">
                    <span class="font-bold text-indigo-500">${note.master}</span>: <span>${note.content}</span>
                    <span class="text-gray-400 ml-2 float-right">${formatTimestamp(note.timestamp)}</span>
                </div>
            `).join('') : '<p class="text-gray-500 italic text-xs">Bu işe ait henüz bir not yok.</p>';

            return `
                <div class="job-card p-4 border-l-4 border-yellow-400 bg-white rounded-lg shadow-md" id="master-card-${job.id}">
                    <h3 class="text-xl font-bold text-yellow-700">${job.name}</h3>
                    <p class="text-sm text-gray-500 mb-4">Genel İlerleme (Ağırlıklı): <strong>${job.totalProgress}%</strong></p>
                    
                    <!-- İlerleme Güncelleme Formu -->
                    <div class="space-y-3 mb-6 border-b pb-4">
                        <h4 class="font-semibold text-gray-700 border-b pb-1">Aşama İlerlemeni Gir:</h4>
                        ${stagesHtml}
                        ${!isFirebaseInitialized ? '<p class="text-red-500 text-xs pt-2">Firebase BAĞLI DEĞİL. İlerleme güncellenemez.</p>' : '<p class="text-xs text-red-500 pt-2">Not: Yüzdeyi değiştirdiğiniz an otomatik olarak Firebase\'e kaydedilir (input\'tan çıktığınızda).</p>'}
                    </div>
                    
                    <!-- Not Ekleme Formu -->
                    <form class="note-form" data-job-id="${job.id}">
                        <h4 class="font-semibold text-gray-700 mb-2">Ustalar Arası Not Bırak:</h4>
                        <textarea 
                            name="noteContent"
                            placeholder="Malzeme siparişi verildi, kesim bitti vb." required 
                            class="w-full p-2 border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-sm note-textarea"
                            ${!isFirebaseInitialized ? 'disabled' : ''}
                        ></textarea>
                        <button type="submit" class="w-full mt-2 font-bold py-2 rounded-lg transition duration-200 shadow-md 
                            ${isFirebaseInitialized ? 'bg-yellow-600 hover:bg-yellow-700 text-white' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}"
                            ${!isFirebaseInitialized ? 'disabled' : ''}>
                            Notu Gönder (${currentRole})
                        </button>
                        <div class="mt-4 border-t pt-3">
                            <h5 class="font-semibold text-gray-600 text-sm mb-1">Geçmiş Notlar:</h5>
                            <div class="space-y-1 max-h-40 overflow-y-auto pr-2">
                                ${notesHtml}
                            </div>
                        </div>
                    </form>
                </div>
            `;
        };

        const renderApp = () => {
            const app = document.getElementById('app');
            renderNotificationModal();
            
            if (loading) {
                app.innerHTML = `
                    <div class="fixed inset-0 flex items-center justify-center bg-gray-100">
                        <div class="text-center text-gray-500">Yükleniyor...</div>
                    </div>
                `;
                return;
            }

            // Güvenli kullanıcı adı gösterimi
            const userName = user?.displayName || (user?.uid === 'GUEST_USER' ? 'Anonim Kullanıcı' : 'N/A');
            const userIdDisplay = user?.uid || 'N/A';
            const firebaseStatus = isFirebaseInitialized ? 'Firebase Bağlı' : '❗ Firebase Bağlantı Hatası!';

            // Rol Seçeneklerini Dinamik Olarak Oluştur
            const roleOptionsHTML = roles.map(role => `
                <option value="${role}" ${currentRole === role ? 'selected' : ''}>${role}${role !== 'Patron' ? ' (Usta)' : ''}</option>
            `).join('');

            // --- HEADER OLUŞTURMA ---
            const headerHTML = `
                <header class="text-center py-6 bg-white shadow-lg rounded-xl">
                    <div class="flex justify-between items-center px-6">
                        <div class="text-left">
                            <h1 class="text-3xl font-extrabold text-indigo-700">Marangozhane Yönetimi</h1>
                            <p class="text-sm text-gray-500 mt-1">Hoş geldin, <span class="font-semibold text-gray-700">${userName}</span></p>
                            <p class="text-xs ${isFirebaseInitialized ? 'text-green-500' : 'text-red-500'} font-medium mt-1">${firebaseStatus}</p>
                            <p class="text-xs text-gray-400">UID: <span>${userIdDisplay}</span></p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="p-2 bg-gray-100 rounded-lg shadow-inner">
                                <label for="userSelect" class="font-semibold text-gray-600 text-sm">Rol:</label>
                                <select id="userSelect" class="p-1 border border-gray-300 rounded-md bg-white shadow-sm text-sm">
                                    ${roleOptionsHTML}
                                </select>
                            </div>
                            <!-- Çıkış yap butonu sadece Firebase bağlıysa gösterilir. -->
                            ${isFirebaseInitialized ? `
                                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
                                    Çıkış Yap
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </header>
            `;
            
            // --- PATRON PANELİ OLUŞTURMA ---
            let mainContentHTML = '';
            if (currentRole === 'Patron') {
                
                // Ustalar listesini çoklu seçim için oluştur
                const masterOptionsForJob = roles
                    .filter(role => role !== 'Patron')
                    .map(role => `<option value="${role}" selected>${role}</option>`)
                    .join('');

                const jobAddFormHTML = `
                    <form id="jobAddForm" class="bg-white p-4 rounded-lg shadow-inner mb-6 border-b pb-4">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">Yeni İş Ekle</h3>
                        ${!isFirebaseInitialized ? '<p class="text-red-500 font-semibold mb-3">Firebase BAĞLI DEĞİL. İşlem yapamazsınız.</p>' : ''}
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" name="jobName" placeholder="Proje Adı (Örn: Mutfak Dolabı-A1)" required 
                                class="md:col-span-4 p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" ${!isFirebaseInitialized ? 'disabled' : ''} />
                            
                            <input type="text" name="jobStages" value="Kesim:2,Bantlama:1,Montaj:5,Cila:2" 
                                placeholder="Aşama:Ağırlık (Virgülle Ayırın)" required 
                                class="md:col-span-2 p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" ${!isFirebaseInitialized ? 'disabled' : ''} />
                            
                            <!-- Usta Seçimi için Select Box -->
                            <select name="assignedMasters" multiple size="3" required 
                                class="md:col-span-2 p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-24" ${!isFirebaseInitialized ? 'disabled' : ''}>
                                ${masterOptionsForJob}
                            </select>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Aşama ağırlıkları 1 ile 10 arasında olmalıdır. Birden fazla usta atamak için CTRL/CMD tuşuna basılı tutun.</p>
                        <button type="submit" class="w-full mt-4 font-bold py-3 rounded-lg transition duration-200 shadow-md 
                            ${isFirebaseInitialized ? 'bg-indigo-600 hover:bg-indigo-700 text-white' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}" 
                            ${!isFirebaseInitialized ? 'disabled' : ''}>
                            İşi Ekle
                        </button>
                    </form>
                `;
                
                // YENİ ROL EKLEME FORMU
                const roleAddFormHTML = `
                    <form id="roleAddForm" class="bg-white p-4 rounded-lg shadow-inner mb-6 border-t pt-4">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">Yeni Usta/Rol Ekle</h3>
                        <div class="flex space-x-3">
                            <input type="text" name="roleName" placeholder="Yeni Usta Adı (Örn: Hasan)" required 
                                class="flex-grow p-3 border rounded-lg focus:ring-green-500 focus:border-green-500" ${!isFirebaseInitialized ? 'disabled' : ''} />
                            
                            <button type="submit" class="px-6 font-bold py-3 rounded-lg transition duration-200 shadow-md whitespace-nowrap 
                                ${isFirebaseInitialized ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}" 
                                ${!isFirebaseInitialized ? 'disabled' : ''}>
                                Ustayı Ekle
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Mevcut Ustalar: ${roles.filter(r => r !== 'Patron').join(', ')}</p>
                    </form>
                `;


                const jobListHTML = jobs.length === 0 ? 
                    `<div class="text-gray-500 p-4 border border-dashed rounded-lg">Henüz hiç iş eklenmemiş.</div>` : 
                    `<div id="patronJobList" class="space-y-4">
                        ${jobs.map(createPatronJobCard).join('')}
                    </div>`;

                mainContentHTML = `
                    <div id="patronPanel" class="p-6 bg-blue-50 border-t-4 border-blue-500 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-700 mb-4 border-b pb-2">Patron Paneli</h2>
                        ${roleAddFormHTML}
                        ${jobAddFormHTML}
                        <h3 class="text-xl font-semibold text-blue-700 mt-6 mb-3">Tüm Projeler ve Genel İlerleme</h3>
                        ${isFirebaseInitialized ? jobListHTML : '<p class="text-red-500 p-4 border border-dashed rounded-lg">İşler Firebase bağlantısı olmadan yüklenemiyor. Lütfen sorunu giderin.</p>'}
                    </div>
                `;
            } 
            // --- USTA PANELİ OLUŞTURMA ---
            else {
                // Patron olmayan rollere atanmış işleri filtrele
                const filteredMasterJobs = jobs.filter(job => job.masters.includes(currentRole));
                
                let jobListHTML;
                if (!isFirebaseInitialized) {
                    jobListHTML = '<p class="text-red-500 p-4 border border-dashed rounded-lg">İşler Firebase bağlantısı olmadan yüklenemiyor. Lütfen sorunu giderin.</p>';
                } else if (filteredMasterJobs.length === 0) {
                    jobListHTML = '<div class="text-gray-500 p-4 border border-dashed rounded-lg">Şu anda size atanmış aktif bir iş bulunmamaktadır.</div>';
                } else {
                    jobListHTML = `<div id="masterJobList" class="space-y-4">
                        ${filteredMasterJobs.map(createMasterJobCard).join('')}
                    </div>`;
                }
                
                mainContentHTML = `
                    <div id="ustaPanel" class="p-6 bg-yellow-50 border-t-4 border-yellow-500 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-yellow-700 mb-4 border-b pb-2">Usta Paneli (${currentRole})</h2>
                        <p class="text-gray-600 mb-4">Sadece size atanan işlerin aşama yüzdelerini ve notlarını güncelleyebilirsiniz.</p>
                        <div class="space-y-4">
                            ${jobListHTML}
                        </div>
                    </div>
                `;
            }

            // Ana konteyneri güncelle
            app.innerHTML = `
                <div class="container max-w-5xl mx-auto p-4 md:py-8 space-y-8">
                    ${headerHTML}
                    ${mainContentHTML}
                </div>
            `;
            
            // --- EVENT LISTENERS BAĞLAMA ---
            
            // 1. Rol Değiştirme ve Çıkış
            document.getElementById('userSelect')?.addEventListener('change', handleRoleChange);
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);

            // 2. Patron Formları (Firebase bağlıysa)
            if (isFirebaseInitialized) {
                document.getElementById('jobAddForm')?.addEventListener('submit', handleAddJob);
                // YENİ: Rol Ekleme Formu
                document.getElementById('roleAddForm')?.addEventListener('submit', handleAddRole);
            }


            // 3. Usta Kartı Event Delegation (İlerleme ve Not)
            const ustaPanel = document.getElementById('ustaPanel');
            if (ustaPanel && isFirebaseInitialized) {
                // İlerleme Güncelleme (Input Blur)
                ustaPanel.querySelectorAll('.progress-input').forEach(input => {
                    input.addEventListener('blur', (e) => {
                        const jobId = e.target.dataset.jobId;
                        const stageIndex = parseInt(e.target.dataset.stageIndex);
                        const newProgress = e.target.value;
                        handleUpdateStageProgress(jobId, stageIndex, newProgress);
                    });
                });

                // Not Gönderimi (Form Submit)
                ustaPanel.querySelectorAll('.note-form').forEach(form => {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const jobId = e.target.dataset.jobId;
                        const noteContent = e.target.querySelector('.note-textarea').value;
                        handleAddNote(jobId, noteContent).then(() => {
                            e.target.querySelector('.note-textarea').value = ''; // Başarılıysa temizle
                        });
                    });
                });
            }
        };

        // DOM yüklendiğinde Firebase'i başlat
        window.onload = initializeFirebase;
    </script>
</body>
</html>
