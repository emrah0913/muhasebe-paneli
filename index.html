<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marangozhane İş Takip Sistemi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter font for modern look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Custom scrollbar for note sections */
        .max-h-40::-webkit-scrollbar {
            width: 4px;
        }
        .max-h-40::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="app" class="w-full">
        <!-- Uygulama burada JavaScript tarafından yüklenecektir -->
    </div>

    <!-- Firebase ve Uygulama Mantığı -->
    <script type="module">
        // --- Firebase Modül İçe Aktarımları ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, Timestamp, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let db;
        let auth;
        let user = null;
        let jobs = [];
        let notes = {};
        let currentRole = "Patron";
        let loading = true;
        let showModal = false;
        let modalMessage = "";
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- UTILITY FUNCTIONS ---

        // Firestore'daki aşamaların ağırlıklarına göre genel ilerlemeyi hesaplar.
        const calculateWeightedProgress = (stages) => {
            let weightedSum = 0;
            let totalWeight = 0;
            stages.forEach(stage => {
                const progress = stage.progress || 0;
                const weight = stage.weight || 1;
                weightedSum += progress * weight;
                totalWeight += weight;
            });
            return totalWeight === 0 ? 0 : Math.round(weightedSum / totalWeight);
        };

        // Zaman damgasını (Timestamp) okunabilir bir formata dönüştürür
        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            const time = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            const d = date.toLocaleDateString('tr-TR');
            return `${time} ${d}`;
        };

        const showNotification = (message) => {
            modalMessage = message;
            showModal = true;
            renderNotificationModal();
            setTimeout(() => {
                showModal = false;
                renderNotificationModal();
            }, 3000);
        };

        // --- FIREBASE INITIALIZATION & AUTH ---
        const initializeFirebase = () => {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config bulunamadı.");
                loading = false;
                renderApp();
                return;
            }

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('error');

            const authenticateUser = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Canvas token ile oturum açıldı.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Anonim olarak oturum açıldı.");
                    }
                } catch (error) {
                    console.error("Firebase Kimlik Doğrulama Hatası:", error);
                }
            };

            onAuthStateChanged(auth, (currentUser) => {
                user = currentUser;
                loading = false;
                if (user) {
                    setupFirestoreListeners();
                }
                renderApp();
            });

            authenticateUser();
        };

        // --- FIREBASE LISTENERS (Real-Time Data Fetching) ---
        const setupFirestoreListeners = () => {
            if (!db || !user) return;

            const jobsColRef = collection(db, `artifacts/${APP_ID}/public/data/jobs`);
            const notesColRef = collection(db, `artifacts/${APP_ID}/public/data/notes`);

            // 1. İşleri Dinle (Jobs)
            onSnapshot(query(jobsColRef), (snapshot) => {
                jobs = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        id: doc.id,
                        totalProgress: calculateWeightedProgress(data.stages || []),
                    };
                }).sort((a, b) => {
                    // Tamamlanmış işler en alta
                    if (a.totalProgress === 100 && b.totalProgress !== 100) return 1;
                    if (a.totalProgress !== 100 && b.totalProgress === 100) return -1;
                    // Diğerlerini isme göre sırala
                    return a.name.localeCompare(b.name);
                });
                renderApp();
            }, (error) => console.error("Jobs listener error:", error));

            // 2. Notları Dinle (Notes)
            onSnapshot(query(notesColRef), (snapshot) => {
                const allNotes = {};
                snapshot.docs.forEach(doc => {
                    const note = doc.data();
                    if (!allNotes[note.jobKey]) {
                        allNotes[note.jobKey] = [];
                    }
                    allNotes[note.jobKey].push(note);
                });

                // Notları tarihe göre sırala
                for (const jobKey in allNotes) {
                    allNotes[jobKey].sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                }
                notes = allNotes;
                renderApp();
            }, (error) => console.error("Notes listener error:", error));
        };

        // --- JOB/NOTE MANIPULATION METHODS ---

        const handleLogout = async () => {
            if (auth) {
                await signOut(auth);
            }
        };
        
        const handleRoleChange = (event) => {
            currentRole = event.target.value;
            renderApp();
        };

        const handleAddJob = async (e) => {
            e.preventDefault();
            if (currentRole !== "Patron" || !db || !user) {
                showNotification("Sadece Patron yeni iş ekleyebilir.");
                return;
            }

            const form = e.target;
            const name = form.jobName.value;
            const stagesInput = form.jobStages.value.split(',').map(s => s.trim()).filter(s => s);
            const masters = form.assignedMasters.value.split(',').map(m => m.trim()).filter(m => m);

            const stages = stagesInput.map(item => {
                const parts = item.split(':');
                const stageName = parts[0];
                const weight = parseInt(parts[1]) || 1;
                return { name: stageName, progress: 0, weight: weight };
            });

            const newJob = {
                name: name,
                stages: stages,
                masters: masters,
                createdBy: user.uid,
                createdByName: user.displayName || "Bilinmiyor",
                createdAt: Timestamp.fromDate(new Date())
            };

            try {
                const jobsColRef = collection(db, `artifacts/${APP_ID}/public/data/jobs`);
                await addDoc(jobsColRef, newJob);
                showNotification("Yeni İş Başarıyla Eklendi!");
                form.reset();
                form.jobStages.value = "Kesim:2,Bantlama:1,Montaj:5,Cila:2"; // Default değerleri geri yükle
                form.assignedMasters.value = "Mehmet, Ali";
            } catch (error) {
                console.error("Firestore'a iş eklerken hata:", error);
                showNotification(`Hata: İş eklenemedi.`);
            }
        };

        const handleUpdateStageProgress = async (jobId, stageIndex, newProgress) => {
            if (!db || !user) return;

            const jobToUpdate = jobs.find(j => j.id === jobId);
            if (!jobToUpdate) return;

            const progressValue = Math.max(0, Math.min(100, parseInt(newProgress) || 0));

            const newStages = [...jobToUpdate.stages];
            newStages[stageIndex].progress = progressValue;

            try {
                const jobDocRef = doc(db, `artifacts/${APP_ID}/public/data/jobs`, jobId);
                await updateDoc(jobDocRef, {
                    stages: newStages,
                    totalProgress: calculateWeightedProgress(newStages),
                    lastUpdatedBy: user.uid,
                    lastUpdatedAt: Timestamp.fromDate(new Date())
                });
            } catch (error) {
                console.error("İlerleme güncellenirken hata:", error);
                showNotification(`Hata: İlerleme güncellenemedi.`);
            }
        };

        const handleAddNote = async (jobId, noteContent) => {
            if (!noteContent.trim() || !db || !user) return;

            const newNote = {
                jobKey: jobId,
                content: noteContent,
                master: currentRole,
                masterUID: user.uid,
                timestamp: Timestamp.fromDate(new Date())
            };

            try {
                const notesColRef = collection(db, `artifacts/${APP_ID}/public/data/notes`);
                await addDoc(notesColRef, newNote);
                showNotification(`İş ${jobId.substring(0, 5)} için yeni not eklendi.`);
            } catch (error) {
                console.error("Not eklenirken hata:", error);
                showNotification(`Hata: Not eklenemedi.`);
            }
        };


        // --- RENDERING FUNCTIONS (Vanilla JS) ---

        const renderNotificationModal = () => {
            let modalElement = document.getElementById('notification-modal');
            if (!modalElement) {
                modalElement = document.createElement('div');
                modalElement.id = 'notification-modal';
                document.body.appendChild(modalElement);
            }

            modalElement.className = `fixed inset-0 z-50 flex items-start justify-center p-6 transition-opacity duration-300 ${showModal ? 'opacity-100' : 'opacity-0 pointer-events-none'}`;
            modalElement.innerHTML = `
                <div class="bg-indigo-600 text-white p-4 rounded-lg shadow-xl font-semibold text-center pointer-events-auto">
                    <span>${modalMessage}</span>
                </div>
            `;
        };

        // Patron Paneli: İş Kartı HTML'i oluşturma
        const createPatronJobCard = (job) => {
            const jobNotes = notes[job.id] || [];
            const isComplete = job.totalProgress === 100;

            const stagesHtml = job.stages.map((stage, index) => `
                <li class="${stage.progress === 100 ? 'text-green-600' : 'text-gray-600'}">
                    ${stage.name} (Ağırlık: ${stage.weight || 1}): <strong>${stage.progress || 0}%</strong>
                </li>
            `).join('');

            const notesHtml = jobNotes.length > 0 ? jobNotes.map((note, index) => `
                <div class="p-2 text-xs rounded bg-gray-100 mt-1 border border-gray-200">
                    <span class="font-bold text-indigo-500">${note.master}</span>: <span>${note.content}</span>
                    <span class="text-gray-400 ml-2 float-right">${formatTimestamp(note.timestamp)}</span>
                </div>
            `).join('') : '<p class="text-gray-500 italic text-xs">Bu işe ait henüz bir not yok.</p>';

            return `
                <div class="job-card p-4 border-l-4 rounded-lg shadow-md ${isComplete ? 'border-green-400 bg-green-50' : 'border-gray-300 bg-white'}">
                    <h3 class="text-xl font-bold text-indigo-600">${job.name}</h3>
                    <p class="text-sm text-gray-500 mb-2">Atanan Ustalar: <strong class="font-medium">${job.masters.join(', ')}</strong></p>
                    
                    <!-- İlerleme Çubuğu -->
                    <div class="mt-3">
                        <p class="text-sm font-semibold">Genel İlerleme (Ağırlıklı): <span class="${isComplete ? 'text-green-700' : 'text-gray-700'}">${job.totalProgress}%</span></p>
                        <div class="progress-bar-container w-full h-3 bg-gray-200 rounded-full overflow-hidden mt-1">
                            <div class="progress-bar h-full text-xs text-white flex items-center justify-center transition-all duration-500 ${isComplete ? 'bg-green-500' : (job.totalProgress > 50 ? 'bg-yellow-500' : 'bg-red-500')}" 
                                style="width: ${job.totalProgress}%">
                                ${job.totalProgress > 10 ? `${job.totalProgress}%` : ''}
                            </div>
                        </div>
                    </div>

                    <details class="mt-4 text-sm text-gray-600">
                        <summary class="cursor-pointer font-medium hover:text-indigo-500">
                            Aşama Detayları ve Notlar (${jobNotes.length} Not)
                        </summary>
                        <ul class="list-disc list-inside ml-2 mt-2 space-y-1">
                            ${stagesHtml}
                        </ul>
                        <h4 class="font-semibold text-sm mt-3 border-t pt-2">İş Notları:</h4>
                        <div class="space-y-1 max-h-40 overflow-y-auto pr-2">
                            ${notesHtml}
                        </div>
                    </details>
                </div>
            `;
        };
        
        // Usta Paneli: İş Kartı HTML'i oluşturma ve Event Listener'ları bağlama
        const createMasterJobCard = (job) => {
            const jobNotes = notes[job.id] || [];
            
            const stagesHtml = job.stages.map((stage, index) => `
                <div class="flex items-center space-x-3">
                    <label class="flex-grow text-sm">
                        <span>${stage.name}</span> (Ağırlık: ${stage.weight || 1}):
                    </label>
                    <input type="number" 
                        data-job-id="${job.id}"
                        data-stage-index="${index}"
                        value="${stage.progress || 0}"
                        min="0" max="100" 
                        class="progress-input w-20 p-2 border border-gray-300 rounded-md text-right focus:ring-yellow-500 focus:border-yellow-500 text-sm"
                    />
                    <span class="font-semibold text-gray-600">%</span>
                </div>
            `).join('');

            const notesHtml = jobNotes.length > 0 ? jobNotes.map((note, index) => `
                <div class="p-2 text-xs rounded bg-gray-100 mt-1 border border-gray-200">
                    <span class="font-bold text-indigo-500">${note.master}</span>: <span>${note.content}</span>
                    <span class="text-gray-400 ml-2 float-right">${formatTimestamp(note.timestamp)}</span>
                </div>
            `).join('') : '<p class="text-gray-500 italic text-xs">Bu işe ait henüz bir not yok.</p>';

            return `
                <div class="job-card p-4 border-l-4 border-yellow-400 bg-white rounded-lg shadow-md" id="master-card-${job.id}">
                    <h3 class="text-xl font-bold text-yellow-700">${job.name}</h3>
                    <p class="text-sm text-gray-500 mb-4">Genel İlerleme (Ağırlıklı): <strong>${job.totalProgress}%</strong></p>
                    
                    <!-- İlerleme Güncelleme Formu -->
                    <div class="space-y-3 mb-6 border-b pb-4">
                        <h4 class="font-semibold text-gray-700 border-b pb-1">Aşama İlerlemeni Gir:</h4>
                        ${stagesHtml}
                        <p class="text-xs text-red-500 pt-2">Not: Yüzdeyi değiştirdiğiniz an otomatik olarak Firebase'e kaydedilir (input'tan çıktığınızda).</p>
                    </div>
                    
                    <!-- Not Ekleme Formu -->
                    <form class="note-form" data-job-id="${job.id}">
                        <h4 class="font-semibold text-gray-700 mb-2">Ustalar Arası Not Bırak:</h4>
                        <textarea 
                            name="noteContent"
                            placeholder="Malzeme siparişi verildi, kesim bitti vb." required 
                            class="w-full p-2 border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-sm note-textarea"
                        ></textarea>
                        <button type="submit" class="w-full mt-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg transition duration-200 shadow-md">
                            Notu Gönder (${currentRole})
                        </button>
                        <div class="mt-4 border-t pt-3">
                            <h5 class="font-semibold text-gray-600 text-sm mb-1">Geçmiş Notlar:</h5>
                            <div class="space-y-1 max-h-40 overflow-y-auto pr-2">
                                ${notesHtml}
                            </div>
                        </div>
                    </form>
                </div>
            `;
        };

        // Ana Uygulamayı Çizme
        const renderApp = () => {
            const app = document.getElementById('app');
            renderNotificationModal(); // Bildirim penceresini her zaman hazır tut
            
            if (loading) {
                app.innerHTML = `
                    <div class="fixed inset-0 flex items-center justify-center bg-gray-100">
                        <div class="text-center text-gray-500">Yükleniyor...</div>
                    </div>
                `;
                return;
            }

            // --- HEADER OLUŞTURMA ---
            const headerHTML = `
                <header class="text-center py-6 bg-white shadow-lg rounded-xl">
                    <div class="flex justify-between items-center px-6">
                        <div class="text-left">
                            <h1 class="text-3xl font-extrabold text-indigo-700">Marangozhane Yönetimi</h1>
                            <p class="text-sm text-gray-500 mt-1">Hoş geldin, <span class="font-semibold text-gray-700">${user.displayName || 'Anonim Kullanıcı'}</span></p>
                            <p class="text-xs text-gray-400">UID: <span>${user.uid}</span></p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="p-2 bg-gray-100 rounded-lg shadow-inner">
                                <label for="userSelect" class="font-semibold text-gray-600 text-sm">Rol:</label>
                                <select id="userSelect" class="p-1 border border-gray-300 rounded-md bg-white shadow-sm text-sm">
                                    <option value="Patron" ${currentRole === 'Patron' ? 'selected' : ''}>Patron</option>
                                    <option value="Mehmet" ${currentRole === 'Mehmet' ? 'selected' : ''}>Mehmet (Usta)</option>
                                    <option value="Ali" ${currentRole === 'Ali' ? 'selected' : ''}>Ali (Usta)</option>
                                </select>
                            </div>
                            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition duration-200">
                                Çıkış Yap
                            </button>
                        </div>
                    </div>
                </header>
            `;
            
            // --- PATRON PANELİ OLUŞTURMA ---
            let mainContentHTML = '';
            if (currentRole === 'Patron') {
                const jobAddFormHTML = `
                    <form id="jobAddForm" class="bg-white p-4 rounded-lg shadow-inner mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">Yeni İş Ekle</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" name="jobName" placeholder="Proje Adı (Örn: Mutfak Dolabı-A1)" required 
                                class="md:col-span-4 p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" />
                            
                            <input type="text" name="jobStages" value="Kesim:2,Bantlama:1,Montaj:5,Cila:2" 
                                placeholder="Aşama:Ağırlık (Virgülle Ayırın)" required 
                                class="md:col-span-2 p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" />
                            <input type="text" name="assignedMasters" value="Mehmet, Ali" 
                                placeholder="Atanacak Ustalar (Virgülle Ayırın)" required 
                                class="md:col-span-2 p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" />
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Aşama ağırlıkları 1 ile 10 arasında olmalıdır.</p>
                        <button type="submit" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                            İşi Ekle
                        </button>
                    </form>
                `;

                const jobListHTML = jobs.length === 0 ? 
                    `<div class="text-gray-500 p-4 border border-dashed rounded-lg">Henüz hiç iş eklenmemiş.</div>` : 
                    `<div id="patronJobList" class="space-y-4">
                        ${jobs.map(createPatronJobCard).join('')}
                    </div>`;

                mainContentHTML = `
                    <div id="patronPanel" class="p-6 bg-blue-50 border-t-4 border-blue-500 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-700 mb-4 border-b pb-2">Patron Paneli</h2>
                        ${jobAddFormHTML}
                        <h3 class="text-xl font-semibold text-blue-700 mt-6 mb-3">Tüm Projeler ve Genel İlerleme</h3>
                        ${jobListHTML}
                    </div>
                `;
            } 
            // --- USTA PANELİ OLUŞTURMA ---
            else {
                const filteredMasterJobs = jobs.filter(job => job.masters.includes(currentRole));
                
                const jobListHTML = filteredMasterJobs.length === 0 ? 
                    `<div class="text-gray-500 p-4 border border-dashed rounded-lg">Şu anda size atanmış aktif bir iş bulunmamaktadır.</div>` : 
                    `<div id="masterJobList" class="space-y-4">
                        ${filteredMasterJobs.map(createMasterJobCard).join('')}
                    </div>`;

                mainContentHTML = `
                    <div id="ustaPanel" class="p-6 bg-yellow-50 border-t-4 border-yellow-500 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-yellow-700 mb-4 border-b pb-2">Usta Paneli (${currentRole})</h2>
                        <p class="text-gray-600 mb-4">Sadece size atanan işlerin aşama yüzdelerini ve notlarını güncelleyebilirsiniz.</p>
                        <div class="space-y-4">
                            ${jobListHTML}
                        </div>
                    </div>
                `;
            }

            // Ana konteyneri güncelle
            app.innerHTML = `
                <div class="container max-w-5xl mx-auto p-4 md:py-8 space-y-8">
                    ${headerHTML}
                    ${mainContentHTML}
                </div>
            `;
            
            // --- EVENT LISTENERS BAĞLAMA ---
            
            // 1. Rol Değiştirme ve Çıkış
            document.getElementById('userSelect')?.addEventListener('change', handleRoleChange);
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);

            // 2. Patron Form Gönderimi
            document.getElementById('jobAddForm')?.addEventListener('submit', handleAddJob);

            // 3. Usta Kartı Event Delegation (İlerleme ve Not)
            const ustaPanel = document.getElementById('ustaPanel');
            if (ustaPanel) {
                // İlerleme Güncelleme (Input Blur)
                ustaPanel.querySelectorAll('.progress-input').forEach(input => {
                    input.addEventListener('blur', (e) => {
                        const jobId = e.target.dataset.jobId;
                        const stageIndex = parseInt(e.target.dataset.stageIndex);
                        const newProgress = e.target.value;
                        handleUpdateStageProgress(jobId, stageIndex, newProgress);
                    });
                });

                // Not Gönderimi (Form Submit)
                ustaPanel.querySelectorAll('.note-form').forEach(form => {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const jobId = e.target.dataset.jobId;
                        const noteContent = e.target.querySelector('.note-textarea').value;
                        handleAddNote(jobId, noteContent).then(() => {
                            e.target.querySelector('.note-textarea').value = ''; // Başarılıysa temizle
                        });
                    });
                });
            }
        };

        // DOM yüklendiğinde Firebase'i başlat
        window.onload = initializeFirebase;
    </script>
</body>
</html>
