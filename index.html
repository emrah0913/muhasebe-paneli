<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marangozhane Yönetim Paneli</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100" x-data="panel" x-init="init()">

  <div class="max-w-4xl mx-auto mt-10 bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">
      Marangozhane Yönetim Paneli
    </h1>

    <!-- Giriş -->
    <template x-if="!user">
      <div class="text-center">
        <button @click="loginWithGoogle"
          class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
          Google ile Giriş Yap
        </button>
      </div>
    </template>

    <!-- Admin Paneli -->
    <template x-if="user && role === 'admin'">
      <div>
        <h2 class="text-2xl font-semibold text-green-700 mb-4">Admin Paneli</h2>

        <!-- İş Ekle -->
        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
          <h3 class="text-lg font-medium mb-2">Yeni İş Ekle</h3>
          <input type="text" x-model="newJob.title" placeholder="Proje Adı"
            class="border p-2 w-full mb-2 rounded">
          <input type="date" x-model="newJob.startDate" placeholder="Başlama Tarihi"
            class="border p-2 w-full mb-2 rounded">
          <input type="date" x-model="newJob.deliveryDate" placeholder="Teslim Tarihi"
            class="border p-2 w-full mb-2 rounded">
          <input type="text" x-model="newJob.assignedTo" placeholder="Atanacak Usta (Email)"
            class="border p-2 w-full mb-2 rounded">
          <textarea x-model="newJob.description" placeholder="İş Detayı"
            class="border p-2 w-full mb-2 rounded"></textarea>
          <button @click="addJob"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            İşi Kaydet
          </button>
        </div>

        <!-- İş Listesi -->
        <h3 class="text-lg font-medium mb-2">Tüm İşler</h3>
        <template x-for="job in jobs" :key="job.id">
          <div class="p-3 mb-2 bg-gray-100 rounded border">
            <div class="font-semibold text-gray-800" x-text="job.title"></div>
            <div class="text-sm text-gray-500">
              Başlama: <span x-text="job.startDate"></span> | Teslim: <span x-text="job.deliveryDate"></span>
            </div>
            <div class="text-sm">Atanan: <span x-text="job.assignedTo"></span></div>
            <div class="text-sm">Durum: <span x-text="job.status"></span></div>
            <div class="mt-1 text-sm text-gray-600 italic" x-text="job.description"></div>
          </div>
        </template>
      </div>
    </template>

    <!-- Usta Paneli -->
    <template x-if="user && role === 'usta'">
      <div>
        <h2 class="text-2xl font-semibold text-yellow-700 mb-4">Usta Paneli</h2>
        <template x-for="job in jobs" :key="job.id">
          <div class="p-3 mb-2 bg-yellow-50 rounded border">
            <div class="font-semibold text-gray-800" x-text="job.title"></div>
            <div class="text-sm text-gray-500">
              Başlama: <span x-text="job.startDate"></span> | Teslim: <span x-text="job.deliveryDate"></span>
            </div>
            <div class="text-sm text-gray-600 italic mb-2" x-text="job.description"></div>
            <label class="block text-sm font-medium mb-1">Tamamlanma Yüzdesi:</label>
            <input type="number" min="0" max="100" x-model="job.progress"
              class="border rounded p-1 w-20 mr-2">
            <button @click="updateProgress(job)"
              class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
              Güncelle
            </button>
          </div>
        </template>
      </div>
    </template>

  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
      authDomain: "kibrissiparissistemi.firebaseapp.com",
      projectId: "kibrissiparissistemi",
      storageBucket: "kibrissiparissistemi.firebasestorage.app",
      messagingSenderId: "263531733235",
      appId: "1:263531733235:web:82efdf39ed758a22465786"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    document.addEventListener("alpine:init", () => {
      Alpine.data("panel", () => ({
        user: null,
        role: null,
        jobs: [],
        newJob: { title: "", startDate: "", deliveryDate: "", assignedTo: "", description: "" },

        async init() {
          onAuthStateChanged(auth, async (u) => {
            if (u) {
              this.user = u;
              // Kullanıcı kaydı kontrol
              const userRef = doc(db, "users", u.uid);
              await setDoc(userRef, {
                email: u.email,
                role: this.role || "usta"
              }, { merge: true });

              const snap = await getDocs(query(collection(db, "users"), where("email", "==", u.email)));
              snap.forEach((docu) => this.role = docu.data().role || "usta");

              this.loadJobs();
            }
          });
        },

        async loginWithGoogle() {
          await signInWithPopup(auth, provider);
        },

        async loadJobs() {
          this.jobs = [];
          let q;
          if (this.role === "admin") {
            q = query(collection(db, "jobs"));
          } else {
            q = query(collection(db, "jobs"), where("assignedTo", "==", this.user.email));
          }
          const querySnapshot = await getDocs(q);
          querySnapshot.forEach((docu) => {
            this.jobs.push({ id: docu.id, ...docu.data() });
          });
        },

        async addJob() {
          if (!this.newJob.title || !this.newJob.assignedTo) return alert("Boş alan bırakmayın!");
          await addDoc(collection(db, "jobs"), {
            ...this.newJob,
            assignedBy: this.user.email,
            status: "Bekliyor",
            progress: 0,
            dateCreated: new Date().toISOString()
          });
          alert("İş başarıyla eklendi!");
          this.newJob = { title: "", startDate: "", deliveryDate: "", assignedTo: "", description: "" };
          this.loadJobs();
        },

        async updateProgress(job) {
          const docRef = doc(db, "jobs", job.id);
          await updateDoc(docRef, { progress: Number(job.progress), status: job.progress >= 100 ? "Tamamlandı" : "Devam ediyor" });
          alert("Güncellendi!");
        }
      }));
    });
  </script>
</body>
</html>
